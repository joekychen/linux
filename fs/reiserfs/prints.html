<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › reiserfs › prints.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>prints.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2000 by Hans Reiser, licensing governed by reiserfs/README</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &quot;reiserfs.h&quot;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/buffer_head.h&gt;</span>

<span class="cp">#include &lt;stdarg.h&gt;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">error_buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">fmt_buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">off_buf</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">reiserfs_cpu_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpu_key</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_key_k_type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">TYPE_DIRENTRY</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">off_buf</span><span class="p">,</span> <span class="s">&quot;%Lu(%Lu)&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
			<span class="n">GET_HASH_VALUE</span><span class="p">(</span><span class="n">cpu_key_k_offset</span><span class="p">(</span><span class="n">key</span><span class="p">)),</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
			<span class="n">GET_GENERATION_NUMBER</span><span class="p">(</span><span class="n">cpu_key_k_offset</span><span class="p">(</span><span class="n">key</span><span class="p">)));</span>
	<span class="k">else</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">off_buf</span><span class="p">,</span> <span class="s">&quot;0x%Lx&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">cpu_key_k_offset</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">off_buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">le_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">reiserfs_key</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">version</span><span class="p">;</span>

	<span class="n">version</span> <span class="o">=</span> <span class="n">le_key_version</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le_key_k_type</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">TYPE_DIRENTRY</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">off_buf</span><span class="p">,</span> <span class="s">&quot;%Lu(%Lu)&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
			<span class="n">GET_HASH_VALUE</span><span class="p">(</span><span class="n">le_key_k_offset</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">key</span><span class="p">)),</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
			<span class="n">GET_GENERATION_NUMBER</span><span class="p">(</span><span class="n">le_key_k_offset</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">key</span><span class="p">)));</span>
	<span class="k">else</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">off_buf</span><span class="p">,</span> <span class="s">&quot;0x%Lx&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">le_key_k_offset</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">key</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">off_buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">cpu_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpu_key</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_key_k_type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">TYPE_STAT_DATA</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;SD&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_key_k_type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">TYPE_DIRENTRY</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;DIR&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_key_k_type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">TYPE_DIRECT</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;DIRECT&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_key_k_type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">TYPE_INDIRECT</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;IND&quot;</span><span class="p">;</span>
	<span class="k">return</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">le_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">reiserfs_key</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">version</span><span class="p">;</span>

	<span class="n">version</span> <span class="o">=</span> <span class="n">le_key_version</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le_key_k_type</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">TYPE_STAT_DATA</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;SD&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le_key_k_type</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">TYPE_DIRENTRY</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;DIR&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le_key_k_type</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">TYPE_DIRECT</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;DIRECT&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le_key_k_type</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">TYPE_INDIRECT</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;IND&quot;</span><span class="p">;</span>
	<span class="k">return</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* %k */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sprintf_le_key</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">reiserfs_key</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;[%d %d %s %s]&quot;</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">k_dir_id</span><span class="p">),</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">k_objectid</span><span class="p">),</span> <span class="n">le_offset</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
			<span class="n">le_type</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;[NULL]&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* %K */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sprintf_cpu_key</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cpu_key</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;[%d %d %s %s]&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">on_disk_key</span><span class="p">.</span><span class="n">k_dir_id</span><span class="p">,</span>
			<span class="n">key</span><span class="o">-&gt;</span><span class="n">on_disk_key</span><span class="p">.</span><span class="n">k_objectid</span><span class="p">,</span> <span class="n">reiserfs_cpu_offset</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
			<span class="n">cpu_type</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;[NULL]&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sprintf_de_head</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">reiserfs_de_head</span> <span class="o">*</span><span class="n">deh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">deh</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span>
			<span class="s">&quot;[offset=%d dir_id=%d objectid=%d location=%d state=%04x]&quot;</span><span class="p">,</span>
			<span class="n">deh_offset</span><span class="p">(</span><span class="n">deh</span><span class="p">),</span> <span class="n">deh_dir_id</span><span class="p">(</span><span class="n">deh</span><span class="p">),</span> <span class="n">deh_objectid</span><span class="p">(</span><span class="n">deh</span><span class="p">),</span>
			<span class="n">deh_location</span><span class="p">(</span><span class="n">deh</span><span class="p">),</span> <span class="n">deh_state</span><span class="p">(</span><span class="n">deh</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;[NULL]&quot;</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sprintf_item_head</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">item_head</span> <span class="o">*</span><span class="n">ih</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ih</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">ih_version</span><span class="p">(</span><span class="n">ih</span><span class="p">)</span> <span class="o">==</span> <span class="n">KEY_FORMAT_3_6</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;*3.6* &quot;</span> <span class="o">:</span> <span class="s">&quot;*3.5*&quot;</span><span class="p">);</span>
		<span class="n">sprintf_le_key</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ih</span><span class="o">-&gt;</span><span class="n">ih_key</span><span class="p">));</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&quot;, item_len %d, item_location %d, &quot;</span>
			<span class="s">&quot;free_space(entry_count) %d&quot;</span><span class="p">,</span>
			<span class="n">ih_item_len</span><span class="p">(</span><span class="n">ih</span><span class="p">),</span> <span class="n">ih_location</span><span class="p">(</span><span class="n">ih</span><span class="p">),</span> <span class="n">ih_free_space</span><span class="p">(</span><span class="n">ih</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;[NULL]&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sprintf_direntry</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">reiserfs_dir_entry</span> <span class="o">*</span><span class="n">de</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">de</span><span class="o">-&gt;</span><span class="n">de_name</span><span class="p">,</span> <span class="n">de</span><span class="o">-&gt;</span><span class="n">de_namelen</span> <span class="o">&gt;</span> <span class="mi">19</span> <span class="o">?</span> <span class="mi">19</span> <span class="o">:</span> <span class="n">de</span><span class="o">-&gt;</span><span class="n">de_namelen</span><span class="p">);</span>
	<span class="n">name</span><span class="p">[</span><span class="n">de</span><span class="o">-&gt;</span><span class="n">de_namelen</span> <span class="o">&gt;</span> <span class="mi">19</span> <span class="o">?</span> <span class="mi">19</span> <span class="o">:</span> <span class="n">de</span><span class="o">-&gt;</span><span class="n">de_namelen</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">==&gt;[%d %d]&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">de</span><span class="o">-&gt;</span><span class="n">de_dir_id</span><span class="p">,</span> <span class="n">de</span><span class="o">-&gt;</span><span class="n">de_objectid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sprintf_block_head</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;level=%d, nr_items=%d, free_space=%d rdkey &quot;</span><span class="p">,</span>
		<span class="n">B_LEVEL</span><span class="p">(</span><span class="n">bh</span><span class="p">),</span> <span class="n">B_NR_ITEMS</span><span class="p">(</span><span class="n">bh</span><span class="p">),</span> <span class="n">B_FREE_SPACE</span><span class="p">(</span><span class="n">bh</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sprintf_buffer_head</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span>
		<span class="s">&quot;dev %s, size %zd, blocknr %llu, count %d, state 0x%lx, page %p, (%s, %s, %s)&quot;</span><span class="p">,</span>
		<span class="n">bdevname</span><span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_count</span><span class="p">)),</span>
		<span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_state</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_page</span><span class="p">,</span>
		<span class="n">buffer_uptodate</span><span class="p">(</span><span class="n">bh</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;UPTODATE&quot;</span> <span class="o">:</span> <span class="s">&quot;!UPTODATE&quot;</span><span class="p">,</span>
		<span class="n">buffer_dirty</span><span class="p">(</span><span class="n">bh</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;DIRTY&quot;</span> <span class="o">:</span> <span class="s">&quot;CLEAN&quot;</span><span class="p">,</span>
		<span class="n">buffer_locked</span><span class="p">(</span><span class="n">bh</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;LOCKED&quot;</span> <span class="o">:</span> <span class="s">&quot;UNLOCKED&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sprintf_disk_child</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">disk_child</span> <span class="o">*</span><span class="n">dc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;[dc_number=%d, dc_size=%u]&quot;</span><span class="p">,</span> <span class="n">dc_block_number</span><span class="p">(</span><span class="n">dc</span><span class="p">),</span>
		<span class="n">dc_size</span><span class="p">(</span><span class="n">dc</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">is_there_reiserfs_struct</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">what</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">k</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">k</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="sc">&#39;%&#39;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;k&#39;</span> <span class="o">||</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;K&#39;</span> <span class="o">||</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;h&#39;</span> <span class="o">||</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;t&#39;</span> <span class="o">||</span>
		    <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;z&#39;</span> <span class="o">||</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;b&#39;</span> <span class="o">||</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;y&#39;</span> <span class="o">||</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;a&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">what</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">k</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">k</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* debugging reiserfs we used to print out a lot of different</span>
<span class="cm">   variables, like keys, item headers, buffer heads etc. Values of</span>
<span class="cm">   most fields matter. So it took a long time just to write</span>
<span class="cm">   appropriative printk. With this reiserfs_warning you can use format</span>
<span class="cm">   specification for complex structures like you used to do with</span>
<span class="cm">   printfs for integers, doubles and pointers. For instance, to print</span>
<span class="cm">   out key structure you have to write just:</span>
<span class="cm">   reiserfs_warning (&quot;bad key %k&quot;, key);</span>
<span class="cm">   instead of</span>
<span class="cm">   printk (&quot;bad key %lu %lu %lu %lu&quot;, key-&gt;k_dir_id, key-&gt;k_objectid,</span>
<span class="cm">           key-&gt;k_offset, key-&gt;k_uniqueness);</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">error_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prepare_error_buf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">fmt1</span> <span class="o">=</span> <span class="n">fmt_buf</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">k</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">error_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">what</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error_lock</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">fmt1</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">k</span> <span class="o">=</span> <span class="n">is_there_reiserfs_struct</span><span class="p">(</span><span class="n">fmt1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">what</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">p</span> <span class="o">+=</span> <span class="n">vsprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">fmt1</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">what</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;k&#39;</span>:
			<span class="n">sprintf_le_key</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="k">struct</span> <span class="n">reiserfs_key</span> <span class="o">*</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;K&#39;</span>:
			<span class="n">sprintf_cpu_key</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cpu_key</span> <span class="o">*</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;h&#39;</span>:
			<span class="n">sprintf_item_head</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="k">struct</span> <span class="n">item_head</span> <span class="o">*</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;t&#39;</span>:
			<span class="n">sprintf_direntry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
					 <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">reiserfs_dir_entry</span> <span class="o">*</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;y&#39;</span>:
			<span class="n">sprintf_disk_child</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
					   <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="k">struct</span> <span class="n">disk_child</span> <span class="o">*</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;z&#39;</span>:
			<span class="n">sprintf_block_head</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
					   <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;b&#39;</span>:
			<span class="n">sprintf_buffer_head</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
					    <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;a&#39;</span>:
			<span class="n">sprintf_de_head</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
					<span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">reiserfs_de_head</span> <span class="o">*</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">p</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">fmt1</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vsprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">fmt1</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error_lock</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* in addition to usual conversion specifiers this accepts reiserfs</span>
<span class="cm">   specific conversion specifiers:</span>
<span class="cm">   %k to print little endian key,</span>
<span class="cm">   %K to print cpu key,</span>
<span class="cm">   %h to print item_head,</span>
<span class="cm">   %t to print directory entry</span>
<span class="cm">   %z to print block head (arg must be struct buffer_head *</span>
<span class="cm">   %b to print buffer_head</span>
<span class="cm">*/</span>

<span class="cp">#define do_reiserfs_warning(fmt)\</span>
<span class="cp">{\</span>
<span class="cp">    va_list args;\</span>
<span class="cp">    va_start( args, fmt );\</span>
<span class="cp">    prepare_error_buf( fmt, args );\</span>
<span class="cp">    va_end( args );\</span>
<span class="cp">}</span>

<span class="kt">void</span> <span class="nf">__reiserfs_warning</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
			 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="n">do_reiserfs_warning</span><span class="p">(</span><span class="n">fmt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;REISERFS warning (device %s): %s%s%s: &quot;</span>
		       <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">id</span> <span class="o">?</span> <span class="n">id</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">id</span> <span class="o">?</span> <span class="s">&quot; &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		       <span class="n">function</span><span class="p">,</span> <span class="n">error_buf</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;REISERFS warning: %s%s%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">id</span> <span class="o">?</span> <span class="n">id</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">id</span> <span class="o">?</span> <span class="s">&quot; &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">error_buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* No newline.. reiserfs_info calls can be followed by printk&#39;s */</span>
<span class="kt">void</span> <span class="nf">reiserfs_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="n">do_reiserfs_warning</span><span class="p">(</span><span class="n">fmt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;REISERFS (device %s): %s&quot;</span><span class="p">,</span>
		       <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">error_buf</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;REISERFS %s:&quot;</span><span class="p">,</span> <span class="n">error_buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* No newline.. reiserfs_printk calls can be followed by printk&#39;s */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">reiserfs_printk</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="n">do_reiserfs_warning</span><span class="p">(</span><span class="n">fmt</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">error_buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">reiserfs_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_REISERFS_CHECK</span>
	<span class="n">do_reiserfs_warning</span><span class="p">(</span><span class="n">fmt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;REISERFS debug (device %s): %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">error_buf</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;REISERFS debug: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error_buf</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* The format:</span>

<span class="cm">           maintainer-errorid: [function-name:] message</span>

<span class="cm">    where errorid is unique to the maintainer and function-name is</span>
<span class="cm">    optional, is recommended, so that anyone can easily find the bug</span>
<span class="cm">    with a simple grep for the short to type string</span>
<span class="cm">    maintainer-errorid.  Don&#39;t bother with reusing errorids, there are</span>
<span class="cm">    lots of numbers out there.</span>

<span class="cm">    Example:</span>

<span class="cm">    reiserfs_panic(</span>
<span class="cm">	p_sb, &quot;reiser-29: reiserfs_new_blocknrs: &quot;</span>
<span class="cm">	&quot;one of search_start or rn(%d) is equal to MAX_B_NUM,&quot;</span>
<span class="cm">	&quot;which means that we are optimizing location based on the bogus location of a temp buffer (%p).&quot;,</span>
<span class="cm">	rn, bh</span>
<span class="cm">    );</span>

<span class="cm">    Regular panic()s sometimes clear the screen before the message can</span>
<span class="cm">    be read, thus the need for the while loop.</span>

<span class="cm">    Numbering scheme for panic used by Vladimir and Anatoly( Hans completely ignores this scheme, and considers it</span>
<span class="cm">    pointless complexity):</span>

<span class="cm">    panics in reiserfs.h have numbers from 1000 to 1999</span>
<span class="cm">    super.c				        2000 to 2999</span>
<span class="cm">    preserve.c (unused)			    3000 to 3999</span>
<span class="cm">    bitmap.c				    4000 to 4999</span>
<span class="cm">    stree.c				        5000 to 5999</span>
<span class="cm">    prints.c				    6000 to 6999</span>
<span class="cm">    namei.c                     7000 to 7999</span>
<span class="cm">    fix_nodes.c                 8000 to 8999</span>
<span class="cm">    dir.c                       9000 to 9999</span>
<span class="cm">	lbalance.c					10000 to 10999</span>
<span class="cm">	ibalance.c		11000 to 11999 not ready</span>
<span class="cm">	do_balan.c		12000 to 12999</span>
<span class="cm">	inode.c			13000 to 13999</span>
<span class="cm">	file.c			14000 to 14999</span>
<span class="cm">    objectid.c                       15000 - 15999</span>
<span class="cm">    buffer.c                         16000 - 16999</span>
<span class="cm">    symlink.c                        17000 - 17999</span>

<span class="cm">   .  */</span>

<span class="kt">void</span> <span class="nf">__reiserfs_panic</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="n">do_reiserfs_warning</span><span class="p">(</span><span class="n">fmt</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_REISERFS_CHECK</span>
	<span class="n">dump_stack</span><span class="p">();</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;REISERFS panic (device %s): %s%s%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">id</span> <span class="o">?</span> <span class="n">id</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">id</span> <span class="o">?</span> <span class="s">&quot; &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		      <span class="n">function</span><span class="p">,</span> <span class="n">error_buf</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">panic</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;REISERFS panic: %s%s%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">id</span> <span class="o">?</span> <span class="n">id</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">id</span> <span class="o">?</span> <span class="s">&quot; &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">error_buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">__reiserfs_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="n">do_reiserfs_warning</span><span class="p">(</span><span class="n">fmt</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reiserfs_error_panic</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span>
		<span class="n">__reiserfs_panic</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">error_buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&amp;&amp;</span> <span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;REISERFS error (device %s): %s %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">error_buf</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;REISERFS error (device %s): %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">error_buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">reiserfs_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;Remounting filesystem read-only</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_RDONLY</span><span class="p">;</span>
	<span class="n">reiserfs_abort_journal</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">reiserfs_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">errno</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="n">do_reiserfs_warning</span><span class="p">(</span><span class="n">fmt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reiserfs_error_panic</span><span class="p">(</span><span class="n">sb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">panic</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;REISERFS panic (device %s): %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span>
		      <span class="n">error_buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reiserfs_is_journal_aborted</span><span class="p">(</span><span class="n">SB_JOURNAL</span><span class="p">(</span><span class="n">sb</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;REISERFS abort (device %s): %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_id</span><span class="p">,</span>
	       <span class="n">error_buf</span><span class="p">);</span>

	<span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_RDONLY</span><span class="p">;</span>
	<span class="n">reiserfs_abort_journal</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* this prints internal nodes (4 keys/items in line) (dc_number,</span>
<span class="cm">   dc_size)[k_dirid, k_objectid, k_offset, k_uniqueness](dc_number,</span>
<span class="cm">   dc_size)...*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">print_internal</span><span class="p">(</span><span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">,</span> <span class="kt">int</span> <span class="n">first</span><span class="p">,</span> <span class="kt">int</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">reiserfs_key</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">disk_child</span> <span class="o">*</span><span class="n">dc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">B_IS_KEYS_LEVEL</span><span class="p">(</span><span class="n">bh</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">check_internal</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">from</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">to</span> <span class="o">=</span> <span class="n">B_NR_ITEMS</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">from</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span>
		<span class="n">to</span> <span class="o">=</span> <span class="n">last</span> <span class="o">&lt;</span> <span class="n">B_NR_ITEMS</span><span class="p">(</span><span class="n">bh</span><span class="p">)</span> <span class="o">?</span> <span class="n">last</span> <span class="o">:</span> <span class="n">B_NR_ITEMS</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">reiserfs_printk</span><span class="p">(</span><span class="s">&quot;INTERNAL NODE (%ld) contains %z</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span><span class="p">,</span> <span class="n">bh</span><span class="p">);</span>

	<span class="n">dc</span> <span class="o">=</span> <span class="n">B_N_CHILD</span><span class="p">(</span><span class="n">bh</span><span class="p">,</span> <span class="n">from</span><span class="p">);</span>
	<span class="n">reiserfs_printk</span><span class="p">(</span><span class="s">&quot;PTR %d: %y &quot;</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">dc</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">from</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">B_N_PDELIM_KEY</span><span class="p">(</span><span class="n">bh</span><span class="p">,</span> <span class="n">from</span><span class="p">),</span> <span class="n">dc</span><span class="o">++</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">to</span><span class="p">;</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">key</span><span class="o">++</span><span class="p">,</span> <span class="n">dc</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reiserfs_printk</span><span class="p">(</span><span class="s">&quot;KEY %d: %k PTR %d: %y &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">print_leaf</span><span class="p">(</span><span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">,</span> <span class="kt">int</span> <span class="n">print_mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">first</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">block_head</span> <span class="o">*</span><span class="n">blkh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">item_head</span> <span class="o">*</span><span class="n">ih</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">B_IS_ITEMS_LEVEL</span><span class="p">(</span><span class="n">bh</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">check_leaf</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>

	<span class="n">blkh</span> <span class="o">=</span> <span class="n">B_BLK_HEAD</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="n">ih</span> <span class="o">=</span> <span class="n">B_N_PITEM_HEAD</span><span class="p">(</span><span class="n">bh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nr</span> <span class="o">=</span> <span class="n">blkh_nr_item</span><span class="p">(</span><span class="n">blkh</span><span class="p">);</span>

	<span class="n">printk</span>
	    <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">===================================================================</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">reiserfs_printk</span><span class="p">(</span><span class="s">&quot;LEAF NODE (%ld) contains %z</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span><span class="p">,</span> <span class="n">bh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">print_mode</span> <span class="o">&amp;</span> <span class="n">PRINT_LEAF_ITEMS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reiserfs_printk</span><span class="p">(</span><span class="s">&quot;FIRST ITEM_KEY: %k, LAST ITEM KEY: %k</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="p">(</span><span class="n">ih</span><span class="o">-&gt;</span><span class="n">ih_key</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">ih</span> <span class="o">+</span> <span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ih_key</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">first</span> <span class="o">&gt;</span> <span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">from</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">from</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">last</span> <span class="o">&gt;</span> <span class="n">nr</span><span class="p">)</span>
		<span class="n">to</span> <span class="o">=</span> <span class="n">nr</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">to</span> <span class="o">=</span> <span class="n">last</span><span class="p">;</span>

	<span class="n">ih</span> <span class="o">+=</span> <span class="n">from</span><span class="p">;</span>
	<span class="n">printk</span>
	    <span class="p">(</span><span class="s">&quot;-------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span>
	    <span class="p">(</span><span class="s">&quot;|##|   type    |           key           | ilen | free_space | version | loc  |</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">from</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">to</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ih</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;-------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">reiserfs_printk</span><span class="p">(</span><span class="s">&quot;|%2d| %h |</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ih</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">print_mode</span> <span class="o">&amp;</span> <span class="n">PRINT_LEAF_ITEMS</span><span class="p">)</span>
			<span class="n">op_print_item</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">B_I_PITEM</span><span class="p">(</span><span class="n">bh</span><span class="p">,</span> <span class="n">ih</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">printk</span>
	    <span class="p">(</span><span class="s">&quot;===================================================================</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">reiserfs_hashname</span><span class="p">(</span><span class="kt">int</span> <span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">YURA_HASH</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;rupasov&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">TEA_HASH</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;tea&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">R5_HASH</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;r5&quot;</span><span class="p">;</span>

	<span class="k">return</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* return 1 if this is not super block */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">print_super_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">reiserfs_super_block</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">reiserfs_super_block</span> <span class="o">*</span><span class="p">)(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">skipped</span><span class="p">,</span> <span class="n">data_blocks</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">version</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="n">BDEVNAME_SIZE</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_reiserfs_3_5</span><span class="p">(</span><span class="n">rs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">version</span> <span class="o">=</span> <span class="s">&quot;3.5&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_reiserfs_3_6</span><span class="p">(</span><span class="n">rs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">version</span> <span class="o">=</span> <span class="s">&quot;3.6&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_reiserfs_jr</span><span class="p">(</span><span class="n">rs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">version</span> <span class="o">=</span> <span class="p">((</span><span class="n">sb_version</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="n">REISERFS_VERSION_2</span><span class="p">)</span> <span class="o">?</span>
			   <span class="s">&quot;3.6&quot;</span> <span class="o">:</span> <span class="s">&quot;3.5&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\&#39;</span><span class="s">s super block is in block %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bdevname</span><span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_bdev</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Reiserfs version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Block count %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sb_block_count</span><span class="p">(</span><span class="n">rs</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Blocksize %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sb_blocksize</span><span class="p">(</span><span class="n">rs</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Free blocks %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sb_free_blocks</span><span class="p">(</span><span class="n">rs</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>FIXME: this would be confusing if
someone stores reiserfs super block in some data block ;)
   skipped = (bh->b<em>blocknr * bh->b</em>size) / sb_blocksize(rs);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">skipped</span> <span class="o">=</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span><span class="p">;</span>
	<span class="n">data_blocks</span> <span class="o">=</span> <span class="n">sb_block_count</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">-</span> <span class="n">skipped</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sb_bmap_nr</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">-</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">is_reiserfs_jr</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">?</span> <span class="n">sb_jp_journal_size</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">+</span>
	     <span class="mi">1</span> <span class="o">:</span> <span class="n">sb_reserved_for_journal</span><span class="p">(</span><span class="n">rs</span><span class="p">))</span> <span class="o">-</span> <span class="n">sb_free_blocks</span><span class="p">(</span><span class="n">rs</span><span class="p">);</span>
	<span class="n">printk</span>
	    <span class="p">(</span><span class="s">&quot;Busy blocks (skipped %d, bitmaps - %d, journal (or reserved) blocks - %d</span><span class="se">\n</span><span class="s">&quot;</span>
	     <span class="s">&quot;1 super block, %d data blocks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skipped</span><span class="p">,</span> <span class="n">sb_bmap_nr</span><span class="p">(</span><span class="n">rs</span><span class="p">),</span>
	     <span class="p">(</span><span class="o">!</span><span class="n">is_reiserfs_jr</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">sb_jp_journal_size</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span>
	      <span class="n">sb_reserved_for_journal</span><span class="p">(</span><span class="n">rs</span><span class="p">)),</span> <span class="n">data_blocks</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Root block %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sb_root_block</span><span class="p">(</span><span class="n">rs</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Journal block (first) %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sb_jp_journal_1st_block</span><span class="p">(</span><span class="n">rs</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Journal dev %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sb_jp_journal_dev</span><span class="p">(</span><span class="n">rs</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Journal orig size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sb_jp_journal_size</span><span class="p">(</span><span class="n">rs</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;FS state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sb_fs_state</span><span class="p">(</span><span class="n">rs</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Hash function </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">reiserfs_hashname</span><span class="p">(</span><span class="n">sb_hash_function_code</span><span class="p">(</span><span class="n">rs</span><span class="p">)));</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Tree height %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sb_tree_height</span><span class="p">(</span><span class="n">rs</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">print_desc_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">reiserfs_journal_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">get_journal_desc_magic</span><span class="p">(</span><span class="n">bh</span><span class="p">),</span> <span class="n">JOURNAL_DESC_MAGIC</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">reiserfs_journal_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Desc block %llu (j_trans_id %d, j_mount_id %d, j_len %d)&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span><span class="p">,</span> <span class="n">get_desc_trans_id</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span>
	       <span class="n">get_desc_mount_id</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span> <span class="n">get_desc_trans_len</span><span class="p">(</span><span class="n">desc</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">print_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">,</span> <span class="p">...)</span>	<span class="c1">//int print_mode, int first, int last)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;print_block: buffer is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">bh</span><span class="p">);</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
	<span class="n">first</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
	<span class="n">last</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">print_leaf</span><span class="p">(</span><span class="n">bh</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">print_internal</span><span class="p">(</span><span class="n">bh</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">))</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">print_super_block</span><span class="p">(</span><span class="n">bh</span><span class="p">))</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">print_desc_block</span><span class="p">(</span><span class="n">bh</span><span class="p">))</span>
					<span class="n">printk</span>
					    <span class="p">(</span><span class="s">&quot;Block %llu contains unformatted data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span><span class="p">);</span>

	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">print_tb_buf</span><span class="p">[</span><span class="mi">2048</span><span class="p">];</span>

<span class="cm">/* this stores initial state of tree balance in the print_tb_buf */</span>
<span class="kt">void</span> <span class="nf">store_print_tb</span><span class="p">(</span><span class="k">struct</span> <span class="n">tree_balance</span> <span class="o">*</span><span class="n">tb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">tbSh</span><span class="p">,</span> <span class="o">*</span><span class="n">tbFh</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">print_tb_buf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;BALANCING %d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;MODE=%c, ITEM_POS=%d POS_IN_ITEM=%d</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;=====================================================================</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;* h *    S    *    L    *    R    *   F   *   FL  *   FR  *  CFL  *  CFR  *</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">tb_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_do_balance</span><span class="p">,</span>
		<span class="n">tb</span><span class="o">-&gt;</span><span class="n">tb_mode</span><span class="p">,</span> <span class="n">PATH_LAST_POSITION</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">tb_path</span><span class="p">),</span>
		<span class="n">tb</span><span class="o">-&gt;</span><span class="n">tb_path</span><span class="o">-&gt;</span><span class="n">pos_in_item</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">insert_size</span><span class="p">);</span> <span class="n">h</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PATH_H_PATH_OFFSET</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">tb_path</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span> <span class="o">&lt;=</span>
		    <span class="n">tb</span><span class="o">-&gt;</span><span class="n">tb_path</span><span class="o">-&gt;</span><span class="n">path_length</span>
		    <span class="o">&amp;&amp;</span> <span class="n">PATH_H_PATH_OFFSET</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">tb_path</span><span class="p">,</span>
					  <span class="n">h</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ILLEGAL_PATH_ELEMENT_OFFSET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tbSh</span> <span class="o">=</span> <span class="n">PATH_H_PBUFFER</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">tb_path</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
			<span class="n">tbFh</span> <span class="o">=</span> <span class="n">PATH_H_PPARENT</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">tb_path</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tbSh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">tbFh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">print_tb_buf</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">print_tb_buf</span><span class="p">),</span>
			<span class="s">&quot;* %d * %3lld(%2d) * %3lld(%2d) * %3lld(%2d) * %5lld * %5lld * %5lld * %5lld * %5lld *</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">h</span><span class="p">,</span>
			<span class="p">(</span><span class="n">tbSh</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">tbSh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1LL</span><span class="p">),</span>
			<span class="p">(</span><span class="n">tbSh</span><span class="p">)</span> <span class="o">?</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tbSh</span><span class="o">-&gt;</span><span class="n">b_count</span><span class="p">))</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			<span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">L</span><span class="p">[</span><span class="n">h</span><span class="p">])</span> <span class="o">?</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">L</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">b_blocknr</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1LL</span><span class="p">),</span>
			<span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">L</span><span class="p">[</span><span class="n">h</span><span class="p">])</span> <span class="o">?</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">L</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">b_count</span><span class="p">))</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			<span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">R</span><span class="p">[</span><span class="n">h</span><span class="p">])</span> <span class="o">?</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">R</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">b_blocknr</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1LL</span><span class="p">),</span>
			<span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">R</span><span class="p">[</span><span class="n">h</span><span class="p">])</span> <span class="o">?</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">R</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">b_count</span><span class="p">))</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			<span class="p">(</span><span class="n">tbFh</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">tbFh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1LL</span><span class="p">),</span>
			<span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">FL</span><span class="p">[</span><span class="n">h</span><span class="p">])</span> <span class="o">?</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">FL</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">-&gt;</span>
						  <span class="n">b_blocknr</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1LL</span><span class="p">),</span>
			<span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">FR</span><span class="p">[</span><span class="n">h</span><span class="p">])</span> <span class="o">?</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">FR</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">-&gt;</span>
						  <span class="n">b_blocknr</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1LL</span><span class="p">),</span>
			<span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">CFL</span><span class="p">[</span><span class="n">h</span><span class="p">])</span> <span class="o">?</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">CFL</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">-&gt;</span>
						   <span class="n">b_blocknr</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1LL</span><span class="p">),</span>
			<span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">CFR</span><span class="p">[</span><span class="n">h</span><span class="p">])</span> <span class="o">?</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">CFR</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">-&gt;</span>
						   <span class="n">b_blocknr</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1LL</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">print_tb_buf</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">print_tb_buf</span><span class="p">),</span>
		<span class="s">&quot;=====================================================================</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;* h * size * ln * lb * rn * rb * blkn * s0 * s1 * s1b * s2 * s2b * curb * lk * rk *</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;* 0 * %4d * %2d * %2d * %2d * %2d * %4d * %2d * %2d * %3d * %2d * %3d * %4d * %2d * %2d *</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tb</span><span class="o">-&gt;</span><span class="n">insert_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">lnum</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">lbytes</span><span class="p">,</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">rnum</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		<span class="n">tb</span><span class="o">-&gt;</span><span class="n">rbytes</span><span class="p">,</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">blknum</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">s0num</span><span class="p">,</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">s1num</span><span class="p">,</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">s1bytes</span><span class="p">,</span>
		<span class="n">tb</span><span class="o">-&gt;</span><span class="n">s2num</span><span class="p">,</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">s2bytes</span><span class="p">,</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">cur_blknum</span><span class="p">,</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">lkey</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		<span class="n">tb</span><span class="o">-&gt;</span><span class="n">rkey</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* this prints balance parameters for non-leaf levels */</span>
	<span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">h</span><span class="o">++</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">print_tb_buf</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">print_tb_buf</span><span class="p">),</span>
			<span class="s">&quot;* %d * %4d * %2d *    * %2d *    * %2d *</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">h</span><span class="p">,</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">insert_size</span><span class="p">[</span><span class="n">h</span><span class="p">],</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">lnum</span><span class="p">[</span><span class="n">h</span><span class="p">],</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">rnum</span><span class="p">[</span><span class="n">h</span><span class="p">],</span>
			<span class="n">tb</span><span class="o">-&gt;</span><span class="n">blknum</span><span class="p">[</span><span class="n">h</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">insert_size</span><span class="p">[</span><span class="n">h</span><span class="p">]);</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">print_tb_buf</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">print_tb_buf</span><span class="p">),</span>
		<span class="s">&quot;=====================================================================</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;FEB list: &quot;</span><span class="p">);</span>

	<span class="cm">/* print FEB list (list of buffers in form (bh (b_blocknr, b_count), that will be used for new nodes) */</span>
	<span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">FEB</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">print_tb_buf</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">print_tb_buf</span><span class="p">),</span>
			<span class="s">&quot;%p (%llu %d)%s&quot;</span><span class="p">,</span> <span class="n">tb</span><span class="o">-&gt;</span><span class="n">FEB</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			<span class="n">tb</span><span class="o">-&gt;</span><span class="n">FEB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">FEB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span>
			<span class="n">b_blocknr</span> <span class="o">:</span> <span class="mi">0ULL</span><span class="p">,</span>
			<span class="n">tb</span><span class="o">-&gt;</span><span class="n">FEB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">FEB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">b_count</span><span class="p">))</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">FEB</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="s">&quot;, &quot;</span><span class="p">);</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">print_tb_buf</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">print_tb_buf</span><span class="p">),</span>
		<span class="s">&quot;======================== the end ====================================</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">print_cur_tb</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">mes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">%s&quot;</span><span class="p">,</span> <span class="n">mes</span><span class="p">,</span> <span class="n">print_tb_buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_leaf_block_head</span><span class="p">(</span><span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">block_head</span> <span class="o">*</span><span class="n">blkh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr</span><span class="p">;</span>

	<span class="n">blkh</span> <span class="o">=</span> <span class="n">B_BLK_HEAD</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="n">nr</span> <span class="o">=</span> <span class="n">blkh_nr_item</span><span class="p">(</span><span class="n">blkh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span> <span class="o">-</span> <span class="n">BLKH_SIZE</span><span class="p">)</span> <span class="o">/</span> <span class="n">IH_SIZE</span><span class="p">)</span>
		<span class="n">reiserfs_panic</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;vs-6010&quot;</span><span class="p">,</span> <span class="s">&quot;invalid item number %z&quot;</span><span class="p">,</span>
			       <span class="n">bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blkh_free_space</span><span class="p">(</span><span class="n">blkh</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span> <span class="o">-</span> <span class="n">BLKH_SIZE</span> <span class="o">-</span> <span class="n">IH_SIZE</span> <span class="o">*</span> <span class="n">nr</span><span class="p">)</span>
		<span class="n">reiserfs_panic</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;vs-6020&quot;</span><span class="p">,</span> <span class="s">&quot;invalid free space %z&quot;</span><span class="p">,</span>
			       <span class="n">bh</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_internal_block_head</span><span class="p">(</span><span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">block_head</span> <span class="o">*</span><span class="n">blkh</span><span class="p">;</span>

	<span class="n">blkh</span> <span class="o">=</span> <span class="n">B_BLK_HEAD</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">B_LEVEL</span><span class="p">(</span><span class="n">bh</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">DISK_LEAF_NODE_LEVEL</span> <span class="o">&amp;&amp;</span> <span class="n">B_LEVEL</span><span class="p">(</span><span class="n">bh</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">MAX_HEIGHT</span><span class="p">))</span>
		<span class="n">reiserfs_panic</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;vs-6025&quot;</span><span class="p">,</span> <span class="s">&quot;invalid level %z&quot;</span><span class="p">,</span> <span class="n">bh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">B_NR_ITEMS</span><span class="p">(</span><span class="n">bh</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span> <span class="o">-</span> <span class="n">BLKH_SIZE</span><span class="p">)</span> <span class="o">/</span> <span class="n">IH_SIZE</span><span class="p">)</span>
		<span class="n">reiserfs_panic</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;vs-6030&quot;</span><span class="p">,</span> <span class="s">&quot;invalid item number %z&quot;</span><span class="p">,</span> <span class="n">bh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">B_FREE_SPACE</span><span class="p">(</span><span class="n">bh</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_size</span> <span class="o">-</span> <span class="n">BLKH_SIZE</span> <span class="o">-</span> <span class="n">KEY_SIZE</span> <span class="o">*</span> <span class="n">B_NR_ITEMS</span><span class="p">(</span><span class="n">bh</span><span class="p">)</span> <span class="o">-</span>
	    <span class="n">DC_SIZE</span> <span class="o">*</span> <span class="p">(</span><span class="n">B_NR_ITEMS</span><span class="p">(</span><span class="n">bh</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">reiserfs_panic</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;vs-6040&quot;</span><span class="p">,</span> <span class="s">&quot;invalid free space %z&quot;</span><span class="p">,</span> <span class="n">bh</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">check_leaf</span><span class="p">(</span><span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">item_head</span> <span class="o">*</span><span class="n">ih</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">check_leaf_block_head</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ih</span> <span class="o">=</span> <span class="n">B_N_PITEM_HEAD</span><span class="p">(</span><span class="n">bh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">B_NR_ITEMS</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ih</span><span class="o">++</span><span class="p">)</span>
		<span class="n">op_check_item</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">B_I_PITEM</span><span class="p">(</span><span class="n">bh</span><span class="p">,</span> <span class="n">ih</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">check_internal</span><span class="p">(</span><span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">check_internal_block_head</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">print_statistics</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/*</span>
<span class="cm">	   printk (&quot;reiserfs_put_super: session statistics: balances %d, fix_nodes %d, \</span>
<span class="cm">	   bmap with search %d, without %d, dir2ind %d, ind2dir %d\n&quot;,</span>
<span class="cm">	   REISERFS_SB(s)-&gt;s_do_balance, REISERFS_SB(s)-&gt;s_fix_nodes,</span>
<span class="cm">	   REISERFS_SB(s)-&gt;s_bmaps, REISERFS_SB(s)-&gt;s_bmaps_without_search,</span>
<span class="cm">	   REISERFS_SB(s)-&gt;s_direct2indirect, REISERFS_SB(s)-&gt;s_indirect2direct);</span>
<span class="cm">	 */</span>

<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
