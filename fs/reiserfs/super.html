<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › reiserfs › super.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>super.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2000 by Hans Reiser, licensing governed by reiserfs/README</span>
<span class="cm"> *</span>
<span class="cm"> * Trivial changes by Alan Cox to add the LFS fixes</span>
<span class="cm"> *</span>
<span class="cm"> * Trivial Changes:</span>
<span class="cm"> * Rights granted to Hans Reiser to redistribute under other terms providing</span>
<span class="cm"> * he accepts all liability including but not limited to patent, fitness</span>
<span class="cm"> * for purpose, and direct or indirect claims arising from failure to perform.</span>
<span class="cm"> *</span>
<span class="cm"> * NO WARRANTY</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &quot;reiserfs.h&quot;</span>
<span class="cp">#include &quot;acl.h&quot;</span>
<span class="cp">#include &quot;xattr.h&quot;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/buffer_head.h&gt;</span>
<span class="cp">#include &lt;linux/exportfs.h&gt;</span>
<span class="cp">#include &lt;linux/quotaops.h&gt;</span>
<span class="cp">#include &lt;linux/vfs.h&gt;</span>
<span class="cp">#include &lt;linux/mount.h&gt;</span>
<span class="cp">#include &lt;linux/namei.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>

<span class="k">struct</span> <span class="n">file_system_type</span> <span class="n">reiserfs_fs_type</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">reiserfs_3_5_magic_string</span><span class="p">[]</span> <span class="o">=</span> <span class="n">REISERFS_SUPER_MAGIC_STRING</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">reiserfs_3_6_magic_string</span><span class="p">[]</span> <span class="o">=</span> <span class="n">REISER2FS_SUPER_MAGIC_STRING</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">reiserfs_jr_magic_string</span><span class="p">[]</span> <span class="o">=</span> <span class="n">REISER2FS_JR_SUPER_MAGIC_STRING</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">is_reiserfs_3_5</span><span class="p">(</span><span class="k">struct</span> <span class="n">reiserfs_super_block</span> <span class="o">*</span><span class="n">rs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">s_v1</span><span class="p">.</span><span class="n">s_magic</span><span class="p">,</span> <span class="n">reiserfs_3_5_magic_string</span><span class="p">,</span>
			<span class="n">strlen</span><span class="p">(</span><span class="n">reiserfs_3_5_magic_string</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">is_reiserfs_3_6</span><span class="p">(</span><span class="k">struct</span> <span class="n">reiserfs_super_block</span> <span class="o">*</span><span class="n">rs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">s_v1</span><span class="p">.</span><span class="n">s_magic</span><span class="p">,</span> <span class="n">reiserfs_3_6_magic_string</span><span class="p">,</span>
			<span class="n">strlen</span><span class="p">(</span><span class="n">reiserfs_3_6_magic_string</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">is_reiserfs_jr</span><span class="p">(</span><span class="k">struct</span> <span class="n">reiserfs_super_block</span> <span class="o">*</span><span class="n">rs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">s_v1</span><span class="p">.</span><span class="n">s_magic</span><span class="p">,</span> <span class="n">reiserfs_jr_magic_string</span><span class="p">,</span>
			<span class="n">strlen</span><span class="p">(</span><span class="n">reiserfs_jr_magic_string</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_any_reiserfs_magic_string</span><span class="p">(</span><span class="k">struct</span> <span class="n">reiserfs_super_block</span> <span class="o">*</span><span class="n">rs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">is_reiserfs_3_5</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">||</span> <span class="n">is_reiserfs_3_6</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">is_reiserfs_jr</span><span class="p">(</span><span class="n">rs</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">reiserfs_remount</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">reiserfs_statfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kstatfs</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">show_alloc_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reiserfs_sync_fs</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">reiserfs_transaction_handle</span> <span class="n">th</span><span class="p">;</span>

	<span class="n">reiserfs_write_lock</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">journal_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">journal_end_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">reiserfs_flush_old_commits</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="n">reiserfs_write_unlock</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">flush_old_commits</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">reiserfs_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="n">sbi</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">reiserfs_sb_info</span><span class="p">,</span> <span class="n">old_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_journal</span><span class="o">-&gt;</span><span class="n">j_work_sb</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">old_work_lock</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">work_queued</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">old_work_lock</span><span class="p">);</span>

	<span class="n">reiserfs_sync_fs</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">reiserfs_schedule_old_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">reiserfs_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delay</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">old_work_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">work_queued</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">delay</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">dirty_writeback_interval</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">system_long_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">old_work</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">work_queued</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">old_work_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cancel_old_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">reiserfs_sb_info</span> <span class="o">*</span><span class="n">sbi</span> <span class="o">=</span> <span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">old_work</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">old_work_lock</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">work_queued</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">old_work_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reiserfs_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">reiserfs_transaction_handle</span> <span class="n">th</span><span class="p">;</span>

	<span class="n">cancel_old_flush</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="n">reiserfs_write_lock</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">journal_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reiserfs_block_writes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">reiserfs_prepare_for_journal</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">SB_BUFFER_WITH_SB</span><span class="p">(</span><span class="n">s</span><span class="p">),</span>
						     <span class="mi">1</span><span class="p">);</span>
			<span class="n">journal_mark_dirty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">SB_BUFFER_WITH_SB</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
			<span class="n">reiserfs_block_writes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">);</span>
			<span class="n">journal_end_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">reiserfs_write_unlock</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reiserfs_unfreeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">reiserfs_allow_writes</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">in_core_key</span> <span class="n">MAX_IN_CORE_KEY</span><span class="p">;</span>

<span class="cm">/* this is used to delete &quot;save link&quot; when there are no items of a</span>
<span class="cm">   file it points to. It can either happen if unlink is completed but</span>
<span class="cm">   &quot;save unlink&quot; removal, or if file has both unlink and truncate</span>
<span class="cm">   pending and as unlink completes first (because key of &quot;save link&quot;</span>
<span class="cm">   protecting unlink is bigger that a key lf &quot;save link&quot; which</span>
<span class="cm">   protects truncate), so there left no items to make truncate</span>
<span class="cm">   completion on */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">remove_save_link_only</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">reiserfs_key</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oid_free</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">reiserfs_transaction_handle</span> <span class="n">th</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* we are going to do one balancing */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">journal_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">JOURNAL_PER_BALANCE_CNT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">reiserfs_delete_solid_item</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oid_free</span><span class="p">)</span>
		<span class="cm">/* removals are protected by direct items */</span>
		<span class="n">reiserfs_release_objectid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">k_objectid</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">journal_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">JOURNAL_PER_BALANCE_CNT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_QUOTA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">reiserfs_quota_on_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/* look for uncompleted unlinks and truncates and complete them */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">finish_unfinished</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INITIALIZE_PATH</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cpu_key</span> <span class="n">max_cpu_key</span><span class="p">,</span> <span class="n">obj_key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">reiserfs_key</span> <span class="n">save_link_key</span><span class="p">,</span> <span class="n">last_inode_key</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">item_head</span> <span class="o">*</span><span class="n">ih</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">item_pos</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">item</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">truncate</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ms_active_set</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">quota_enabled</span><span class="p">[</span><span class="n">MAXQUOTAS</span><span class="p">];</span>
<span class="cp">#endif</span>

	<span class="cm">/* compose key to look for &quot;save&quot; links */</span>
	<span class="n">max_cpu_key</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">KEY_FORMAT_3_5</span><span class="p">;</span>
	<span class="n">max_cpu_key</span><span class="p">.</span><span class="n">on_disk_key</span><span class="p">.</span><span class="n">k_dir_id</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0U</span><span class="p">;</span>
	<span class="n">max_cpu_key</span><span class="p">.</span><span class="n">on_disk_key</span><span class="p">.</span><span class="n">k_objectid</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0U</span><span class="p">;</span>
	<span class="n">set_cpu_key_k_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">max_cpu_key</span><span class="p">,</span> <span class="o">~</span><span class="mi">0U</span><span class="p">);</span>
	<span class="n">max_cpu_key</span><span class="p">.</span><span class="n">key_length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">last_inode_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">last_inode_key</span><span class="p">));</span>

<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="cm">/* Needed for iput() to work correctly and not trash data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ms_active_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ms_active_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_ACTIVE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Turn on quotas so that they are updated correctly */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">quota_enabled</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sb_has_quota_active</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">quota_enabled</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">reiserfs_quota_on_mount</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;reiserfs-2500&quot;</span><span class="p">,</span>
						 <span class="s">&quot;cannot turn on journaled &quot;</span>
						 <span class="s">&quot;quota: error %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_is_unlinked_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">search_item</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_cpu_key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">ITEM_NOT_FOUND</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reiserfs_error</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;vs-2140&quot;</span><span class="p">,</span>
				       <span class="s">&quot;search_by_key returned %d&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bh</span> <span class="o">=</span> <span class="n">get_last_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
		<span class="n">item_pos</span> <span class="o">=</span> <span class="n">get_item_pos</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">item_pos</span> <span class="o">!=</span> <span class="n">B_NR_ITEMS</span><span class="p">(</span><span class="n">bh</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;vs-2060&quot;</span><span class="p">,</span>
					 <span class="s">&quot;wrong position found&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">item_pos</span><span class="o">--</span><span class="p">;</span>
		<span class="n">ih</span> <span class="o">=</span> <span class="n">B_N_PITEM_HEAD</span><span class="p">(</span><span class="n">bh</span><span class="p">,</span> <span class="n">item_pos</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ih</span><span class="o">-&gt;</span><span class="n">ih_key</span><span class="p">.</span><span class="n">k_dir_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MAX_KEY_OBJECTID</span><span class="p">)</span>
			<span class="cm">/* there are no &quot;save&quot; links anymore */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">save_link_key</span> <span class="o">=</span> <span class="n">ih</span><span class="o">-&gt;</span><span class="n">ih_key</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_indirect_le_ih</span><span class="p">(</span><span class="n">ih</span><span class="p">))</span>
			<span class="n">truncate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">truncate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* reiserfs_iget needs k_dirid and k_objectid only */</span>
		<span class="n">item</span> <span class="o">=</span> <span class="n">B_I_PITEM</span><span class="p">(</span><span class="n">bh</span><span class="p">,</span> <span class="n">ih</span><span class="p">);</span>
		<span class="n">obj_key</span><span class="p">.</span><span class="n">on_disk_key</span><span class="p">.</span><span class="n">k_dir_id</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">item</span><span class="p">);</span>
		<span class="n">obj_key</span><span class="p">.</span><span class="n">on_disk_key</span><span class="p">.</span><span class="n">k_objectid</span> <span class="o">=</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ih</span><span class="o">-&gt;</span><span class="n">ih_key</span><span class="p">.</span><span class="n">k_objectid</span><span class="p">);</span>
		<span class="n">obj_key</span><span class="p">.</span><span class="n">on_disk_key</span><span class="p">.</span><span class="n">k_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">obj_key</span><span class="p">.</span><span class="n">on_disk_key</span><span class="p">.</span><span class="n">k_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">pathrelse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>

		<span class="n">inode</span> <span class="o">=</span> <span class="n">reiserfs_iget</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obj_key</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inode</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* the unlink almost completed, it just did not manage to remove</span>
<span class="cm">			   &quot;save&quot; link and release objectid */</span>
			<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;vs-2180&quot;</span><span class="p">,</span> <span class="s">&quot;iget failed for %K&quot;</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">obj_key</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">remove_save_link_only</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">save_link_key</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">truncate</span> <span class="o">&amp;&amp;</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_nlink</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* file is not unlinked */</span>
			<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;vs-2185&quot;</span><span class="p">,</span>
					 <span class="s">&quot;file %K is not unlinked&quot;</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">obj_key</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">remove_save_link_only</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">save_link_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dquot_initialize</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">truncate</span> <span class="o">&amp;&amp;</span> <span class="n">S_ISDIR</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* We got a truncate request for a dir which is impossible.</span>
<span class="cm">			   The only imaginable way is to execute unfinished truncate request</span>
<span class="cm">			   then boot into old kernel, remove the file and create dir with</span>
<span class="cm">			   the same key. */</span>
			<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;green-2101&quot;</span><span class="p">,</span>
					 <span class="s">&quot;impossible truncate on a &quot;</span>
					 <span class="s">&quot;directory %k. Please report&quot;</span><span class="p">,</span>
					 <span class="n">INODE_PKEY</span><span class="p">(</span><span class="n">inode</span><span class="p">));</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">remove_save_link_only</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">save_link_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">truncate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">iput</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">truncate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REISERFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">|=</span>
			    <span class="n">i_link_saved_truncate_mask</span><span class="p">;</span>
			<span class="cm">/* not completed truncate found. New size was committed together</span>
<span class="cm">			   with &quot;save&quot; link */</span>
			<span class="n">reiserfs_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;Truncating %k to %Ld ..&quot;</span><span class="p">,</span>
				      <span class="n">INODE_PKEY</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span><span class="p">);</span>
			<span class="n">reiserfs_truncate_file</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span>
					       <span class="mi">0</span>
					       <span class="cm">/*don&#39;t update modification time */</span>
					       <span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">remove_save_link</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">truncate</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">REISERFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">|=</span> <span class="n">i_link_saved_unlink_mask</span><span class="p">;</span>
			<span class="cm">/* not completed unlink (rmdir) found */</span>
			<span class="n">reiserfs_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;Removing %k..&quot;</span><span class="p">,</span> <span class="n">INODE_PKEY</span><span class="p">(</span><span class="n">inode</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">last_inode_key</span><span class="p">,</span> <span class="n">INODE_PKEY</span><span class="p">(</span><span class="n">inode</span><span class="p">),</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">last_inode_key</span><span class="p">))){</span>
				<span class="n">last_inode_key</span> <span class="o">=</span> <span class="o">*</span><span class="n">INODE_PKEY</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
				<span class="cm">/* removal gets completed in iput */</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;super-2189&quot;</span><span class="p">,</span> <span class="s">&quot;Dead loop &quot;</span>
						 <span class="s">&quot;in finish_unfinished &quot;</span>
						 <span class="s">&quot;detected, just remove &quot;</span>
						 <span class="s">&quot;save link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">remove_save_link_only</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">save_link_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">iput</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">done</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_is_unlinked_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="cm">/* Turn quotas off */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sb_dqopt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">quota_enabled</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">dquot_quota_off</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ms_active_set</span><span class="p">)</span>
		<span class="cm">/* Restore the flag back */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MS_ACTIVE</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">pathrelse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">done</span><span class="p">)</span>
		<span class="n">reiserfs_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;There were %d uncompleted unlinks/truncates. &quot;</span>
			      <span class="s">&quot;Completed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* to protect file being unlinked from getting lost we &quot;safe&quot; link files</span>
<span class="cm">   being unlinked. This link will be deleted in the same transaction with last</span>
<span class="cm">   item of file. mounting the filesystem we scan all these links and remove</span>
<span class="cm">   files which almost got lost */</span>
<span class="kt">void</span> <span class="nf">add_save_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">reiserfs_transaction_handle</span> <span class="o">*</span><span class="n">th</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">truncate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INITIALIZE_PATH</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpu_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">item_head</span> <span class="n">ih</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">link</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">t_trans_id</span><span class="p">);</span>

	<span class="cm">/* file can only get one &quot;save link&quot; of each kind */</span>
	<span class="n">RFALSE</span><span class="p">(</span><span class="n">truncate</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">REISERFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">&amp;</span> <span class="n">i_link_saved_truncate_mask</span><span class="p">),</span>
	       <span class="s">&quot;saved link already exists for truncated inode %lx&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
	<span class="n">RFALSE</span><span class="p">(</span><span class="o">!</span><span class="n">truncate</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">REISERFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">&amp;</span> <span class="n">i_link_saved_unlink_mask</span><span class="p">),</span>
	       <span class="s">&quot;saved link already exists for unlinked inode %lx&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>

	<span class="cm">/* setup key of &quot;save&quot; link */</span>
	<span class="n">key</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">KEY_FORMAT_3_5</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">on_disk_key</span><span class="p">.</span><span class="n">k_dir_id</span> <span class="o">=</span> <span class="n">MAX_KEY_OBJECTID</span><span class="p">;</span>
	<span class="n">key</span><span class="p">.</span><span class="n">on_disk_key</span><span class="p">.</span><span class="n">k_objectid</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">truncate</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* unlink, rmdir, rename */</span>
		<span class="n">set_cpu_key_k_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">);</span>
		<span class="n">set_cpu_key_k_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">TYPE_DIRECT</span><span class="p">);</span>

		<span class="cm">/* item head of &quot;safe&quot; link */</span>
		<span class="n">make_le_item_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ih</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">version</span><span class="p">,</span>
				  <span class="mi">1</span> <span class="o">+</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">,</span> <span class="n">TYPE_DIRECT</span><span class="p">,</span>
				  <span class="mi">4</span> <span class="cm">/*length */</span> <span class="p">,</span> <span class="mh">0xffff</span> <span class="cm">/*free space */</span> <span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* truncate */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span>
			<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="s">&quot;green-2102&quot;</span><span class="p">,</span>
					 <span class="s">&quot;Adding a truncate savelink for &quot;</span>
					 <span class="s">&quot;a directory %k! Please report&quot;</span><span class="p">,</span>
					 <span class="n">INODE_PKEY</span><span class="p">(</span><span class="n">inode</span><span class="p">));</span>
		<span class="n">set_cpu_key_k_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">set_cpu_key_k_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">TYPE_INDIRECT</span><span class="p">);</span>

		<span class="cm">/* item head of &quot;safe&quot; link */</span>
		<span class="n">make_le_item_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ih</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">version</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TYPE_INDIRECT</span><span class="p">,</span>
				  <span class="mi">4</span> <span class="cm">/*length */</span> <span class="p">,</span> <span class="mi">0</span> <span class="cm">/*free space */</span> <span class="p">);</span>
	<span class="p">}</span>
	<span class="n">key</span><span class="p">.</span><span class="n">key_length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* look for its place in the tree */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">search_item</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">ITEM_NOT_FOUND</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">)</span>
			<span class="n">reiserfs_error</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="s">&quot;vs-2100&quot;</span><span class="p">,</span>
				       <span class="s">&quot;search_by_key (%K) returned %d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span>
				       <span class="n">retval</span><span class="p">);</span>
		<span class="n">pathrelse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* body of &quot;save&quot; link */</span>
	<span class="n">link</span> <span class="o">=</span> <span class="n">INODE_PKEY</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">k_dir_id</span><span class="p">;</span>

	<span class="cm">/* put &quot;save&quot; link into tree, don&#39;t charge quota to anyone */</span>
	<span class="n">retval</span> <span class="o">=</span>
	    <span class="n">reiserfs_insert_item</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ih</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">link</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">)</span>
			<span class="n">reiserfs_error</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="s">&quot;vs-2120&quot;</span><span class="p">,</span>
				       <span class="s">&quot;insert_item returned %d&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">truncate</span><span class="p">)</span>
			<span class="n">REISERFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">|=</span>
			    <span class="n">i_link_saved_truncate_mask</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">REISERFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">|=</span> <span class="n">i_link_saved_unlink_mask</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* this opens transaction unlike add_save_link */</span>
<span class="kt">int</span> <span class="nf">remove_save_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">truncate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">reiserfs_transaction_handle</span> <span class="n">th</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">reiserfs_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* we are going to do one balancing only */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">journal_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="n">JOURNAL_PER_BALANCE_CNT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* setup key of &quot;save&quot; link */</span>
	<span class="n">key</span><span class="p">.</span><span class="n">k_dir_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MAX_KEY_OBJECTID</span><span class="p">);</span>
	<span class="n">key</span><span class="p">.</span><span class="n">k_objectid</span> <span class="o">=</span> <span class="n">INODE_PKEY</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">k_objectid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">truncate</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* unlink, rmdir, rename */</span>
		<span class="n">set_le_key_k_offset</span><span class="p">(</span><span class="n">KEY_FORMAT_3_5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span>
				    <span class="mi">1</span> <span class="o">+</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">);</span>
		<span class="n">set_le_key_k_type</span><span class="p">(</span><span class="n">KEY_FORMAT_3_5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">TYPE_DIRECT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* truncate */</span>
		<span class="n">set_le_key_k_offset</span><span class="p">(</span><span class="n">KEY_FORMAT_3_5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">set_le_key_k_type</span><span class="p">(</span><span class="n">KEY_FORMAT_3_5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">TYPE_INDIRECT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">truncate</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">REISERFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">&amp;</span> <span class="n">i_link_saved_truncate_mask</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">truncate</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">REISERFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">&amp;</span> <span class="n">i_link_saved_unlink_mask</span><span class="p">)))</span>
		<span class="cm">/* don&#39;t take quota bytes from anywhere */</span>
		<span class="n">reiserfs_delete_solid_item</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">truncate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reiserfs_release_objectid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
		<span class="n">REISERFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">i_link_saved_unlink_mask</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">REISERFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">i_link_saved_truncate_mask</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">journal_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="n">JOURNAL_PER_BALANCE_CNT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reiserfs_kill_sb</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Force any pending inode evictions to occur now. Any</span>
<span class="cm">		 * inodes to be removed that have extended attributes</span>
<span class="cm">		 * associated with them need to clean them up before</span>
<span class="cm">		 * we can release the extended attribute root dentries.</span>
<span class="cm">		 * shrink_dcache_for_umount will BUG if we don&#39;t release</span>
<span class="cm">		 * those before it&#39;s called so -&gt;put_super is too late.</span>
<span class="cm">		 */</span>
		<span class="n">shrink_dcache_sb</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

		<span class="n">dput</span><span class="p">(</span><span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">xattr_root</span><span class="p">);</span>
		<span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">xattr_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dput</span><span class="p">(</span><span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv_root</span><span class="p">);</span>
		<span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kill_block_super</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reiserfs_put_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">reiserfs_transaction_handle</span> <span class="n">th</span><span class="p">;</span>
	<span class="n">th</span><span class="p">.</span><span class="n">t_trans_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dquot_disable</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">DQUOT_USAGE_ENABLED</span> <span class="o">|</span> <span class="n">DQUOT_LIMITS_ENABLED</span><span class="p">);</span>

	<span class="n">reiserfs_write_lock</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="cm">/* change file system state to current state if it was mounted with read-write permissions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">journal_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">reiserfs_prepare_for_journal</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">SB_BUFFER_WITH_SB</span><span class="p">(</span><span class="n">s</span><span class="p">),</span>
						     <span class="mi">1</span><span class="p">);</span>
			<span class="n">set_sb_umount_state</span><span class="p">(</span><span class="n">SB_DISK_SUPER_BLOCK</span><span class="p">(</span><span class="n">s</span><span class="p">),</span>
					    <span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_state</span><span class="p">);</span>
			<span class="n">journal_mark_dirty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">SB_BUFFER_WITH_SB</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* note, journal_release checks for readonly mount, and can decide not</span>
<span class="cm">	 ** to do a journal_end</span>
<span class="cm">	 */</span>
	<span class="n">journal_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

	<span class="n">reiserfs_free_bitmap_cache</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="n">brelse</span><span class="p">(</span><span class="n">SB_BUFFER_WITH_SB</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>

	<span class="n">print_statistics</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">reserved_blocks</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;green-2005&quot;</span><span class="p">,</span> <span class="s">&quot;reserved blocks left %d&quot;</span><span class="p">,</span>
				 <span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">reserved_blocks</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">reiserfs_proc_info_done</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="n">reiserfs_write_unlock</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="n">mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_fs_info</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_fs_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">reiserfs_inode_cachep</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="nf">reiserfs_alloc_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">reiserfs_inode_info</span> <span class="o">*</span><span class="n">ei</span><span class="p">;</span>
	<span class="n">ei</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">reiserfs_inode_info</span> <span class="o">*</span><span class="p">)</span>
	    <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">reiserfs_inode_cachep</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ei</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">openers</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">tailpack</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reiserfs_i_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">rcu_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span><span class="p">,</span> <span class="n">i_rcu</span><span class="p">);</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">reiserfs_inode_cachep</span><span class="p">,</span> <span class="n">REISERFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reiserfs_destroy_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">call_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_rcu</span><span class="p">,</span> <span class="n">reiserfs_i_callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_once</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">foo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">reiserfs_inode_info</span> <span class="o">*</span><span class="n">ei</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">reiserfs_inode_info</span> <span class="o">*</span><span class="p">)</span><span class="n">foo</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">i_prealloc_list</span><span class="p">);</span>
	<span class="n">inode_init_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ei</span><span class="o">-&gt;</span><span class="n">vfs_inode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_inodecache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">reiserfs_inode_cachep</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;reiser_inode_cache&quot;</span><span class="p">,</span>
						  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span>
							 <span class="n">reiserfs_inode_info</span><span class="p">),</span>
						  <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">SLAB_RECLAIM_ACCOUNT</span><span class="o">|</span>
							<span class="n">SLAB_MEM_SPREAD</span><span class="p">),</span>
						  <span class="n">init_once</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reiserfs_inode_cachep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">destroy_inodecache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">reiserfs_inode_cachep</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* we don&#39;t mark inodes dirty, we just log them */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">reiserfs_dirty_inode</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">reiserfs_transaction_handle</span> <span class="n">th</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lock_depth</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="s">&quot;clm-6006&quot;</span><span class="p">,</span>
				 <span class="s">&quot;writing inode %lu on readonly FS&quot;</span><span class="p">,</span>
				 <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ino</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lock_depth</span> <span class="o">=</span> <span class="n">reiserfs_write_lock_once</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">);</span>

	<span class="cm">/* this is really only used for atime updates, so they don&#39;t have</span>
<span class="cm">	 ** to be included in O_SYNC or fsync</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">journal_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">reiserfs_update_sd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">inode</span><span class="p">);</span>
	<span class="n">journal_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">reiserfs_write_unlock_once</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_sb</span><span class="p">,</span> <span class="n">lock_depth</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reiserfs_show_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">reiserfs_journal</span> <span class="o">*</span><span class="n">journal</span> <span class="o">=</span> <span class="n">SB_JOURNAL</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">opts</span> <span class="o">=</span> <span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_LARGETAIL</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,tails=on&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">opts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_SMALLTAIL</span><span class="p">)))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,notail&quot;</span><span class="p">);</span>
	<span class="cm">/* tails=small is default so we don&#39;t show it */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">opts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_BARRIER_FLUSH</span><span class="p">)))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,barrier=none&quot;</span><span class="p">);</span>
	<span class="cm">/* barrier=flush is default so we don&#39;t show it */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_ERROR_CONTINUE</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,errors=continue&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_ERROR_PANIC</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,errors=panic&quot;</span><span class="p">);</span>
	<span class="cm">/* errors=ro is default so we don&#39;t show it */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_DATA_LOG</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,data=journal&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_DATA_WRITEBACK</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,data=writeback&quot;</span><span class="p">);</span>
	<span class="cm">/* data=ordered is default so we don&#39;t show it */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_ATTRS</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,attrs&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_XATTRS_USER</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,user_xattr&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_EXPOSE_PRIVROOT</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,expose_privroot&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_POSIXACL</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,acl&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_jdev</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,jdev=%s&quot;</span><span class="p">,</span> <span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_jdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_max_commit_age</span> <span class="o">!=</span> <span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_default_max_commit_age</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,commit=%d&quot;</span><span class="p">,</span> <span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_max_commit_age</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">USRQUOTA</span><span class="p">])</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,usrjquota=%s&quot;</span><span class="p">,</span> <span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">USRQUOTA</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_USRQUOTA</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,usrquota&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">GRPQUOTA</span><span class="p">])</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,grpjquota=%s&quot;</span><span class="p">,</span> <span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">GRPQUOTA</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_GRPQUOTA</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,grpquota&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_jquota_fmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_jquota_fmt</span> <span class="o">==</span> <span class="n">QFMT_VFS_OLD</span><span class="p">)</span>
			<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,jqfmt=vfsold&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_jquota_fmt</span> <span class="o">==</span> <span class="n">QFMT_VFS_V0</span><span class="p">)</span>
			<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,jqfmt=vfsv0&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* Block allocator options */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_NO_BORDER</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,block-allocator=noborder&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_NO_UNHASHED_RELOCATION</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,block-allocator=no_unhashed_relocation&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_HASHED_RELOCATION</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,block-allocator=hashed_relocation&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_TEST4</span><span class="p">))</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;,block-allocator=test4&quot;</span><span class="p">);</span>
	<span class="n">show_alloc_options</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_QUOTA</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">reiserfs_quota_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span>
				    <span class="kt">size_t</span><span class="p">,</span> <span class="n">loff_t</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">reiserfs_quota_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">,</span>
				   <span class="n">loff_t</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">super_operations</span> <span class="n">reiserfs_sops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">alloc_inode</span> <span class="o">=</span> <span class="n">reiserfs_alloc_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_inode</span> <span class="o">=</span> <span class="n">reiserfs_destroy_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_inode</span> <span class="o">=</span> <span class="n">reiserfs_write_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dirty_inode</span> <span class="o">=</span> <span class="n">reiserfs_dirty_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">evict_inode</span> <span class="o">=</span> <span class="n">reiserfs_evict_inode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put_super</span> <span class="o">=</span> <span class="n">reiserfs_put_super</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync_fs</span> <span class="o">=</span> <span class="n">reiserfs_sync_fs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">freeze_fs</span> <span class="o">=</span> <span class="n">reiserfs_freeze</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unfreeze_fs</span> <span class="o">=</span> <span class="n">reiserfs_unfreeze</span><span class="p">,</span>
	<span class="p">.</span><span class="n">statfs</span> <span class="o">=</span> <span class="n">reiserfs_statfs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remount_fs</span> <span class="o">=</span> <span class="n">reiserfs_remount</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_options</span> <span class="o">=</span> <span class="n">reiserfs_show_options</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="p">.</span><span class="n">quota_read</span> <span class="o">=</span> <span class="n">reiserfs_quota_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">quota_write</span> <span class="o">=</span> <span class="n">reiserfs_quota_write</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_QUOTA</span>
<span class="cp">#define QTYPE2NAME(t) ((t)==USRQUOTA?&quot;user&quot;:&quot;group&quot;)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">reiserfs_write_dquot</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">reiserfs_acquire_dquot</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">reiserfs_release_dquot</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">reiserfs_mark_dquot_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">reiserfs_write_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">reiserfs_quota_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">path</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dquot_operations</span> <span class="n">reiserfs_quota_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">write_dquot</span> <span class="o">=</span> <span class="n">reiserfs_write_dquot</span><span class="p">,</span>
	<span class="p">.</span><span class="n">acquire_dquot</span> <span class="o">=</span> <span class="n">reiserfs_acquire_dquot</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release_dquot</span> <span class="o">=</span> <span class="n">reiserfs_release_dquot</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mark_dirty</span> <span class="o">=</span> <span class="n">reiserfs_mark_dquot_dirty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_info</span> <span class="o">=</span> <span class="n">reiserfs_write_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc_dquot</span>	<span class="o">=</span> <span class="n">dquot_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_dquot</span>	<span class="o">=</span> <span class="n">dquot_destroy</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">quotactl_ops</span> <span class="n">reiserfs_qctl_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">quota_on</span> <span class="o">=</span> <span class="n">reiserfs_quota_on</span><span class="p">,</span>
	<span class="p">.</span><span class="n">quota_off</span> <span class="o">=</span> <span class="n">dquot_quota_off</span><span class="p">,</span>
	<span class="p">.</span><span class="n">quota_sync</span> <span class="o">=</span> <span class="n">dquot_quota_sync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_info</span> <span class="o">=</span> <span class="n">dquot_get_dqinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_info</span> <span class="o">=</span> <span class="n">dquot_set_dqinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_dqblk</span> <span class="o">=</span> <span class="n">dquot_get_dqblk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dqblk</span> <span class="o">=</span> <span class="n">dquot_set_dqblk</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">export_operations</span> <span class="n">reiserfs_export_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">encode_fh</span> <span class="o">=</span> <span class="n">reiserfs_encode_fh</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fh_to_dentry</span> <span class="o">=</span> <span class="n">reiserfs_fh_to_dentry</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fh_to_parent</span> <span class="o">=</span> <span class="n">reiserfs_fh_to_parent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_parent</span> <span class="o">=</span> <span class="n">reiserfs_get_parent</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* this struct is used in reiserfs_getopt () for containing the value for those</span>
<span class="cm">   mount options that have values rather than being toggles. */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">setmask</span><span class="p">;</span>		<span class="cm">/* bitmask which is to set on mount_options bitmask when this</span>
<span class="cm">				   value is found, 0 is no bits are to be changed. */</span>
	<span class="kt">int</span> <span class="n">clrmask</span><span class="p">;</span>		<span class="cm">/* bitmask which is to clear on mount_options bitmask when  this</span>
<span class="cm">				   value is found, 0 is no bits are to be changed. This is</span>
<span class="cm">				   applied BEFORE setmask */</span>
<span class="p">}</span> <span class="n">arg_desc_t</span><span class="p">;</span>

<span class="cm">/* Set this bit in arg_required to allow empty arguments */</span>
<span class="cp">#define REISERFS_OPT_ALLOWEMPTY 31</span>

<span class="cm">/* this struct is used in reiserfs_getopt() for describing the set of reiserfs</span>
<span class="cm">   mount options */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">option_name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">arg_required</span><span class="p">;</span>	<span class="cm">/* 0 if argument is not required, not 0 otherwise */</span>
	<span class="k">const</span> <span class="n">arg_desc_t</span> <span class="o">*</span><span class="n">values</span><span class="p">;</span>	<span class="cm">/* list of values accepted by an option */</span>
	<span class="kt">int</span> <span class="n">setmask</span><span class="p">;</span>		<span class="cm">/* bitmask which is to set on mount_options bitmask when this</span>
<span class="cm">				   value is found, 0 is no bits are to be changed. */</span>
	<span class="kt">int</span> <span class="n">clrmask</span><span class="p">;</span>		<span class="cm">/* bitmask which is to clear on mount_options bitmask when  this</span>
<span class="cm">				   value is found, 0 is no bits are to be changed. This is</span>
<span class="cm">				   applied BEFORE setmask */</span>
<span class="p">}</span> <span class="n">opt_desc_t</span><span class="p">;</span>

<span class="cm">/* possible values for -o data= */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">arg_desc_t</span> <span class="n">logging_mode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;ordered&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_DATA_ORDERED</span><span class="p">,</span>
	 <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_DATA_LOG</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_DATA_WRITEBACK</span><span class="p">)},</span>
	<span class="p">{</span><span class="s">&quot;journal&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_DATA_LOG</span><span class="p">,</span>
	 <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_DATA_ORDERED</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_DATA_WRITEBACK</span><span class="p">)},</span>
	<span class="p">{</span><span class="s">&quot;writeback&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_DATA_WRITEBACK</span><span class="p">,</span>
	 <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_DATA_ORDERED</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_DATA_LOG</span><span class="p">)},</span>
	<span class="p">{.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* possible values for -o barrier= */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">arg_desc_t</span> <span class="n">barrier_mode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;none&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_BARRIER_NONE</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_BARRIER_FLUSH</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;flush&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_BARRIER_FLUSH</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_BARRIER_NONE</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* possible values for &quot;-o block-allocator=&quot; and bits which are to be set in</span>
<span class="cm">   s_mount_opt of reiserfs specific part of in-core super block */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">arg_desc_t</span> <span class="n">balloc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;noborder&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_NO_BORDER</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;border&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_NO_BORDER</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;no_unhashed_relocation&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_NO_UNHASHED_RELOCATION</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;hashed_relocation&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_HASHED_RELOCATION</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;test4&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_TEST4</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;notest4&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_TEST4</span><span class="p">},</span>
	<span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">arg_desc_t</span> <span class="n">tails</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;on&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_LARGETAIL</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_SMALLTAIL</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;off&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_LARGETAIL</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_SMALLTAIL</span><span class="p">)},</span>
	<span class="p">{</span><span class="s">&quot;small&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_SMALLTAIL</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_LARGETAIL</span><span class="p">},</span>
	<span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">arg_desc_t</span> <span class="n">error_actions</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;panic&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_ERROR_PANIC</span><span class="p">,</span>
	 <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_ERROR_RO</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_ERROR_CONTINUE</span><span class="p">)},</span>
	<span class="p">{</span><span class="s">&quot;ro-remount&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_ERROR_RO</span><span class="p">,</span>
	 <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_ERROR_PANIC</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_ERROR_CONTINUE</span><span class="p">)},</span>
<span class="cp">#ifdef REISERFS_JOURNAL_ERROR_ALLOWS_NO_LOG</span>
	<span class="p">{</span><span class="s">&quot;continue&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_ERROR_CONTINUE</span><span class="p">,</span>
	 <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_ERROR_PANIC</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_ERROR_RO</span><span class="p">)},</span>
<span class="cp">#endif</span>
	<span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* proceed only one option from a list *cur - string containing of mount options</span>
<span class="cm">   opts - array of options which are accepted</span>
<span class="cm">   opt_arg - if option is found and requires an argument and if it is specifed</span>
<span class="cm">   in the input - pointer to the argument is stored here</span>
<span class="cm">   bit_flags - if option requires to set a certain bit - it is set here</span>
<span class="cm">   return -1 if unknown option is found, opt-&gt;arg_required otherwise */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">reiserfs_getopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">cur</span><span class="p">,</span> <span class="n">opt_desc_t</span> <span class="o">*</span> <span class="n">opts</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">**</span><span class="n">opt_arg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bit_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="cm">/* foo=bar,</span>
<span class="cm">	   ^   ^  ^</span>
<span class="cm">	   |   |  +-- option_end</span>
<span class="cm">	   |   +-- arg_start</span>
<span class="cm">	   +-- option_start</span>
<span class="cm">	 */</span>
	<span class="k">const</span> <span class="n">opt_desc_t</span> <span class="o">*</span><span class="n">opt</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">arg_desc_t</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>

	<span class="cm">/* assume argument cannot contain commas */</span>
	<span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">cur</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">cur</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;alloc=&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Ugly special case, probably we should redo options parser so that</span>
<span class="cm">		   it can understand several arguments for some options, also so that</span>
<span class="cm">		   it can fill several bitfields with option values. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reiserfs_parse_alloc_options</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* for every option in the list */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">opt</span> <span class="o">=</span> <span class="n">opts</span><span class="p">;</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">option_name</span><span class="p">;</span> <span class="n">opt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">option_name</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">option_name</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bit_flags</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">clrmask</span> <span class="o">==</span>
				    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_UNSUPPORTED_OPT</span><span class="p">))</span>
					<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;super-6500&quot;</span><span class="p">,</span>
							 <span class="s">&quot;%s not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							 <span class="n">p</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="o">*</span><span class="n">bit_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">clrmask</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">setmask</span> <span class="o">==</span>
				    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_UNSUPPORTED_OPT</span><span class="p">))</span>
					<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;super-6501&quot;</span><span class="p">,</span>
							 <span class="s">&quot;%s not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							 <span class="n">p</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="o">*</span><span class="n">bit_flags</span> <span class="o">|=</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">setmask</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">option_name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;super-6502&quot;</span><span class="p">,</span>
				 <span class="s">&quot;unknown mount option </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">option_name</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">arg_required</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;super-6503&quot;</span><span class="p">,</span>
					 <span class="s">&quot;the option </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> does not &quot;</span>
					 <span class="s">&quot;require an argument</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">opt</span><span class="o">-&gt;</span><span class="n">option_name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">arg_required</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;super-6504&quot;</span><span class="p">,</span>
					 <span class="s">&quot;the option </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> requires an &quot;</span>
					 <span class="s">&quot;argument</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">option_name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;super-6505&quot;</span><span class="p">,</span>
				 <span class="s">&quot;head of option </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> is only correct</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">opt</span><span class="o">-&gt;</span><span class="n">option_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* move to the argument, or to next option if argument is not required */</span>
	<span class="n">p</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">arg_required</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">arg_required</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_OPT_ALLOWEMPTY</span><span class="p">))</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* this catches &quot;option=,&quot; if not allowed */</span>
		<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;super-6506&quot;</span><span class="p">,</span>
				 <span class="s">&quot;empty argument for </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">opt</span><span class="o">-&gt;</span><span class="n">option_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* *=NULLopt_arg contains pointer to argument */</span>
		<span class="o">*</span><span class="n">opt_arg</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">arg_required</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_OPT_ALLOWEMPTY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* values possible for this option are listed in opt-&gt;values */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">arg</span> <span class="o">=</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">;</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span> <span class="n">arg</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bit_flags</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">bit_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">clrmask</span><span class="p">;</span>
				<span class="o">*</span><span class="n">bit_flags</span> <span class="o">|=</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">setmask</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">arg_required</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;super-6506&quot;</span><span class="p">,</span>
			 <span class="s">&quot;bad value </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> for option </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span>
			 <span class="n">opt</span><span class="o">-&gt;</span><span class="n">option_name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* returns 0 if something is wrong in option string, 1 - otherwise */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">reiserfs_parse_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">,</span>	<span class="cm">/* string given via mount&#39;s -o */</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">mount_options</span><span class="p">,</span>
				  <span class="cm">/* after the parsing phase, contains the</span>
<span class="cm">				     collection of bitflags defining what</span>
<span class="cm">				     mount options were selected. */</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">blocks</span><span class="p">,</span>	<span class="cm">/* strtol-ed from NNN of resize=NNN */</span>
				  <span class="kt">char</span> <span class="o">**</span><span class="n">jdev_name</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">commit_max_age</span><span class="p">,</span>
				  <span class="kt">char</span> <span class="o">**</span><span class="n">qf_names</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">qfmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">arg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="n">opt_desc_t</span> <span class="n">opts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* Compatibility stuff, so that -o notail for old setups still work */</span>
		<span class="p">{</span><span class="s">&quot;tails&quot;</span><span class="p">,.</span><span class="n">arg_required</span> <span class="o">=</span> <span class="sc">&#39;t&#39;</span><span class="p">,.</span><span class="n">values</span> <span class="o">=</span> <span class="n">tails</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;notail&quot;</span><span class="p">,.</span><span class="n">clrmask</span> <span class="o">=</span>
		 <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_LARGETAIL</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_SMALLTAIL</span><span class="p">)},</span>
		<span class="p">{</span><span class="s">&quot;conv&quot;</span><span class="p">,.</span><span class="n">setmask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_CONVERT</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;attrs&quot;</span><span class="p">,.</span><span class="n">setmask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_ATTRS</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;noattrs&quot;</span><span class="p">,.</span><span class="n">clrmask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_ATTRS</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;expose_privroot&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">setmask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_EXPOSE_PRIVROOT</span><span class="p">},</span>
<span class="cp">#ifdef CONFIG_REISERFS_FS_XATTR</span>
		<span class="p">{</span><span class="s">&quot;user_xattr&quot;</span><span class="p">,.</span><span class="n">setmask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_XATTRS_USER</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;nouser_xattr&quot;</span><span class="p">,.</span><span class="n">clrmask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_XATTRS_USER</span><span class="p">},</span>
<span class="cp">#else</span>
		<span class="p">{</span><span class="s">&quot;user_xattr&quot;</span><span class="p">,.</span><span class="n">setmask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_UNSUPPORTED_OPT</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;nouser_xattr&quot;</span><span class="p">,.</span><span class="n">clrmask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_UNSUPPORTED_OPT</span><span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_REISERFS_FS_POSIX_ACL</span>
		<span class="p">{</span><span class="s">&quot;acl&quot;</span><span class="p">,.</span><span class="n">setmask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_POSIXACL</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;noacl&quot;</span><span class="p">,.</span><span class="n">clrmask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_POSIXACL</span><span class="p">},</span>
<span class="cp">#else</span>
		<span class="p">{</span><span class="s">&quot;acl&quot;</span><span class="p">,.</span><span class="n">setmask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_UNSUPPORTED_OPT</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;noacl&quot;</span><span class="p">,.</span><span class="n">clrmask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_UNSUPPORTED_OPT</span><span class="p">},</span>
<span class="cp">#endif</span>
		<span class="p">{.</span><span class="n">option_name</span> <span class="o">=</span> <span class="s">&quot;nolog&quot;</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;replayonly&quot;</span><span class="p">,.</span><span class="n">setmask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REPLAYONLY</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;block-allocator&quot;</span><span class="p">,.</span><span class="n">arg_required</span> <span class="o">=</span> <span class="sc">&#39;a&#39;</span><span class="p">,.</span><span class="n">values</span> <span class="o">=</span> <span class="n">balloc</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;data&quot;</span><span class="p">,.</span><span class="n">arg_required</span> <span class="o">=</span> <span class="sc">&#39;d&#39;</span><span class="p">,.</span><span class="n">values</span> <span class="o">=</span> <span class="n">logging_mode</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;barrier&quot;</span><span class="p">,.</span><span class="n">arg_required</span> <span class="o">=</span> <span class="sc">&#39;b&#39;</span><span class="p">,.</span><span class="n">values</span> <span class="o">=</span> <span class="n">barrier_mode</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;resize&quot;</span><span class="p">,.</span><span class="n">arg_required</span> <span class="o">=</span> <span class="sc">&#39;r&#39;</span><span class="p">,.</span><span class="n">values</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;jdev&quot;</span><span class="p">,.</span><span class="n">arg_required</span> <span class="o">=</span> <span class="sc">&#39;j&#39;</span><span class="p">,.</span><span class="n">values</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;nolargeio&quot;</span><span class="p">,.</span><span class="n">arg_required</span> <span class="o">=</span> <span class="sc">&#39;w&#39;</span><span class="p">,.</span><span class="n">values</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;commit&quot;</span><span class="p">,.</span><span class="n">arg_required</span> <span class="o">=</span> <span class="sc">&#39;c&#39;</span><span class="p">,.</span><span class="n">values</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;usrquota&quot;</span><span class="p">,.</span><span class="n">setmask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_USRQUOTA</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;grpquota&quot;</span><span class="p">,.</span><span class="n">setmask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_GRPQUOTA</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;noquota&quot;</span><span class="p">,.</span><span class="n">clrmask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_USRQUOTA</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_GRPQUOTA</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;errors&quot;</span><span class="p">,.</span><span class="n">arg_required</span> <span class="o">=</span> <span class="sc">&#39;e&#39;</span><span class="p">,.</span><span class="n">values</span> <span class="o">=</span> <span class="n">error_actions</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;usrjquota&quot;</span><span class="p">,.</span><span class="n">arg_required</span> <span class="o">=</span>
		 <span class="sc">&#39;u&#39;</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_OPT_ALLOWEMPTY</span><span class="p">),.</span><span class="n">values</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;grpjquota&quot;</span><span class="p">,.</span><span class="n">arg_required</span> <span class="o">=</span>
		 <span class="sc">&#39;g&#39;</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_OPT_ALLOWEMPTY</span><span class="p">),.</span><span class="n">values</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;jqfmt&quot;</span><span class="p">,.</span><span class="n">arg_required</span> <span class="o">=</span> <span class="sc">&#39;f&#39;</span><span class="p">,.</span><span class="n">values</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">},</span>
		<span class="p">{.</span><span class="n">option_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="o">*</span><span class="n">blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="cm">/* use default configuration: create tails, journaling on, no</span>
<span class="cm">		   conversion to newest format */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pos</span> <span class="o">=</span> <span class="n">options</span><span class="p">;</span> <span class="n">pos</span><span class="p">;)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">reiserfs_getopt</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span> <span class="n">mount_options</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="cm">/* wrong option is given */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;r&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

			<span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="cm">/* &quot;resize=NNN&quot; or &quot;resize=auto&quot; */</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;auto&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* From JFS code, to auto-get the size. */</span>
				<span class="o">*</span><span class="n">blocks</span> <span class="o">=</span>
				    <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="o">-&gt;</span>
				    <span class="n">s_blocksize_bits</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* NNN does not look like a number */</span>
					<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;super-6507&quot;</span><span class="p">,</span>
							 <span class="s">&quot;bad value %s for &quot;</span>
							 <span class="s">&quot;-oresize</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;c&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="cm">/* commit=NNN (time in seconds) */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;super-6508&quot;</span><span class="p">,</span>
						 <span class="s">&quot;bad value %s for -ocommit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">arg</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">commit_max_age</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">val</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;w&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;super-6509&quot;</span><span class="p">,</span> <span class="s">&quot;nolargeio option &quot;</span>
					 <span class="s">&quot;is no longer supported&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;j&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">arg</span> <span class="o">&amp;&amp;</span> <span class="n">jdev_name</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">jdev_name</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">//Hm, already assigned?</span>
					<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;super-6510&quot;</span><span class="p">,</span>
							 <span class="s">&quot;journal device was &quot;</span>
							 <span class="s">&quot;already specified to &quot;</span>
							 <span class="s">&quot;be %s&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">jdev_name</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="o">*</span><span class="n">jdev_name</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;u&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;g&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">qtype</span> <span class="o">=</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;u&#39;</span> <span class="o">?</span> <span class="n">USRQUOTA</span> <span class="o">:</span> <span class="n">GRPQUOTA</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sb_any_quota_loaded</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="o">!*</span><span class="n">arg</span> <span class="o">!=</span> <span class="o">!</span><span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;super-6511&quot;</span><span class="p">,</span>
						 <span class="s">&quot;cannot change journaled &quot;</span>
						 <span class="s">&quot;quota options when quota &quot;</span>
						 <span class="s">&quot;turned on.&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Some filename specified? */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">]</span>
				    <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">],</span>
					      <span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;super-6512&quot;</span><span class="p">,</span>
							 <span class="s">&quot;%s quota file &quot;</span>
							 <span class="s">&quot;already specified.&quot;</span><span class="p">,</span>
							 <span class="n">QTYPE2NAME</span><span class="p">(</span><span class="n">qtype</span><span class="p">));</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">strchr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;super-6513&quot;</span><span class="p">,</span>
							 <span class="s">&quot;quotafile must be &quot;</span>
							 <span class="s">&quot;on filesystem root.&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">]</span> <span class="o">=</span>
				    <span class="n">kmalloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;reiserfs-2502&quot;</span><span class="p">,</span>
							 <span class="s">&quot;not enough memory &quot;</span>
							 <span class="s">&quot;for storing &quot;</span>
							 <span class="s">&quot;quotafile name.&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">],</span> <span class="n">arg</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">qtype</span> <span class="o">==</span> <span class="n">USRQUOTA</span><span class="p">)</span>
					<span class="o">*</span><span class="n">mount_options</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_USRQUOTA</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="o">*</span><span class="n">mount_options</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_GRPQUOTA</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">]</span> <span class="o">!=</span>
				    <span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">])</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">]);</span>
				<span class="n">qf_names</span><span class="p">[</span><span class="n">qtype</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">qtype</span> <span class="o">==</span> <span class="n">USRQUOTA</span><span class="p">)</span>
					<span class="o">*</span><span class="n">mount_options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_USRQUOTA</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="o">*</span><span class="n">mount_options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_GRPQUOTA</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;f&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;vfsold&quot;</span><span class="p">))</span>
				<span class="o">*</span><span class="n">qfmt</span> <span class="o">=</span> <span class="n">QFMT_VFS_OLD</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;vfsv0&quot;</span><span class="p">))</span>
				<span class="o">*</span><span class="n">qfmt</span> <span class="o">=</span> <span class="n">QFMT_VFS_V0</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;super-6514&quot;</span><span class="p">,</span>
						 <span class="s">&quot;unknown quota format &quot;</span>
						 <span class="s">&quot;specified.&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sb_any_quota_loaded</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">*</span><span class="n">qfmt</span> <span class="o">!=</span> <span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_jquota_fmt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;super-6515&quot;</span><span class="p">,</span>
						 <span class="s">&quot;cannot change journaled &quot;</span>
						 <span class="s">&quot;quota options when quota &quot;</span>
						 <span class="s">&quot;turned on.&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;u&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;g&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;f&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;reiserfs-2503&quot;</span><span class="p">,</span> <span class="s">&quot;journaled &quot;</span>
					 <span class="s">&quot;quota options not supported.&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_jquota_fmt</span> <span class="o">&amp;&amp;</span> <span class="o">!*</span><span class="n">qfmt</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">qf_names</span><span class="p">[</span><span class="n">USRQUOTA</span><span class="p">]</span> <span class="o">||</span> <span class="n">qf_names</span><span class="p">[</span><span class="n">GRPQUOTA</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;super-6515&quot;</span><span class="p">,</span>
				 <span class="s">&quot;journaled quota format not specified.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">mount_options</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_USRQUOTA</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	       <span class="n">sb_has_quota_loaded</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">USRQUOTA</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">mount_options</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_GRPQUOTA</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	       <span class="n">sb_has_quota_loaded</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">GRPQUOTA</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;super-6516&quot;</span><span class="p">,</span> <span class="s">&quot;quota options must &quot;</span>
				 <span class="s">&quot;be present when quota is turned on.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">switch_data_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_DATA_LOG</span><span class="p">)</span> <span class="o">|</span>
					 <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_DATA_ORDERED</span><span class="p">)</span> <span class="o">|</span>
					 <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_DATA_WRITEBACK</span><span class="p">));</span>
	<span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_data_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mount_options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mount_options</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_DATA_LOG</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reiserfs_data_log</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">switch_data_mode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">REISERFS_DATA_LOG</span><span class="p">);</span>
			<span class="n">reiserfs_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;switching to journaled data mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mount_options</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_DATA_ORDERED</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reiserfs_data_ordered</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">switch_data_mode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">REISERFS_DATA_ORDERED</span><span class="p">);</span>
			<span class="n">reiserfs_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;switching to ordered data mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mount_options</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_DATA_WRITEBACK</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reiserfs_data_writeback</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">switch_data_mode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">REISERFS_DATA_WRITEBACK</span><span class="p">);</span>
			<span class="n">reiserfs_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;switching to writeback data mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_barrier_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flush</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_BARRIER_FLUSH</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">none</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_BARRIER_NONE</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">all_barrier</span> <span class="o">=</span> <span class="n">flush</span> <span class="o">|</span> <span class="n">none</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">all_barrier</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">all_barrier</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">flush</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">|=</span> <span class="n">flush</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;reiserfs: enabling write barrier flush mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">none</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">|=</span> <span class="n">none</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;reiserfs: write barriers turned off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_attrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">reiserfs_super_block</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="n">SB_DISK_SUPER_BLOCK</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reiserfs_attrs</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_format_only</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;super-6517&quot;</span><span class="p">,</span> <span class="s">&quot;cannot support &quot;</span>
					 <span class="s">&quot;attributes on 3.5.x disk format&quot;</span><span class="p">);</span>
			<span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_ATTRS</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">reiserfs_attrs_cleared</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;super-6518&quot;</span><span class="p">,</span> <span class="s">&quot;cannot support &quot;</span>
					 <span class="s">&quot;attributes until flag is set in &quot;</span>
					 <span class="s">&quot;super-block&quot;</span><span class="p">);</span>
			<span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_ATTRS</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_QUOTA</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_quota_files</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">qf_names</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">qfmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">qfmt</span><span class="p">)</span>
		<span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_jquota_fmt</span> <span class="o">=</span> <span class="o">*</span><span class="n">qfmt</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reiserfs_remount</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">mount_flags</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">reiserfs_super_block</span> <span class="o">*</span><span class="n">rs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">reiserfs_transaction_handle</span> <span class="n">th</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">blocks</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mount_options</span> <span class="o">=</span> <span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">safe_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">commit_max_age</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">reiserfs_journal</span> <span class="o">*</span><span class="n">journal</span> <span class="o">=</span> <span class="n">SB_JOURNAL</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">new_opts</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">qf_names</span><span class="p">[</span><span class="n">MAXQUOTAS</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">qfmt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">reiserfs_write_lock</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">qf_names</span><span class="p">,</span> <span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">qf_names</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="n">rs</span> <span class="o">=</span> <span class="n">SB_DISK_SUPER_BLOCK</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reiserfs_parse_options</span>
	    <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mount_options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blocks</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">commit_max_age</span><span class="p">,</span>
	    <span class="n">qf_names</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qfmt</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">qf_names</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#endif</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="n">handle_quota_files</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">qf_names</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qfmt</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">handle_attrs</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="cm">/* Add options that are safe here */</span>
	<span class="n">safe_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_SMALLTAIL</span><span class="p">;</span>
	<span class="n">safe_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_LARGETAIL</span><span class="p">;</span>
	<span class="n">safe_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_NO_BORDER</span><span class="p">;</span>
	<span class="n">safe_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_NO_UNHASHED_RELOCATION</span><span class="p">;</span>
	<span class="n">safe_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_HASHED_RELOCATION</span><span class="p">;</span>
	<span class="n">safe_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_TEST4</span><span class="p">;</span>
	<span class="n">safe_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_ATTRS</span><span class="p">;</span>
	<span class="n">safe_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_XATTRS_USER</span><span class="p">;</span>
	<span class="n">safe_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_POSIXACL</span><span class="p">;</span>
	<span class="n">safe_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_BARRIER_FLUSH</span><span class="p">;</span>
	<span class="n">safe_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_BARRIER_NONE</span><span class="p">;</span>
	<span class="n">safe_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_ERROR_RO</span><span class="p">;</span>
	<span class="n">safe_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_ERROR_CONTINUE</span><span class="p">;</span>
	<span class="n">safe_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_ERROR_PANIC</span><span class="p">;</span>
	<span class="n">safe_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_USRQUOTA</span><span class="p">;</span>
	<span class="n">safe_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_GRPQUOTA</span><span class="p">;</span>

	<span class="cm">/* Update the bitmask, taking care to keep</span>
<span class="cm">	 * the bits we&#39;re not allowed to change here */</span>
	<span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span>
	     <span class="n">s_mount_opt</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">safe_mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mount_options</span> <span class="o">&amp;</span> <span class="n">safe_mask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">commit_max_age</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">commit_max_age</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_max_commit_age</span> <span class="o">=</span> <span class="n">commit_max_age</span><span class="p">;</span>
		<span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_max_trans_age</span> <span class="o">=</span> <span class="n">commit_max_age</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">commit_max_age</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 0 means restore defaults. */</span>
		<span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_max_commit_age</span> <span class="o">=</span> <span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_default_max_commit_age</span><span class="p">;</span>
		<span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_max_trans_age</span> <span class="o">=</span> <span class="n">JOURNAL_MAX_TRANS_AGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blocks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">reiserfs_resize</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">blocks</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">mount_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reiserfs_xattr_init</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">mount_flags</span><span class="p">);</span>
		<span class="cm">/* remount read-only */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span>
			<span class="cm">/* it is read-only already */</span>
			<span class="k">goto</span> <span class="n">out_ok</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">dquot_suspend</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

		<span class="cm">/* try to remount file system with read-only permissions */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sb_umount_state</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="n">REISERFS_VALID_FS</span>
		    <span class="o">||</span> <span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">!=</span> <span class="n">REISERFS_VALID_FS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">out_ok</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">journal_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

		<span class="cm">/* Mounting a rw partition read-only. */</span>
		<span class="n">reiserfs_prepare_for_journal</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">SB_BUFFER_WITH_SB</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">set_sb_umount_state</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_state</span><span class="p">);</span>
		<span class="n">journal_mark_dirty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">SB_BUFFER_WITH_SB</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* remount read-write */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">reiserfs_xattr_init</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">mount_flags</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_ok</span><span class="p">;</span>	<span class="cm">/* We are read-write already */</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reiserfs_is_journal_aborted</span><span class="p">(</span><span class="n">journal</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">journal</span><span class="o">-&gt;</span><span class="n">j_errno</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">handle_data_mode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">mount_options</span><span class="p">);</span>
		<span class="n">handle_barrier_mode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">mount_options</span><span class="p">);</span>
		<span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">=</span> <span class="n">sb_umount_state</span><span class="p">(</span><span class="n">rs</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MS_RDONLY</span><span class="p">;</span>	<span class="cm">/* now it is safe to call journal_begin */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">journal_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

		<span class="cm">/* Mount a partition which is read-only, read-write */</span>
		<span class="n">reiserfs_prepare_for_journal</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">SB_BUFFER_WITH_SB</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">=</span> <span class="n">sb_umount_state</span><span class="p">(</span><span class="n">rs</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MS_RDONLY</span><span class="p">;</span>
		<span class="n">set_sb_umount_state</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">REISERFS_ERROR_FS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old_format_only</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
			<span class="n">set_sb_mnt_count</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">sb_mnt_count</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* mark_buffer_dirty (SB_BUFFER_WITH_SB (s), 1); */</span>
		<span class="n">journal_mark_dirty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">SB_BUFFER_WITH_SB</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
		<span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">=</span> <span class="n">REISERFS_VALID_FS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* this will force a full flush of all journal lists */</span>
	<span class="n">SB_JOURNAL</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">j_must_wait</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">journal_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">mount_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dquot_resume</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">finish_unfinished</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="n">reiserfs_xattr_init</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">mount_flags</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out_ok:</span>
	<span class="n">replace_mount_options</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">new_opts</span><span class="p">);</span>
	<span class="n">reiserfs_write_unlock</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">new_opts</span><span class="p">);</span>
	<span class="n">reiserfs_write_unlock</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_super_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">reiserfs_super_block</span> <span class="o">*</span><span class="n">rs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fs_blocksize</span><span class="p">;</span>

	<span class="n">bh</span> <span class="o">=</span> <span class="n">sb_bread</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">offset</span> <span class="o">/</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;sh-2006&quot;</span><span class="p">,</span>
				 <span class="s">&quot;bread failed (dev %s, block %lu, size %lu)&quot;</span><span class="p">,</span>
				 <span class="n">reiserfs_bdevname</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">offset</span> <span class="o">/</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">,</span>
				 <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">reiserfs_super_block</span> <span class="o">*</span><span class="p">)</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_any_reiserfs_magic_string</span><span class="p">(</span><span class="n">rs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>ok, reiserfs signature (old or new) found in at the given offset</p></td><td class="code"><div class="highlight"><pre>	<span class="n">fs_blocksize</span> <span class="o">=</span> <span class="n">sb_blocksize</span><span class="p">(</span><span class="n">rs</span><span class="p">);</span>
	<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
	<span class="n">sb_set_blocksize</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fs_blocksize</span><span class="p">);</span>

	<span class="n">bh</span> <span class="o">=</span> <span class="n">sb_bread</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">offset</span> <span class="o">/</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;sh-2007&quot;</span><span class="p">,</span>
				 <span class="s">&quot;bread failed (dev %s, block %lu, size %lu)&quot;</span><span class="p">,</span>
				 <span class="n">reiserfs_bdevname</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">offset</span> <span class="o">/</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">,</span>
				 <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">reiserfs_super_block</span> <span class="o">*</span><span class="p">)</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb_blocksize</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">!=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;sh-2011&quot;</span><span class="p">,</span> <span class="s">&quot;can&#39;t find a reiserfs &quot;</span>
				 <span class="s">&quot;filesystem on (dev %s, block %Lu, size %lu)&quot;</span><span class="p">,</span>
				 <span class="n">reiserfs_bdevname</span><span class="p">(</span><span class="n">s</span><span class="p">),</span>
				 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_blocknr</span><span class="p">,</span>
				 <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">);</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">s_v1</span><span class="p">.</span><span class="n">s_root_block</span> <span class="o">==</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;super-6519&quot;</span><span class="p">,</span> <span class="s">&quot;Unfinished reiserfsck &quot;</span>
				 <span class="s">&quot;--rebuild-tree run detected. Please run</span><span class="se">\n</span><span class="s">&quot;</span>
				 <span class="s">&quot;reiserfsck --rebuild-tree and wait for a &quot;</span>
				 <span class="s">&quot;completion. If that fails</span><span class="se">\n</span><span class="s">&quot;</span>
				 <span class="s">&quot;get newer reiserfsprogs package&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SB_BUFFER_WITH_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">=</span> <span class="n">bh</span><span class="p">;</span>
	<span class="n">SB_DISK_SUPER_BLOCK</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">=</span> <span class="n">rs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_reiserfs_jr</span><span class="p">(</span><span class="n">rs</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* magic is of non-standard journal filesystem, look at s_version to</span>
<span class="cm">		   find which format is in use */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sb_version</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="n">REISERFS_VERSION_2</span><span class="p">)</span>
			<span class="n">reiserfs_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;found reiserfs format </span><span class="se">\&quot;</span><span class="s">3.6</span><span class="se">\&quot;</span><span class="s">&quot;</span>
				      <span class="s">&quot; with non-standard journal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sb_version</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">==</span> <span class="n">REISERFS_VERSION_1</span><span class="p">)</span>
			<span class="n">reiserfs_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;found reiserfs format </span><span class="se">\&quot;</span><span class="s">3.5</span><span class="se">\&quot;</span><span class="s">&quot;</span>
				      <span class="s">&quot; with non-standard journal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;sh-2012&quot;</span><span class="p">,</span> <span class="s">&quot;found unknown &quot;</span>
					 <span class="s">&quot;format </span><span class="se">\&quot;</span><span class="s">%u</span><span class="se">\&quot;</span><span class="s"> of reiserfs with &quot;</span>
					 <span class="s">&quot;non-standard magic&quot;</span><span class="p">,</span> <span class="n">sb_version</span><span class="p">(</span><span class="n">rs</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* s_version of standard format may contain incorrect information,</span>
<span class="cm">		   so we just look at the magic string */</span>
		<span class="n">reiserfs_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>
			      <span class="s">&quot;found reiserfs format </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> with standard journal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">is_reiserfs_3_5</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;3.5&quot;</span> <span class="o">:</span> <span class="s">&quot;3.6&quot;</span><span class="p">);</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">reiserfs_sops</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_export_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">reiserfs_export_ops</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_qcop</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">reiserfs_qctl_operations</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">dq_op</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">reiserfs_quota_operations</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* new format is limited by the 32 bit wide i_blocks field, want to</span>
<span class="cm">	 ** be one full block below that.</span>
<span class="cm">	 */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_maxbytes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">512LL</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* after journal replay, reread all bitmap and super blocks */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">reread_meta_blocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ll_rw_block</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">SB_BUFFER_WITH_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)));</span>
	<span class="n">wait_on_buffer</span><span class="p">(</span><span class="n">SB_BUFFER_WITH_SB</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer_uptodate</span><span class="p">(</span><span class="n">SB_BUFFER_WITH_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;reiserfs-2504&quot;</span><span class="p">,</span> <span class="s">&quot;error reading the super&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>///////////////////////////////////////////////////
hash detection stuff</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>if root directory is empty - we set default - Yura's - hash and
warn about it
FIXME: we look for only one name in a directory. If tea and yura
bith have the same value - we ask user to send report to the
mailing list</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="n">__u32</span> <span class="nf">find_hash_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpu_key</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">INITIALIZE_PATH</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">reiserfs_dir_entry</span> <span class="n">de</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">DEFAULT_HASH</span><span class="p">;</span>

	<span class="n">inode</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>			<span class="c1">// Some serious &quot;goto&quot;-hater was there ;)</span>
		<span class="n">u32</span> <span class="n">teahash</span><span class="p">,</span> <span class="n">r5hash</span><span class="p">,</span> <span class="n">yurahash</span><span class="p">;</span>

		<span class="n">make_cpu_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">inode</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">TYPE_DIRENTRY</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">search_by_entry_key</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">de</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">IO_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pathrelse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">UNSET_HASH</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">NAME_NOT_FOUND</span><span class="p">)</span>
			<span class="n">de</span><span class="p">.</span><span class="n">de_entry_num</span><span class="o">--</span><span class="p">;</span>
		<span class="n">set_de_name_and_namelen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">de</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">deh_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">de</span><span class="p">.</span><span class="n">de_deh</span><span class="p">[</span><span class="n">de</span><span class="p">.</span><span class="n">de_entry_num</span><span class="p">]))</span> <span class="o">==</span> <span class="n">DOT_DOT_OFFSET</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* allow override in this case */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reiserfs_rupasov_hash</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">hash</span> <span class="o">=</span> <span class="n">YURA_HASH</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">reiserfs_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;FS seems to be empty, autodetect &quot;</span>
					 <span class="s">&quot;is using the default hash</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r5hash</span> <span class="o">=</span> <span class="n">GET_HASH_VALUE</span><span class="p">(</span><span class="n">r5_hash</span><span class="p">(</span><span class="n">de</span><span class="p">.</span><span class="n">de_name</span><span class="p">,</span> <span class="n">de</span><span class="p">.</span><span class="n">de_namelen</span><span class="p">));</span>
		<span class="n">teahash</span> <span class="o">=</span> <span class="n">GET_HASH_VALUE</span><span class="p">(</span><span class="n">keyed_hash</span><span class="p">(</span><span class="n">de</span><span class="p">.</span><span class="n">de_name</span><span class="p">,</span> <span class="n">de</span><span class="p">.</span><span class="n">de_namelen</span><span class="p">));</span>
		<span class="n">yurahash</span> <span class="o">=</span> <span class="n">GET_HASH_VALUE</span><span class="p">(</span><span class="n">yura_hash</span><span class="p">(</span><span class="n">de</span><span class="p">.</span><span class="n">de_name</span><span class="p">,</span> <span class="n">de</span><span class="p">.</span><span class="n">de_namelen</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">teahash</span> <span class="o">==</span> <span class="n">r5hash</span><span class="p">)</span>
		     <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">GET_HASH_VALUE</span><span class="p">(</span><span class="n">deh_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">de</span><span class="p">.</span><span class="n">de_deh</span><span class="p">[</span><span class="n">de</span><span class="p">.</span><span class="n">de_entry_num</span><span class="p">])))</span>
		      <span class="o">==</span> <span class="n">r5hash</span><span class="p">))</span> <span class="o">||</span> <span class="p">((</span><span class="n">teahash</span> <span class="o">==</span> <span class="n">yurahash</span><span class="p">)</span>
				      <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">yurahash</span> <span class="o">==</span>
					  <span class="n">GET_HASH_VALUE</span><span class="p">(</span><span class="n">deh_offset</span>
							 <span class="p">(</span><span class="o">&amp;</span>
							  <span class="p">(</span><span class="n">de</span><span class="p">.</span>
							   <span class="n">de_deh</span><span class="p">[</span><span class="n">de</span><span class="p">.</span>
								  <span class="n">de_entry_num</span><span class="p">])))))</span>
		    <span class="o">||</span> <span class="p">((</span><span class="n">r5hash</span> <span class="o">==</span> <span class="n">yurahash</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">yurahash</span> <span class="o">==</span>
			    <span class="n">GET_HASH_VALUE</span><span class="p">(</span><span class="n">deh_offset</span>
					   <span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">de</span><span class="p">.</span><span class="n">de_deh</span><span class="p">[</span><span class="n">de</span><span class="p">.</span><span class="n">de_entry_num</span><span class="p">]))))))</span> <span class="p">{</span>
			<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;reiserfs-2506&quot;</span><span class="p">,</span> <span class="s">&quot;Unable to &quot;</span>
					 <span class="s">&quot;automatically detect hash function. &quot;</span>
					 <span class="s">&quot;Please mount with -o &quot;</span>
					 <span class="s">&quot;hash={tea,rupasov,r5}&quot;</span><span class="p">);</span>
			<span class="n">hash</span> <span class="o">=</span> <span class="n">UNSET_HASH</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">GET_HASH_VALUE</span><span class="p">(</span><span class="n">deh_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">de</span><span class="p">.</span><span class="n">de_deh</span><span class="p">[</span><span class="n">de</span><span class="p">.</span><span class="n">de_entry_num</span><span class="p">])))</span> <span class="o">==</span>
		    <span class="n">yurahash</span><span class="p">)</span>
			<span class="n">hash</span> <span class="o">=</span> <span class="n">YURA_HASH</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_HASH_VALUE</span>
			 <span class="p">(</span><span class="n">deh_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">de</span><span class="p">.</span><span class="n">de_deh</span><span class="p">[</span><span class="n">de</span><span class="p">.</span><span class="n">de_entry_num</span><span class="p">])))</span> <span class="o">==</span> <span class="n">teahash</span><span class="p">)</span>
			<span class="n">hash</span> <span class="o">=</span> <span class="n">TEA_HASH</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_HASH_VALUE</span>
			 <span class="p">(</span><span class="n">deh_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">de</span><span class="p">.</span><span class="n">de_deh</span><span class="p">[</span><span class="n">de</span><span class="p">.</span><span class="n">de_entry_num</span><span class="p">])))</span> <span class="o">==</span> <span class="n">r5hash</span><span class="p">)</span>
			<span class="n">hash</span> <span class="o">=</span> <span class="n">R5_HASH</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;reiserfs-2506&quot;</span><span class="p">,</span>
					 <span class="s">&quot;Unrecognised hash function&quot;</span><span class="p">);</span>
			<span class="n">hash</span> <span class="o">=</span> <span class="n">UNSET_HASH</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">pathrelse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">hash</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>finds out which hash names are sorted with</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">what_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="n">code</span><span class="p">;</span>

	<span class="n">code</span> <span class="o">=</span> <span class="n">sb_hash_function_code</span><span class="p">(</span><span class="n">SB_DISK_SUPER_BLOCK</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>

	<span class="cm">/* reiserfs_hash_detect() == true if any of the hash mount options</span>
<span class="cm">	 ** were used.  We must check them to make sure the user isn&#39;t</span>
<span class="cm">	 ** using a bad hash value</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">UNSET_HASH</span> <span class="o">||</span> <span class="n">reiserfs_hash_detect</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
		<span class="n">code</span> <span class="o">=</span> <span class="n">find_hash_out</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">!=</span> <span class="n">UNSET_HASH</span> <span class="o">&amp;&amp;</span> <span class="n">reiserfs_hash_detect</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* detection has found the hash, and we must check against the</span>
<span class="cm">		 ** mount options</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reiserfs_rupasov_hash</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">code</span> <span class="o">!=</span> <span class="n">YURA_HASH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;reiserfs-2507&quot;</span><span class="p">,</span>
					 <span class="s">&quot;Error, %s hash detected, &quot;</span>
					 <span class="s">&quot;unable to force rupasov hash&quot;</span><span class="p">,</span>
					 <span class="n">reiserfs_hashname</span><span class="p">(</span><span class="n">code</span><span class="p">));</span>
			<span class="n">code</span> <span class="o">=</span> <span class="n">UNSET_HASH</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reiserfs_tea_hash</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">code</span> <span class="o">!=</span> <span class="n">TEA_HASH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;reiserfs-2508&quot;</span><span class="p">,</span>
					 <span class="s">&quot;Error, %s hash detected, &quot;</span>
					 <span class="s">&quot;unable to force tea hash&quot;</span><span class="p">,</span>
					 <span class="n">reiserfs_hashname</span><span class="p">(</span><span class="n">code</span><span class="p">));</span>
			<span class="n">code</span> <span class="o">=</span> <span class="n">UNSET_HASH</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reiserfs_r5_hash</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">code</span> <span class="o">!=</span> <span class="n">R5_HASH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;reiserfs-2509&quot;</span><span class="p">,</span>
					 <span class="s">&quot;Error, %s hash detected, &quot;</span>
					 <span class="s">&quot;unable to force r5 hash&quot;</span><span class="p">,</span>
					 <span class="n">reiserfs_hashname</span><span class="p">(</span><span class="n">code</span><span class="p">));</span>
			<span class="n">code</span> <span class="o">=</span> <span class="n">UNSET_HASH</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* find_hash_out was not called or could not determine the hash */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reiserfs_rupasov_hash</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">code</span> <span class="o">=</span> <span class="n">YURA_HASH</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reiserfs_tea_hash</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">code</span> <span class="o">=</span> <span class="n">TEA_HASH</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reiserfs_r5_hash</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">code</span> <span class="o">=</span> <span class="n">R5_HASH</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* if we are mounted RW, and we have a new valid hash code, update</span>
<span class="cm">	 ** the super</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">!=</span> <span class="n">UNSET_HASH</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">code</span> <span class="o">!=</span> <span class="n">sb_hash_function_code</span><span class="p">(</span><span class="n">SB_DISK_SUPER_BLOCK</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">set_sb_hash_function_code</span><span class="p">(</span><span class="n">SB_DISK_SUPER_BLOCK</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">code</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">code</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>return pointer to appropriate function</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="n">hashf_t</span> <span class="nf">hash_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">what_hash</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TEA_HASH</span>:
		<span class="n">reiserfs_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;Using tea hash to sort names</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">keyed_hash</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">YURA_HASH</span>:
		<span class="n">reiserfs_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;Using rupasov hash to sort names</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">yura_hash</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R5_HASH</span>:
		<span class="n">reiserfs_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;Using r5 hash to sort names</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r5_hash</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>this is used to set up correct value for old partitions</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">function2code</span><span class="p">(</span><span class="n">hashf_t</span> <span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">==</span> <span class="n">keyed_hash</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TEA_HASH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">==</span> <span class="n">yura_hash</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">YURA_HASH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">==</span> <span class="n">r5_hash</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">R5_HASH</span><span class="p">;</span>

	<span class="n">BUG</span><span class="p">();</span>			<span class="c1">// should never happen</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SWARN(silent, s, id, ...)			\</span>
<span class="cp">	if (!(silent))				\</span>
<span class="cp">		reiserfs_warning(s, id, __VA_ARGS__)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reiserfs_fill_super</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">silent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">root_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">reiserfs_transaction_handle</span> <span class="n">th</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_format</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">blocks</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">commit_max_age</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">jinit_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">reiserfs_iget_args</span> <span class="n">args</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">reiserfs_super_block</span> <span class="o">*</span><span class="n">rs</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">jdev_name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">reiserfs_sb_info</span> <span class="o">*</span><span class="n">sbi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">errval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">qf_names</span><span class="p">[</span><span class="n">MAXQUOTAS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">qfmt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">save_mount_options</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">sbi</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">reiserfs_sb_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sbi</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_fs_info</span> <span class="o">=</span> <span class="n">sbi</span><span class="p">;</span>
	<span class="cm">/* Set default values for options: non-aggressive tails, RO on errors */</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_SMALLTAIL</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_ERROR_RO</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_BARRIER_FLUSH</span><span class="p">);</span>
	<span class="cm">/* no preallocation minimum, be smart in</span>
<span class="cm">	   reiserfs_file_write instead */</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_alloc_options</span><span class="p">.</span><span class="n">preallocmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Preallocate by 16 blocks (17-1) at once */</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_alloc_options</span><span class="p">.</span><span class="n">preallocsize</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
	<span class="cm">/* setup default block allocator options */</span>
	<span class="n">reiserfs_init_alloc_options</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">old_work_lock</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">old_work</span><span class="p">,</span> <span class="n">flush_old_commits</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">lock_depth</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">jdev_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reiserfs_parse_options</span>
	    <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">blocks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jdev_name</span><span class="p">,</span>
	     <span class="o">&amp;</span><span class="n">commit_max_age</span><span class="p">,</span> <span class="n">qf_names</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qfmt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">error_unlocked</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jdev_name</span> <span class="o">&amp;&amp;</span> <span class="n">jdev_name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_jdev</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">jdev_name</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_jdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SWARN</span><span class="p">(</span><span class="n">silent</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Cannot allocate memory for &quot;</span>
				<span class="s">&quot;journal device name&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="n">handle_quota_files</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">qf_names</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qfmt</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blocks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SWARN</span><span class="p">(</span><span class="n">silent</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="s">&quot;jmacd-7&quot;</span><span class="p">,</span> <span class="s">&quot;resize option for remount only&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_unlocked</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* try old format (undistributed bitmap, super block in 8-th 1k block of a device) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">read_super_block</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">REISERFS_OLD_DISK_OFFSET_IN_BYTES</span><span class="p">))</span>
		<span class="n">old_format</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* try new format (64-th 1k block), which can contain reiserfs super block */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">read_super_block</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">REISERFS_DISK_OFFSET_IN_BYTES</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SWARN</span><span class="p">(</span><span class="n">silent</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="s">&quot;sh-2021&quot;</span><span class="p">,</span> <span class="s">&quot;can not find reiserfs on %s&quot;</span><span class="p">,</span>
		      <span class="n">reiserfs_bdevname</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">error_unlocked</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rs</span> <span class="o">=</span> <span class="n">SB_DISK_SUPER_BLOCK</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="cm">/* Let&#39;s do basic sanity check to verify that underlying device is not</span>
<span class="cm">	   smaller than the filesystem. If the check fails then abort and scream,</span>
<span class="cm">	   because bad stuff will happen otherwise. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_bdev</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="o">-&gt;</span><span class="n">bd_inode</span>
	    <span class="o">&amp;&amp;</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="o">-&gt;</span><span class="n">bd_inode</span><span class="p">)</span> <span class="o">&lt;</span>
	    <span class="n">sb_block_count</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">*</span> <span class="n">sb_blocksize</span><span class="p">(</span><span class="n">rs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SWARN</span><span class="p">(</span><span class="n">silent</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Filesystem cannot be &quot;</span>
		      <span class="s">&quot;mounted because it is bigger than the device&quot;</span><span class="p">);</span>
		<span class="n">SWARN</span><span class="p">(</span><span class="n">silent</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;You may need to run fsck &quot;</span>
		      <span class="s">&quot;or increase size of your LVM partition&quot;</span><span class="p">);</span>
		<span class="n">SWARN</span><span class="p">(</span><span class="n">silent</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Or may be you forgot to &quot;</span>
		      <span class="s">&quot;reboot after fdisk when it told you to&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_unlocked</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">=</span> <span class="n">SB_REISERFS_STATE</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_state</span> <span class="o">=</span> <span class="n">REISERFS_VALID_FS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">errval</span> <span class="o">=</span> <span class="n">reiserfs_init_bitmap_cache</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">SWARN</span><span class="p">(</span><span class="n">silent</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="s">&quot;jmacd-8&quot;</span><span class="p">,</span> <span class="s">&quot;unable to read bitmap&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_unlocked</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">errval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_REISERFS_CHECK</span>
	<span class="n">SWARN</span><span class="p">(</span><span class="n">silent</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;CONFIG_REISERFS_CHECK is set ON&quot;</span><span class="p">);</span>
	<span class="n">SWARN</span><span class="p">(</span><span class="n">silent</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;- it is slow mode for debugging.&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* make data=ordered the default */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reiserfs_data_log</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">reiserfs_data_ordered</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">reiserfs_data_writeback</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">REISERFS_DATA_ORDERED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reiserfs_data_log</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reiserfs_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;using journaled data mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reiserfs_data_ordered</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reiserfs_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;using ordered data mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reiserfs_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;using writeback data mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reiserfs_barrier_flush</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;reiserfs: using flush barriers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>set<em>device</em>ro(s->s_dev, 1) ;</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">journal_init</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">jdev_name</span><span class="p">,</span> <span class="n">old_format</span><span class="p">,</span> <span class="n">commit_max_age</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SWARN</span><span class="p">(</span><span class="n">silent</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="s">&quot;sh-2022&quot;</span><span class="p">,</span>
		      <span class="s">&quot;unable to initialize journal space&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_unlocked</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">jinit_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* once this is set, journal_release must be called</span>
<span class="cm">				 ** if we error out of the mount</span>
<span class="cm">				 */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reread_meta_blocks</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SWARN</span><span class="p">(</span><span class="n">silent</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="s">&quot;jmacd-9&quot;</span><span class="p">,</span>
		      <span class="s">&quot;unable to reread meta blocks after journal init&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_unlocked</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">replay_only</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error_unlocked</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bdev_read_only</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_bdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SWARN</span><span class="p">(</span><span class="n">silent</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="s">&quot;clm-7000&quot;</span><span class="p">,</span>
		      <span class="s">&quot;Detected readonly device, marking FS readonly&quot;</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">|=</span> <span class="n">MS_RDONLY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">args</span><span class="p">.</span><span class="n">objectid</span> <span class="o">=</span> <span class="n">REISERFS_ROOT_OBJECTID</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">dirid</span> <span class="o">=</span> <span class="n">REISERFS_ROOT_PARENT_OBJECTID</span><span class="p">;</span>
	<span class="n">root_inode</span> <span class="o">=</span>
	    <span class="n">iget5_locked</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">REISERFS_ROOT_OBJECTID</span><span class="p">,</span> <span class="n">reiserfs_find_actor</span><span class="p">,</span>
			 <span class="n">reiserfs_init_locked_inode</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">root_inode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SWARN</span><span class="p">(</span><span class="n">silent</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="s">&quot;jmacd-10&quot;</span><span class="p">,</span> <span class="s">&quot;get root inode failed&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_unlocked</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * This path assumed to be called with the BKL in the old times.</span>
<span class="cm">	 * Now we have inherited the big reiserfs lock from it and many</span>
<span class="cm">	 * reiserfs helpers called in the mount path and elsewhere require</span>
<span class="cm">	 * this lock to be held even if it&#39;s not always necessary. Let&#39;s be</span>
<span class="cm">	 * conservative and hold it early. The window can be reduced after</span>
<span class="cm">	 * careful review of the code.</span>
<span class="cm">	 */</span>
	<span class="n">reiserfs_write_lock</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">root_inode</span><span class="o">-&gt;</span><span class="n">i_state</span> <span class="o">&amp;</span> <span class="n">I_NEW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reiserfs_read_locked_inode</span><span class="p">(</span><span class="n">root_inode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">);</span>
		<span class="n">unlock_new_inode</span><span class="p">(</span><span class="n">root_inode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_root</span> <span class="o">=</span> <span class="n">d_make_root</span><span class="p">(</span><span class="n">root_inode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>define and initialize hash function</p></td><td class="code"><div class="highlight"><pre>	<span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_hash_function</span> <span class="o">=</span> <span class="n">hash_function</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_hash_function</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dput</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_reiserfs_3_5</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">is_reiserfs_jr</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">SB_VERSION</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="n">REISERFS_VERSION_1</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">REISERFS_3_5</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_properties</span><span class="p">));</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">old_format</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">REISERFS_OLD_FORMAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_properties</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">REISERFS_3_6</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_properties</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span> <span class="o">&amp;</span> <span class="n">MS_RDONLY</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">errval</span> <span class="o">=</span> <span class="n">journal_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dput</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">reiserfs_prepare_for_journal</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">SB_BUFFER_WITH_SB</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">set_sb_umount_state</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">REISERFS_ERROR_FS</span><span class="p">);</span>
		<span class="n">set_sb_fs_state</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Clear out s_bmap_nr if it would wrap. We can handle this</span>
<span class="cm">		 * case, but older revisions can&#39;t. This will cause the</span>
<span class="cm">		 * file system to fail mount on those older implementations,</span>
<span class="cm">		 * avoiding corruption. -jeffm */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bmap_would_wrap</span><span class="p">(</span><span class="n">reiserfs_bmap_count</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sb_bmap_nr</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;super-2030&quot;</span><span class="p">,</span> <span class="s">&quot;This file system &quot;</span>
					<span class="s">&quot;claims to use %u bitmap blocks in &quot;</span>
					<span class="s">&quot;its super block, but requires %u. &quot;</span>
					<span class="s">&quot;Clearing to zero.&quot;</span><span class="p">,</span> <span class="n">sb_bmap_nr</span><span class="p">(</span><span class="n">rs</span><span class="p">),</span>
					<span class="n">reiserfs_bmap_count</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>

			<span class="n">set_sb_bmap_nr</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">old_format_only</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* filesystem of format 3.5 either with standard or non-standard</span>
<span class="cm">			   journal */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">convert_reiserfs</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* and -o conv is given */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">silent</span><span class="p">)</span>
					<span class="n">reiserfs_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>
						      <span class="s">&quot;converting 3.5 filesystem to the 3.6 format&quot;</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">is_reiserfs_3_5</span><span class="p">(</span><span class="n">rs</span><span class="p">))</span>
					<span class="cm">/* put magic string of 3.6 format. 2.2 will not be able to</span>
<span class="cm">					   mount this filesystem anymore */</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">s_v1</span><span class="p">.</span><span class="n">s_magic</span><span class="p">,</span>
					       <span class="n">reiserfs_3_6_magic_string</span><span class="p">,</span>
					       <span class="k">sizeof</span>
					       <span class="p">(</span><span class="n">reiserfs_3_6_magic_string</span><span class="p">));</span>

				<span class="n">set_sb_version</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">REISERFS_VERSION_2</span><span class="p">);</span>
				<span class="n">reiserfs_convert_objectid_map_v1</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">REISERFS_3_6</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_properties</span><span class="p">));</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">REISERFS_3_5</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_properties</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">silent</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">reiserfs_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;using 3.5.x disk format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">set_sb_mnt_count</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">sb_mnt_count</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>


		<span class="n">journal_mark_dirty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">SB_BUFFER_WITH_SB</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
		<span class="n">errval</span> <span class="o">=</span> <span class="n">journal_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dput</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">errval</span> <span class="o">=</span> <span class="n">reiserfs_lookup_privroot</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">errval</span> <span class="o">=</span> <span class="n">reiserfs_xattr_init</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dput</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* look for files which were to be removed in previous session */</span>
		<span class="n">finish_unfinished</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_format_only</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">silent</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reiserfs_info</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;using 3.5.x disk format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">errval</span> <span class="o">=</span> <span class="n">reiserfs_lookup_privroot</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">errval</span> <span class="o">=</span> <span class="n">reiserfs_xattr_init</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dput</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>mark hash in super block: it could be unset. overwrite should be ok</p></td><td class="code"><div class="highlight"><pre>	<span class="n">set_sb_hash_function_code</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">function2code</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_hash_function</span><span class="p">));</span>

	<span class="n">handle_attrs</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="n">reiserfs_proc_info_init</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">s_wait</span><span class="p">));</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbi</span><span class="o">-&gt;</span><span class="n">bitmap_lock</span><span class="p">);</span>

	<span class="n">reiserfs_write_unlock</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="nl">error:</span>
	<span class="n">reiserfs_write_unlock</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

<span class="nl">error_unlocked:</span>
	<span class="cm">/* kill the commit thread, free journal ram */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jinit_done</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reiserfs_write_lock</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="n">journal_release_error</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="n">reiserfs_write_unlock</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">old_work</span><span class="p">);</span>

	<span class="n">reiserfs_free_bitmap_cache</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SB_BUFFER_WITH_SB</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">SB_BUFFER_WITH_SB</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
<span class="cp">#ifdef CONFIG_QUOTA</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAXQUOTAS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">qf_names</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sbi</span><span class="p">);</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">s_fs_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">errval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reiserfs_statfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kstatfs</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">reiserfs_super_block</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="n">SB_DISK_SUPER_BLOCK</span><span class="p">(</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="p">);</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_namelen</span> <span class="o">=</span> <span class="p">(</span><span class="n">REISERFS_MAX_NAME</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">));</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bfree</span> <span class="o">=</span> <span class="n">sb_free_blocks</span><span class="p">(</span><span class="n">rs</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bavail</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bfree</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_blocks</span> <span class="o">=</span> <span class="n">sb_block_count</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">-</span> <span class="n">sb_bmap_nr</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_bsize</span> <span class="o">=</span> <span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">;</span>
	<span class="cm">/* changed to accommodate gcc folks. */</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_type</span> <span class="o">=</span> <span class="n">REISERFS_SUPER_MAGIC</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_fsid</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">crc32_le</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">s_uuid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">s_uuid</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">f_fsid</span><span class="p">.</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">crc32_le</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">s_uuid</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">s_uuid</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">s_uuid</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_QUOTA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">reiserfs_write_dquot</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">reiserfs_transaction_handle</span> <span class="n">th</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">reiserfs_write_lock</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span>
	    <span class="n">journal_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">,</span>
			  <span class="n">REISERFS_QUOTA_TRANS_BLOCKS</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dquot_commit</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span>
	    <span class="n">journal_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">,</span>
			<span class="n">REISERFS_QUOTA_TRANS_BLOCKS</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">err</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
      <span class="nl">out:</span>
	<span class="n">reiserfs_write_unlock</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reiserfs_acquire_dquot</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">reiserfs_transaction_handle</span> <span class="n">th</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">reiserfs_write_lock</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span>
	    <span class="n">journal_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">,</span>
			  <span class="n">REISERFS_QUOTA_INIT_BLOCKS</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dquot_acquire</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span>
	    <span class="n">journal_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">,</span>
			<span class="n">REISERFS_QUOTA_INIT_BLOCKS</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">err</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
      <span class="nl">out:</span>
	<span class="n">reiserfs_write_unlock</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reiserfs_release_dquot</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">reiserfs_transaction_handle</span> <span class="n">th</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">reiserfs_write_lock</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span>
	    <span class="n">journal_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">,</span>
			  <span class="n">REISERFS_QUOTA_DEL_BLOCKS</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Release dquot anyway to avoid endless cycle in dqput() */</span>
		<span class="n">dquot_release</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dquot_release</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span>
	    <span class="n">journal_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">,</span>
			<span class="n">REISERFS_QUOTA_DEL_BLOCKS</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">err</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
      <span class="nl">out:</span>
	<span class="n">reiserfs_write_unlock</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reiserfs_mark_dquot_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">dquot</span> <span class="o">*</span><span class="n">dquot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Are we journaling quotas? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">USRQUOTA</span><span class="p">]</span> <span class="o">||</span>
	    <span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">dquot</span><span class="o">-&gt;</span><span class="n">dq_sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">GRPQUOTA</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dquot_mark_dquot_dirty</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">reiserfs_write_dquot</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="n">dquot_mark_dquot_dirty</span><span class="p">(</span><span class="n">dquot</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reiserfs_write_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">reiserfs_transaction_handle</span> <span class="n">th</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Data block + inode block */</span>
	<span class="n">reiserfs_write_lock</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">journal_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dquot_commit_info</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">journal_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">err</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
      <span class="nl">out:</span>
	<span class="n">reiserfs_write_unlock</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Turn on quotas during mount time - we need to find the quota file and such...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">reiserfs_quota_on_mount</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dquot_quota_on_mount</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">type</span><span class="p">],</span>
					<span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_jquota_fmt</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Standard function to be called on quota_on</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">reiserfs_quota_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">format_id</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">path</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">reiserfs_transaction_handle</span> <span class="n">th</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">opt</span> <span class="o">=</span> <span class="n">type</span> <span class="o">==</span> <span class="n">USRQUOTA</span> <span class="o">?</span> <span class="n">REISERFS_USRQUOTA</span> <span class="o">:</span> <span class="n">REISERFS_GRPQUOTA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_mount_opt</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">opt</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Quotafile not on the same filesystem? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span> <span class="o">!=</span> <span class="n">sb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EXDEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">inode</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="cm">/* We must not pack tails for quota files on reiserfs for quota IO to work */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">REISERFS_I</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_flags</span> <span class="o">&amp;</span> <span class="n">i_nopack_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">reiserfs_unpack</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;super-6520&quot;</span><span class="p">,</span>
				<span class="s">&quot;Unpacking tail of quota file failed&quot;</span>
				<span class="s">&quot; (%d). Cannot turn on quotas.&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mark_inode_dirty</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Journaling quota? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">type</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* Quotafile not of fs root? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_parent</span> <span class="o">!=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_root</span><span class="p">)</span>
			<span class="n">reiserfs_warning</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;super-6521&quot;</span><span class="p">,</span>
				 <span class="s">&quot;Quota file not on filesystem root. &quot;</span>
				 <span class="s">&quot;Journalled quota will not work.&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * When we journal data on quota file, we have to flush journal to see</span>
<span class="cm">	 * all updates to the file when we bypass pagecache...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reiserfs_file_data_log</span><span class="p">(</span><span class="n">inode</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Just start temporary transaction and finish it */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">journal_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">journal_end_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">dquot_quota_on</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">format_id</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Read data from quotafile - avoid pagecache and such because we cannot afford</span>
<span class="cm"> * acquiring the locks... As quota files are never truncated and quota code</span>
<span class="cm"> * itself serializes the operations (and no one else should touch the files)</span>
<span class="cm"> * we don&#39;t have to be afraid of races */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">reiserfs_quota_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				   <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">blk</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&gt;&gt;</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">tocopy</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">toread</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="n">tmp_bh</span><span class="p">,</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">i_size</span> <span class="o">=</span> <span class="n">i_size_read</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;</span> <span class="n">i_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">i_size</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">i_size</span> <span class="o">-</span> <span class="n">off</span><span class="p">;</span>
	<span class="n">toread</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">toread</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tocopy</span> <span class="o">=</span>
		    <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">&lt;</span>
		    <span class="n">toread</span> <span class="o">?</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">:</span> <span class="n">toread</span><span class="p">;</span>
		<span class="n">tmp_bh</span><span class="p">.</span><span class="n">b_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Quota files are without tails so we can safely use this function */</span>
		<span class="n">reiserfs_write_lock</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">reiserfs_get_block</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">blk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_bh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">reiserfs_write_unlock</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer_mapped</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_bh</span><span class="p">))</span>	<span class="cm">/* A hole? */</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tocopy</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">bh</span> <span class="o">=</span> <span class="n">sb_bread</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">tmp_bh</span><span class="p">.</span><span class="n">b_blocknr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tocopy</span><span class="p">);</span>
			<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">toread</span> <span class="o">-=</span> <span class="n">tocopy</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">tocopy</span><span class="p">;</span>
		<span class="n">blk</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Write to quotafile (we know the transaction is already started and has</span>
<span class="cm"> * enough credits) */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">reiserfs_quota_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">super_block</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">sb_dqopt</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">blk</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&gt;&gt;</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize_bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">tocopy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">journal_quota</span> <span class="o">=</span> <span class="n">REISERFS_SB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">s_qf_names</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">towrite</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffer_head</span> <span class="n">tmp_bh</span><span class="p">,</span> <span class="o">*</span><span class="n">bh</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">journal_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;reiserfs: Quota write (off=%Lu, len=%Lu)&quot;</span>
			<span class="s">&quot; cancelled because transaction is not started.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">off</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">towrite</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tocopy</span> <span class="o">=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">towrite</span> <span class="o">?</span>
		    <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">:</span> <span class="n">towrite</span><span class="p">;</span>
		<span class="n">tmp_bh</span><span class="p">.</span><span class="n">b_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">reiserfs_get_block</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">blk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_bh</span><span class="p">,</span> <span class="n">GET_BLOCK_CREATE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">||</span> <span class="n">tocopy</span> <span class="o">!=</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">s_blocksize</span><span class="p">)</span>
			<span class="n">bh</span> <span class="o">=</span> <span class="n">sb_bread</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">tmp_bh</span><span class="p">.</span><span class="n">b_blocknr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bh</span> <span class="o">=</span> <span class="n">sb_getblk</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">tmp_bh</span><span class="p">.</span><span class="n">b_blocknr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bh</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lock_buffer</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">tocopy</span><span class="p">);</span>
		<span class="n">flush_dcache_page</span><span class="p">(</span><span class="n">bh</span><span class="o">-&gt;</span><span class="n">b_page</span><span class="p">);</span>
		<span class="n">set_buffer_uptodate</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="n">unlock_buffer</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="n">reiserfs_prepare_for_journal</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">journal_mark_dirty</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">journal_info</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="n">bh</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">journal_quota</span><span class="p">)</span>
			<span class="n">reiserfs_add_ordered_list</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">bh</span><span class="p">);</span>
		<span class="n">brelse</span><span class="p">(</span><span class="n">bh</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">towrite</span> <span class="o">-=</span> <span class="n">tocopy</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">tocopy</span><span class="p">;</span>
		<span class="n">blk</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="n">towrite</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_size</span> <span class="o">&lt;</span> <span class="n">off</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="n">towrite</span><span class="p">)</span>
		<span class="n">i_size_write</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">off</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="n">towrite</span><span class="p">);</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_version</span><span class="o">++</span><span class="p">;</span>
	<span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mtime</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_ctime</span> <span class="o">=</span> <span class="n">CURRENT_TIME</span><span class="p">;</span>
	<span class="n">mark_inode_dirty</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span> <span class="o">-</span> <span class="n">towrite</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="nf">get_super_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">file_system_type</span> <span class="o">*</span><span class="n">fs_type</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_name</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mount_bdev</span><span class="p">(</span><span class="n">fs_type</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">reiserfs_fill_super</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_reiserfs_fs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">init_inodecache</span><span class="p">()))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reiserfs_proc_info_global_init</span><span class="p">();</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reiserfs_fs_type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reiserfs_proc_info_global_done</span><span class="p">();</span>
	<span class="n">destroy_inodecache</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exit_reiserfs_fs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">reiserfs_proc_info_global_done</span><span class="p">();</span>
	<span class="n">unregister_filesystem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reiserfs_fs_type</span><span class="p">);</span>
	<span class="n">destroy_inodecache</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">file_system_type</span> <span class="n">reiserfs_fs_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;reiserfs&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mount</span> <span class="o">=</span> <span class="n">get_super_block</span><span class="p">,</span>
	<span class="p">.</span><span class="n">kill_sb</span> <span class="o">=</span> <span class="n">reiserfs_kill_sb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fs_flags</span> <span class="o">=</span> <span class="n">FS_REQUIRES_DEV</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ReiserFS journaled filesystem&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Hans Reiser &lt;reiser@namesys.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_reiserfs_fs</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_reiserfs_fs</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
