<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › ocfs2 › dlm › dlmlock.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>dlmlock.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* -*- mode: c; c-basic-offset: 8; -*-</span>
<span class="cm"> * vim: noexpandtab sw=8 ts=8 sts=0:</span>
<span class="cm"> *</span>
<span class="cm"> * dlmlock.c</span>
<span class="cm"> *</span>
<span class="cm"> * underlying calls for lock creation</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004 Oracle.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public</span>
<span class="cm"> * License as published by the Free Software Foundation; either</span>
<span class="cm"> * version 2 of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public</span>
<span class="cm"> * License along with this program; if not, write to the</span>
<span class="cm"> * Free Software Foundation, Inc., 59 Temple Place - Suite 330,</span>
<span class="cm"> * Boston, MA 021110-1307, USA.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>


<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/sysctl.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/socket.h&gt;</span>
<span class="cp">#include &lt;linux/inet.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>


<span class="cp">#include &quot;cluster/heartbeat.h&quot;</span>
<span class="cp">#include &quot;cluster/nodemanager.h&quot;</span>
<span class="cp">#include &quot;cluster/tcp.h&quot;</span>

<span class="cp">#include &quot;dlmapi.h&quot;</span>
<span class="cp">#include &quot;dlmcommon.h&quot;</span>

<span class="cp">#include &quot;dlmconvert.h&quot;</span>

<span class="cp">#define MLOG_MASK_PREFIX ML_DLM</span>
<span class="cp">#include &quot;cluster/masklog.h&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kmem_cache</span> <span class="o">*</span><span class="n">dlm_lock_cache</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">dlm_cookie_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">dlm_next_cookie</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">dlm_status</span> <span class="n">dlm_send_remote_lock_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">dlm_ctxt</span> <span class="o">*</span><span class="n">dlm</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">dlm_lock_resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">dlm_lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dlm_init_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">dlm_lock</span> <span class="o">*</span><span class="n">newlock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">node</span><span class="p">,</span> <span class="n">u64</span> <span class="n">cookie</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dlm_lock_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dlm_lock_detach_lockres</span><span class="p">(</span><span class="k">struct</span> <span class="n">dlm_lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">dlm_init_lock_cache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dlm_lock_cache</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">&quot;o2dlm_lock&quot;</span><span class="p">,</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dlm_lock</span><span class="p">),</span>
					   <span class="mi">0</span><span class="p">,</span> <span class="n">SLAB_HWCACHE_ALIGN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dlm_lock_cache</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dlm_destroy_lock_cache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dlm_lock_cache</span><span class="p">)</span>
		<span class="n">kmem_cache_destroy</span><span class="p">(</span><span class="n">dlm_lock_cache</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Tell us whether we can grant a new lock request.</span>
<span class="cm"> * locking:</span>
<span class="cm"> *   caller needs:  res-&gt;spinlock</span>
<span class="cm"> *   taken:         none</span>
<span class="cm"> *   held on exit:  none</span>
<span class="cm"> * returns: 1 if the lock can be granted, 0 otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dlm_can_grant_new_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">dlm_lock_resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">dlm_lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dlm_lock</span> <span class="o">*</span><span class="n">tmplock</span><span class="p">;</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">granted</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmplock</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dlm_lock</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dlm_lock_compatible</span><span class="p">(</span><span class="n">tmplock</span><span class="o">-&gt;</span><span class="n">ml</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">ml</span><span class="p">.</span><span class="n">type</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">converting</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmplock</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dlm_lock</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dlm_lock_compatible</span><span class="p">(</span><span class="n">tmplock</span><span class="o">-&gt;</span><span class="n">ml</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">ml</span><span class="p">.</span><span class="n">type</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dlm_lock_compatible</span><span class="p">(</span><span class="n">tmplock</span><span class="o">-&gt;</span><span class="n">ml</span><span class="p">.</span><span class="n">convert_type</span><span class="p">,</span>
					 <span class="n">lock</span><span class="o">-&gt;</span><span class="n">ml</span><span class="p">.</span><span class="n">type</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* performs lock creation at the lockres master site</span>
<span class="cm"> * locking:</span>
<span class="cm"> *   caller needs:  none</span>
<span class="cm"> *   taken:         takes and drops res-&gt;spinlock</span>
<span class="cm"> *   held on exit:  none</span>
<span class="cm"> * returns: DLM_NORMAL, DLM_NOTQUEUED</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">dlm_status</span> <span class="nf">dlmlock_master</span><span class="p">(</span><span class="k">struct</span> <span class="n">dlm_ctxt</span> <span class="o">*</span><span class="n">dlm</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">dlm_lock_resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">dlm_lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">call_ast</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">kick_thread</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dlm_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">DLM_NORMAL</span><span class="p">;</span>

	<span class="n">mlog</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;type=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">ml</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>
	<span class="cm">/* if called from dlm_create_lock_handler, need to</span>
<span class="cm">	 * ensure it will not sleep in dlm_wait_on_lockres */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">__dlm_lockres_state_to_status</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">DLM_NORMAL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">lock</span><span class="o">-&gt;</span><span class="n">ml</span><span class="p">.</span><span class="n">node</span> <span class="o">!=</span> <span class="n">dlm</span><span class="o">-&gt;</span><span class="n">node_num</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* erf.  state changed after lock was dropped. */</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>
		<span class="n">dlm_error</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">__dlm_wait_on_lockres</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="n">__dlm_lockres_reserve_ast</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dlm_can_grant_new_lock</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mlog</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;I can grant this lock right away</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* got it right away */</span>
		<span class="n">lock</span><span class="o">-&gt;</span><span class="n">lksb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">DLM_NORMAL</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">DLM_NORMAL</span><span class="p">;</span>
		<span class="n">dlm_lock_get</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">granted</span><span class="p">);</span>

		<span class="cm">/* for the recovery lock, we can&#39;t allow the ast</span>
<span class="cm">		 * to be queued since the dlmthread is already</span>
<span class="cm">		 * frozen.  but the recovery lock is always locked</span>
<span class="cm">		 * with LKM_NOQUEUE so we do not need the ast in</span>
<span class="cm">		 * this special case */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dlm_is_recovery_lock</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">lockname</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
					  <span class="n">res</span><span class="o">-&gt;</span><span class="n">lockname</span><span class="p">.</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kick_thread</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">call_ast</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mlog</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: returning DLM_NORMAL to &quot;</span>
			     <span class="s">&quot;node %u for reco lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dlm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			     <span class="n">lock</span><span class="o">-&gt;</span><span class="n">ml</span><span class="p">.</span><span class="n">node</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* for NOQUEUE request, unless we get the</span>
<span class="cm">		 * lock right away, return DLM_NOTQUEUED */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LKM_NOQUEUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">DLM_NOTQUEUED</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dlm_is_recovery_lock</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">lockname</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
						 <span class="n">res</span><span class="o">-&gt;</span><span class="n">lockname</span><span class="p">.</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">mlog</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: returning NOTQUEUED to &quot;</span>
				     <span class="s">&quot;node %u for reco lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dlm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				     <span class="n">lock</span><span class="o">-&gt;</span><span class="n">ml</span><span class="p">.</span><span class="n">node</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dlm_lock_get</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">blocked</span><span class="p">);</span>
			<span class="n">kick_thread</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>

	<span class="cm">/* either queue the ast or release it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">call_ast</span><span class="p">)</span>
		<span class="n">dlm_queue_ast</span><span class="p">(</span><span class="n">dlm</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dlm_lockres_release_ast</span><span class="p">(</span><span class="n">dlm</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

	<span class="n">dlm_lockres_calc_usage</span><span class="p">(</span><span class="n">dlm</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kick_thread</span><span class="p">)</span>
		<span class="n">dlm_kick_thread</span><span class="p">(</span><span class="n">dlm</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dlm_revert_pending_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">dlm_lock_resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">dlm_lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* remove from local queue if it failed */</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">lock</span><span class="o">-&gt;</span><span class="n">lksb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DLM_LKSB_GET_LVB</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * locking:</span>
<span class="cm"> *   caller needs:  none</span>
<span class="cm"> *   taken:         takes and drops res-&gt;spinlock</span>
<span class="cm"> *   held on exit:  none</span>
<span class="cm"> * returns: DLM_DENIED, DLM_RECOVERING, or net status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">dlm_status</span> <span class="nf">dlmlock_remote</span><span class="p">(</span><span class="k">struct</span> <span class="n">dlm_ctxt</span> <span class="o">*</span><span class="n">dlm</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">dlm_lock_resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">dlm_lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">dlm_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">DLM_DENIED</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lockres_changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mlog</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;type=%d, lockres %.*s, flags = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">lock</span><span class="o">-&gt;</span><span class="n">ml</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">lockname</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
	     <span class="n">res</span><span class="o">-&gt;</span><span class="n">lockname</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait if resource is getting recovered, remastered, etc.</span>
<span class="cm">	 * If the resource was remastered and new owner is self, then exit.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>
	<span class="n">__dlm_wait_on_lockres</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">==</span> <span class="n">dlm</span><span class="o">-&gt;</span><span class="n">node_num</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">DLM_RECOVERING</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">DLM_LOCK_RES_IN_PROGRESS</span><span class="p">;</span>

	<span class="cm">/* add lock to local (secondary) queue */</span>
	<span class="n">dlm_lock_get</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">blocked</span><span class="p">);</span>
	<span class="n">lock</span><span class="o">-&gt;</span><span class="n">lock_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>

	<span class="cm">/* spec seems to say that you will get DLM_NORMAL when the lock</span>
<span class="cm">	 * has been queued, meaning we need to wait for a reply here. */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">dlm_send_remote_lock_request</span><span class="p">(</span><span class="n">dlm</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DLM_LOCK_RES_IN_PROGRESS</span><span class="p">;</span>
	<span class="n">lock</span><span class="o">-&gt;</span><span class="n">lock_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">DLM_NORMAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">DLM_RECOVERING</span> <span class="o">&amp;&amp;</span>
		    <span class="n">dlm_is_recovery_lock</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">lockname</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
					 <span class="n">res</span><span class="o">-&gt;</span><span class="n">lockname</span><span class="p">.</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* recovery lock was mastered by dead node.</span>
<span class="cm">			 * we need to have calc_usage shoot down this</span>
<span class="cm">			 * lockres and completely remaster it. */</span>
			<span class="n">mlog</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: recovery lock was owned by &quot;</span>
			     <span class="s">&quot;dead node %u, remaster it now.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">dlm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">DLM_NOTQUEUED</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * DO NOT call calc_usage, as this would unhash</span>
<span class="cm">			 * the remote lockres before we ever get to use</span>
<span class="cm">			 * it.  treat as if we never made any change to</span>
<span class="cm">			 * the lockres.</span>
<span class="cm">			 */</span>
			<span class="n">lockres_changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dlm_error</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dlm_revert_pending_lock</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
		<span class="n">dlm_lock_put</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dlm_is_recovery_lock</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">lockname</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
					<span class="n">res</span><span class="o">-&gt;</span><span class="n">lockname</span><span class="p">.</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* special case for the $RECOVERY lock.</span>
<span class="cm">		 * there will never be an AST delivered to put</span>
<span class="cm">		 * this lock on the proper secondary queue</span>
<span class="cm">		 * (granted), so do it manually. */</span>
		<span class="n">mlog</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: $RECOVERY lock for this node (%u) is &quot;</span>
		     <span class="s">&quot;mastered by %u; got lock, manually granting (no ast)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">dlm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dlm</span><span class="o">-&gt;</span><span class="n">node_num</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">granted</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lockres_changed</span><span class="p">)</span>
		<span class="n">dlm_lockres_calc_usage</span><span class="p">(</span><span class="n">dlm</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* for remote lock creation.</span>
<span class="cm"> * locking:</span>
<span class="cm"> *   caller needs:  none, but need res-&gt;state &amp; DLM_LOCK_RES_IN_PROGRESS</span>
<span class="cm"> *   taken:         none</span>
<span class="cm"> *   held on exit:  none</span>
<span class="cm"> * returns: DLM_NOLOCKMGR, or net status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">dlm_status</span> <span class="nf">dlm_send_remote_lock_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">dlm_ctxt</span> <span class="o">*</span><span class="n">dlm</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">dlm_lock_resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">dlm_lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dlm_create_lock</span> <span class="n">create</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmpret</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dlm_status</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">create</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">create</span><span class="p">));</span>
	<span class="n">create</span><span class="p">.</span><span class="n">node_idx</span> <span class="o">=</span> <span class="n">dlm</span><span class="o">-&gt;</span><span class="n">node_num</span><span class="p">;</span>
	<span class="n">create</span><span class="p">.</span><span class="n">requested_type</span> <span class="o">=</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">ml</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
	<span class="n">create</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">ml</span><span class="p">.</span><span class="n">cookie</span><span class="p">;</span>
	<span class="n">create</span><span class="p">.</span><span class="n">namelen</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">lockname</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="n">create</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">create</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">lockname</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">create</span><span class="p">.</span><span class="n">namelen</span><span class="p">);</span>

	<span class="n">tmpret</span> <span class="o">=</span> <span class="n">o2net_send_message</span><span class="p">(</span><span class="n">DLM_CREATE_LOCK_MSG</span><span class="p">,</span> <span class="n">dlm</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">create</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="n">create</span><span class="p">),</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmpret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">DLM_REJECTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mlog</span><span class="p">(</span><span class="n">ML_ERROR</span><span class="p">,</span> <span class="s">&quot;%s: res %.*s, Stale lockres no longer &quot;</span>
			     <span class="s">&quot;owned by node %u. That node is coming back up &quot;</span>
			     <span class="s">&quot;currently.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dlm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">create</span><span class="p">.</span><span class="n">namelen</span><span class="p">,</span>
			     <span class="n">create</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
			<span class="n">dlm_print_one_lock_resource</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mlog</span><span class="p">(</span><span class="n">ML_ERROR</span><span class="p">,</span> <span class="s">&quot;%s: res %.*s, Error %d send CREATE LOCK to &quot;</span>
		     <span class="s">&quot;node %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dlm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">create</span><span class="p">.</span><span class="n">namelen</span><span class="p">,</span> <span class="n">create</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
		     <span class="n">tmpret</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dlm_is_host_down</span><span class="p">(</span><span class="n">tmpret</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">DLM_RECOVERING</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">dlm_err_to_dlm_status</span><span class="p">(</span><span class="n">tmpret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dlm_lock_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">dlm_lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lock_refs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dlm_lock_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">dlm_lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lock_refs</span><span class="p">,</span> <span class="n">dlm_lock_release</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dlm_lock_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dlm_lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">;</span>

	<span class="n">lock</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dlm_lock</span><span class="p">,</span> <span class="n">lock_refs</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">ast_list</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">bast_list</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">ast_pending</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">bast_pending</span><span class="p">);</span>

	<span class="n">dlm_lock_detach_lockres</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lksb_kernel_allocated</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlog</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;freeing kernel-allocated lksb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lksb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">dlm_lock_cache</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* associate a lock with it&#39;s lockres, getting a ref on the lockres */</span>
<span class="kt">void</span> <span class="nf">dlm_lock_attach_lockres</span><span class="p">(</span><span class="k">struct</span> <span class="n">dlm_lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">dlm_lock_resource</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dlm_lockres_get</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="n">lock</span><span class="o">-&gt;</span><span class="n">lockres</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* drop ref on lockres, if there is still one associated with lock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dlm_lock_detach_lockres</span><span class="p">(</span><span class="k">struct</span> <span class="n">dlm_lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dlm_lock_resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">lockres</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lock</span><span class="o">-&gt;</span><span class="n">lockres</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mlog</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;removing lock&#39;s lockres reference</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dlm_lockres_put</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dlm_init_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">dlm_lock</span> <span class="o">*</span><span class="n">newlock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">node</span><span class="p">,</span> <span class="n">u64</span> <span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newlock</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newlock</span><span class="o">-&gt;</span><span class="n">ast_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newlock</span><span class="o">-&gt;</span><span class="n">bast_list</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newlock</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>
	<span class="n">newlock</span><span class="o">-&gt;</span><span class="n">ml</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">newlock</span><span class="o">-&gt;</span><span class="n">ml</span><span class="p">.</span><span class="n">convert_type</span> <span class="o">=</span> <span class="n">LKM_IVMODE</span><span class="p">;</span>
	<span class="n">newlock</span><span class="o">-&gt;</span><span class="n">ml</span><span class="p">.</span><span class="n">highest_blocked</span> <span class="o">=</span> <span class="n">LKM_IVMODE</span><span class="p">;</span>
	<span class="n">newlock</span><span class="o">-&gt;</span><span class="n">ml</span><span class="p">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="p">;</span>
	<span class="n">newlock</span><span class="o">-&gt;</span><span class="n">ml</span><span class="p">.</span><span class="n">pad1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">newlock</span><span class="o">-&gt;</span><span class="n">ml</span><span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">newlock</span><span class="o">-&gt;</span><span class="n">ml</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">newlock</span><span class="o">-&gt;</span><span class="n">ast</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">newlock</span><span class="o">-&gt;</span><span class="n">bast</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">newlock</span><span class="o">-&gt;</span><span class="n">astdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">newlock</span><span class="o">-&gt;</span><span class="n">ml</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">cookie</span><span class="p">);</span>
	<span class="n">newlock</span><span class="o">-&gt;</span><span class="n">ast_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">newlock</span><span class="o">-&gt;</span><span class="n">bast_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">newlock</span><span class="o">-&gt;</span><span class="n">convert_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">newlock</span><span class="o">-&gt;</span><span class="n">lock_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">newlock</span><span class="o">-&gt;</span><span class="n">unlock_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">newlock</span><span class="o">-&gt;</span><span class="n">cancel_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">newlock</span><span class="o">-&gt;</span><span class="n">lksb_kernel_allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newlock</span><span class="o">-&gt;</span><span class="n">lock_refs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">dlm_lock</span> <span class="o">*</span> <span class="nf">dlm_new_lock</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">node</span><span class="p">,</span> <span class="n">u64</span> <span class="n">cookie</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">dlm_lockstatus</span> <span class="o">*</span><span class="n">lksb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dlm_lock</span> <span class="o">*</span><span class="n">lock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">kernel_allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lock</span> <span class="o">=</span> <span class="n">kmem_cache_zalloc</span><span class="p">(</span><span class="n">dlm_lock_cache</span><span class="p">,</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lock</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lksb</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* zero memory only if kernel-allocated */</span>
		<span class="n">lksb</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lksb</span><span class="p">),</span> <span class="n">GFP_NOFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lksb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">dlm_lock_cache</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kernel_allocated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dlm_init_lock</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">cookie</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kernel_allocated</span><span class="p">)</span>
		<span class="n">lock</span><span class="o">-&gt;</span><span class="n">lksb_kernel_allocated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lock</span><span class="o">-&gt;</span><span class="n">lksb</span> <span class="o">=</span> <span class="n">lksb</span><span class="p">;</span>
	<span class="n">lksb</span><span class="o">-&gt;</span><span class="n">lockid</span> <span class="o">=</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">lock</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* handler for lock creation net message</span>
<span class="cm"> * locking:</span>
<span class="cm"> *   caller needs:  none</span>
<span class="cm"> *   taken:         takes and drops res-&gt;spinlock</span>
<span class="cm"> *   held on exit:  none</span>
<span class="cm"> * returns: DLM_NORMAL, DLM_SYSERR, DLM_IVLOCKID, DLM_NOTQUEUED</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dlm_create_lock_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">o2net_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">**</span><span class="n">ret_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dlm_ctxt</span> <span class="o">*</span><span class="n">dlm</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dlm_create_lock</span> <span class="o">*</span><span class="n">create</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dlm_create_lock</span> <span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dlm_lock_resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dlm_lock</span> <span class="o">*</span><span class="n">newlock</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dlm_lockstatus</span> <span class="o">*</span><span class="n">lksb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dlm_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">DLM_NORMAL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">namelen</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dlm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dlm_grab</span><span class="p">(</span><span class="n">dlm</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">DLM_REJECTED</span><span class="p">;</span>

	<span class="n">name</span> <span class="o">=</span> <span class="n">create</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">namelen</span> <span class="o">=</span> <span class="n">create</span><span class="o">-&gt;</span><span class="n">namelen</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">DLM_REJECTED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dlm_domain_fully_joined</span><span class="p">(</span><span class="n">dlm</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mlog</span><span class="p">(</span><span class="n">ML_ERROR</span><span class="p">,</span> <span class="s">&quot;Domain %s not fully joined, but node %u is &quot;</span>
		     <span class="s">&quot;sending a create_lock message for lock %.*s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">dlm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">create</span><span class="o">-&gt;</span><span class="n">node_idx</span><span class="p">,</span> <span class="n">namelen</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">dlm_error</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">DLM_IVBUFLEN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">namelen</span> <span class="o">&gt;</span> <span class="n">DLM_LOCKID_NAME_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dlm_error</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">DLM_SYSERR</span><span class="p">;</span>
	<span class="n">newlock</span> <span class="o">=</span> <span class="n">dlm_new_lock</span><span class="p">(</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">requested_type</span><span class="p">,</span>
			       <span class="n">create</span><span class="o">-&gt;</span><span class="n">node_idx</span><span class="p">,</span>
			       <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newlock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dlm_error</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lksb</span> <span class="o">=</span> <span class="n">newlock</span><span class="o">-&gt;</span><span class="n">lksb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LKM_GET_LVB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lksb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DLM_LKSB_GET_LVB</span><span class="p">;</span>
		<span class="n">mlog</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;set DLM_LKSB_GET_LVB flag</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">DLM_IVLOCKID</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">dlm_lookup_lockres</span><span class="p">(</span><span class="n">dlm</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dlm_error</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">__dlm_lockres_state_to_status</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">DLM_NORMAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlog</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;lockres recovering/migrating/in-progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dlm_lock_attach_lockres</span><span class="p">(</span><span class="n">newlock</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">dlmlock_master</span><span class="p">(</span><span class="n">dlm</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">newlock</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">create</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
<span class="nl">leave:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">DLM_NORMAL</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newlock</span><span class="p">)</span>
			<span class="n">dlm_lock_put</span><span class="p">(</span><span class="n">newlock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">dlm_lockres_put</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

	<span class="n">dlm_put</span><span class="p">(</span><span class="n">dlm</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* fetch next node-local (u8 nodenum + u56 cookie) into u64 */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dlm_get_next_cookie</span><span class="p">(</span><span class="n">u8</span> <span class="n">node_num</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">tmpnode</span> <span class="o">=</span> <span class="n">node_num</span><span class="p">;</span>

	<span class="cm">/* shift single byte of node num into top 8 bits */</span>
	<span class="n">tmpnode</span> <span class="o">&lt;&lt;=</span> <span class="mi">56</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dlm_cookie_lock</span><span class="p">);</span>
	<span class="o">*</span><span class="n">cookie</span> <span class="o">=</span> <span class="p">(</span><span class="n">dlm_next_cookie</span> <span class="o">|</span> <span class="n">tmpnode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">dlm_next_cookie</span> <span class="o">&amp;</span> <span class="mh">0xff00000000000000ull</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlog</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;This node&#39;s cookie will now wrap!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dlm_next_cookie</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dlm_cookie_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">dlm_status</span> <span class="nf">dlmlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">dlm_ctxt</span> <span class="o">*</span><span class="n">dlm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">dlm_lockstatus</span> <span class="o">*</span><span class="n">lksb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">namelen</span><span class="p">,</span> <span class="n">dlm_astlockfunc_t</span> <span class="o">*</span><span class="n">ast</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">dlm_bastlockfunc_t</span> <span class="o">*</span><span class="n">bast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">dlm_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dlm_lock_resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dlm_lock</span> <span class="o">*</span><span class="n">lock</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">convert</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">recovery</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* yes this function is a mess.</span>
<span class="cm">	 * TODO: clean this up.  lots of common code in the</span>
<span class="cm">	 *       lock and convert paths, especially in the retry blocks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lksb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dlm_error</span><span class="p">(</span><span class="n">DLM_BADARGS</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">DLM_BADARGS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">DLM_BADPARAM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">LKM_EXMODE</span> <span class="o">&amp;&amp;</span> <span class="n">mode</span> <span class="o">!=</span> <span class="n">LKM_PRMODE</span> <span class="o">&amp;&amp;</span> <span class="n">mode</span> <span class="o">!=</span> <span class="n">LKM_NLMODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dlm_error</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LKM_VALID_FLAGS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dlm_error</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">convert</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LKM_CONVERT</span><span class="p">);</span>
	<span class="n">recovery</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LKM_RECOVERY</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">recovery</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">dlm_is_recovery_lock</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">)</span> <span class="o">||</span> <span class="n">convert</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">dlm_error</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">convert</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LKM_LOCAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mlog</span><span class="p">(</span><span class="n">ML_ERROR</span><span class="p">,</span> <span class="s">&quot;strange LOCAL convert request!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">convert</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* CONVERT request */</span>

		<span class="cm">/* if converting, must pass in a valid dlm_lock */</span>
		<span class="n">lock</span> <span class="o">=</span> <span class="n">lksb</span><span class="o">-&gt;</span><span class="n">lockid</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mlog</span><span class="p">(</span><span class="n">ML_ERROR</span><span class="p">,</span> <span class="s">&quot;NULL lock pointer in convert &quot;</span>
			     <span class="s">&quot;request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">res</span> <span class="o">=</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">lockres</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mlog</span><span class="p">(</span><span class="n">ML_ERROR</span><span class="p">,</span> <span class="s">&quot;NULL lockres pointer in convert &quot;</span>
			     <span class="s">&quot;request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dlm_lockres_get</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

		<span class="cm">/* XXX: for ocfs2 purposes, the ast/bast/astdata/lksb are</span>
<span class="cm">	 	 * static after the original lock call.  convert requests will</span>
<span class="cm">		 * ensure that everything is the same, or return DLM_BADARGS.</span>
<span class="cm">	 	 * this means that DLM_DENIED_NOASTS will never be returned.</span>
<span class="cm">	 	 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lksb</span> <span class="o">!=</span> <span class="n">lksb</span> <span class="o">||</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">ast</span> <span class="o">!=</span> <span class="n">ast</span> <span class="o">||</span>
		    <span class="n">lock</span><span class="o">-&gt;</span><span class="n">bast</span> <span class="o">!=</span> <span class="n">bast</span> <span class="o">||</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">astdata</span> <span class="o">!=</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">DLM_BADARGS</span><span class="p">;</span>
			<span class="n">mlog</span><span class="p">(</span><span class="n">ML_ERROR</span><span class="p">,</span> <span class="s">&quot;new args:  lksb=%p, ast=%p, bast=%p, &quot;</span>
			     <span class="s">&quot;astdata=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lksb</span><span class="p">,</span> <span class="n">ast</span><span class="p">,</span> <span class="n">bast</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="n">mlog</span><span class="p">(</span><span class="n">ML_ERROR</span><span class="p">,</span> <span class="s">&quot;orig args: lksb=%p, ast=%p, bast=%p, &quot;</span>
			     <span class="s">&quot;astdata=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">lksb</span><span class="p">,</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">ast</span><span class="p">,</span>
			     <span class="n">lock</span><span class="o">-&gt;</span><span class="n">bast</span><span class="p">,</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">astdata</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
<span class="nl">retry_convert:</span>
		<span class="n">dlm_wait_for_recovery</span><span class="p">(</span><span class="n">dlm</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">==</span> <span class="n">dlm</span><span class="o">-&gt;</span><span class="n">node_num</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">dlmconvert_master</span><span class="p">(</span><span class="n">dlm</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">dlmconvert_remote</span><span class="p">(</span><span class="n">dlm</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">DLM_RECOVERING</span> <span class="o">||</span> <span class="n">status</span> <span class="o">==</span> <span class="n">DLM_MIGRATING</span> <span class="o">||</span>
		    <span class="n">status</span> <span class="o">==</span> <span class="n">DLM_FORWARD</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* for now, see how this works without sleeping</span>
<span class="cm">			 * and just retry right away.  I suspect the reco</span>
<span class="cm">			 * or migration will complete fast enough that</span>
<span class="cm">			 * no waiting will be necessary */</span>
			<span class="n">mlog</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;retrying convert with migration/recovery/&quot;</span>
			     <span class="s">&quot;in-progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">retry_convert</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">tmpcookie</span><span class="p">;</span>

		<span class="cm">/* LOCK request */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">DLM_BADARGS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dlm_error</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">DLM_IVBUFLEN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">namelen</span> <span class="o">&gt;</span> <span class="n">DLM_LOCKID_NAME_MAX</span> <span class="o">||</span> <span class="n">namelen</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dlm_error</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dlm_get_next_cookie</span><span class="p">(</span><span class="n">dlm</span><span class="o">-&gt;</span><span class="n">node_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmpcookie</span><span class="p">);</span>
		<span class="n">lock</span> <span class="o">=</span> <span class="n">dlm_new_lock</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">dlm</span><span class="o">-&gt;</span><span class="n">node_num</span><span class="p">,</span> <span class="n">tmpcookie</span><span class="p">,</span> <span class="n">lksb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dlm_error</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">recovery</span><span class="p">)</span>
			<span class="n">dlm_wait_for_recovery</span><span class="p">(</span><span class="n">dlm</span><span class="p">);</span>

		<span class="cm">/* find or create the lock resource */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">dlm_get_lock_resource</span><span class="p">(</span><span class="n">dlm</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">DLM_IVLOCKID</span><span class="p">;</span>
			<span class="n">dlm_error</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mlog</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;type=%d, flags = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">mlog</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;creating lock: lock=%p res=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

		<span class="n">dlm_lock_attach_lockres</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="n">lock</span><span class="o">-&gt;</span><span class="n">ast</span> <span class="o">=</span> <span class="n">ast</span><span class="p">;</span>
		<span class="n">lock</span><span class="o">-&gt;</span><span class="n">bast</span> <span class="o">=</span> <span class="n">bast</span><span class="p">;</span>
		<span class="n">lock</span><span class="o">-&gt;</span><span class="n">astdata</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

<span class="nl">retry_lock:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LKM_VALBLK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mlog</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;LKM_VALBLK passed by caller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="cm">/* LVB requests for non PR, PW or EX locks are</span>
<span class="cm">			 * ignored. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&lt;</span> <span class="n">LKM_PRMODE</span><span class="p">)</span>
				<span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LKM_VALBLK</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">flags</span> <span class="o">|=</span> <span class="n">LKM_GET_LVB</span><span class="p">;</span>
				<span class="n">lock</span><span class="o">-&gt;</span><span class="n">lksb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DLM_LKSB_GET_LVB</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">==</span> <span class="n">dlm</span><span class="o">-&gt;</span><span class="n">node_num</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">dlmlock_master</span><span class="p">(</span><span class="n">dlm</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">dlmlock_remote</span><span class="p">(</span><span class="n">dlm</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">DLM_RECOVERING</span> <span class="o">||</span> <span class="n">status</span> <span class="o">==</span> <span class="n">DLM_MIGRATING</span> <span class="o">||</span>
		    <span class="n">status</span> <span class="o">==</span> <span class="n">DLM_FORWARD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">recovery</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">DLM_RECOVERING</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">retry_lock</span><span class="p">;</span>
				<span class="cm">/* wait to see the node go down, then</span>
<span class="cm">				 * drop down and allow the lockres to</span>
<span class="cm">				 * get cleaned up.  need to remaster. */</span>
				<span class="n">dlm_wait_for_node_death</span><span class="p">(</span><span class="n">dlm</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">,</span>
						<span class="n">DLM_NODE_DEATH_WAIT_MAX</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dlm_wait_for_recovery</span><span class="p">(</span><span class="n">dlm</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">retry_lock</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Inflight taken in dlm_get_lock_resource() is dropped here */</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>
		<span class="n">dlm_lockres_drop_inflight_ref</span><span class="p">(</span><span class="n">dlm</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>

		<span class="n">dlm_lockres_calc_usage</span><span class="p">(</span><span class="n">dlm</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="n">dlm_kick_thread</span><span class="p">(</span><span class="n">dlm</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">DLM_NORMAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lock</span><span class="o">-&gt;</span><span class="n">lksb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DLM_LKSB_GET_LVB</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">DLM_NOTQUEUED</span><span class="p">)</span>
				<span class="n">dlm_error</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">DLM_NORMAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">convert</span><span class="p">)</span>
			<span class="n">dlm_lock_put</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>this is kind of unnecessary</p></td><td class="code"><div class="highlight"><pre>		<span class="n">lksb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* put lockres ref from the convert path</span>
<span class="cm">	 * or from dlm_get_lock_resource */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">dlm_lockres_put</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">dlmlock</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
