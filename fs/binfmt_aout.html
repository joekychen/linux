<!DOCTYPE html>
<html><head><title>joekychen/linux » fs › binfmt_aout.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../index.html"></a><h1>binfmt_aout.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/fs/binfmt_aout.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1991, 1992, 1996  Linus Torvalds</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/mman.h&gt;</span>
<span class="cp">#include &lt;linux/a.out.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/file.h&gt;</span>
<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/user.h&gt;</span>
<span class="cp">#include &lt;linux/binfmts.h&gt;</span>
<span class="cp">#include &lt;linux/personality.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/coredump.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/cacheflush.h&gt;</span>
<span class="cp">#include &lt;asm/a.out-core.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">load_aout_binary</span><span class="p">(</span><span class="k">struct</span> <span class="n">linux_binprm</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span> <span class="n">regs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">load_aout_library</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span><span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aout_core_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">coredump_params</span> <span class="o">*</span><span class="n">cprm</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">linux_binfmt</span> <span class="n">aout_format</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">load_binary</span>	<span class="o">=</span> <span class="n">load_aout_binary</span><span class="p">,</span>
	<span class="p">.</span><span class="n">load_shlib</span>	<span class="o">=</span> <span class="n">load_aout_library</span><span class="p">,</span>
	<span class="p">.</span><span class="n">core_dump</span>	<span class="o">=</span> <span class="n">aout_core_dump</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min_coredump</span>	<span class="o">=</span> <span class="n">PAGE_SIZE</span>
<span class="p">};</span>

<span class="cp">#define BAD_ADDR(x)	((unsigned long)(x) &gt;= TASK_SIZE)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_brk</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">end</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">vm_brk</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BAD_ADDR</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Routine writes a core dump image in the current directory.</span>
<span class="cm"> * Currently only a stub-function.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that setuid/setgid files won&#39;t make a core-dump if the uid/gid</span>
<span class="cm"> * changed due to the set[u|g]id. It&#39;s enforced by the &quot;current-&gt;mm-&gt;dumpable&quot;</span>
<span class="cm"> * field, which also makes sure the core-dumps won&#39;t be recursive if the</span>
<span class="cm"> * dumping of the process results in another error..</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">aout_core_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">coredump_params</span> <span class="o">*</span><span class="n">cprm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="n">cprm</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">fs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">has_dumped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">dump_start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dump_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">user</span> <span class="n">dump</span><span class="p">;</span>
<span class="cp">#ifdef __alpha__</span>
<span class="cp">#       define START_DATA(u)	((void __user *)u.start_data)</span>
<span class="cp">#else</span>
<span class="cp">#	define START_DATA(u)	((void __user *)((u.u_tsize &lt;&lt; PAGE_SHIFT) + \</span>
<span class="cp">				 u.start_code))</span>
<span class="cp">#endif</span>
<span class="cp">#       define START_STACK(u)   ((void __user *)u.start_stack)</span>

	<span class="n">fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">has_dumped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">PF_DUMPCORE</span><span class="p">;</span>
       	<span class="n">strncpy</span><span class="p">(</span><span class="n">dump</span><span class="p">.</span><span class="n">u_comm</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dump</span><span class="p">.</span><span class="n">u_comm</span><span class="p">));</span>
	<span class="n">dump</span><span class="p">.</span><span class="n">u_ar0</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">user</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="n">dump</span><span class="p">.</span><span class="n">signal</span> <span class="o">=</span> <span class="n">cprm</span><span class="o">-&gt;</span><span class="n">signr</span><span class="p">;</span>
	<span class="n">aout_dump_thread</span><span class="p">(</span><span class="n">cprm</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dump</span><span class="p">);</span>

<span class="cm">/* If the size of the dump file exceeds the rlimit, then see what would happen</span>
<span class="cm">   if we wrote the stack, but not the data area.  */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dump</span><span class="p">.</span><span class="n">u_dsize</span> <span class="o">+</span> <span class="n">dump</span><span class="p">.</span><span class="n">u_ssize</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span> <span class="o">&gt;</span> <span class="n">cprm</span><span class="o">-&gt;</span><span class="n">limit</span><span class="p">)</span>
		<span class="n">dump</span><span class="p">.</span><span class="n">u_dsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* Make sure we have enough room to write the stack and data areas. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dump</span><span class="p">.</span><span class="n">u_ssize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span> <span class="o">&gt;</span> <span class="n">cprm</span><span class="o">-&gt;</span><span class="n">limit</span><span class="p">)</span>
		<span class="n">dump</span><span class="p">.</span><span class="n">u_ssize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* make sure we actually have a data and stack area to dump */</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">USER_DS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">START_DATA</span><span class="p">(</span><span class="n">dump</span><span class="p">),</span> <span class="n">dump</span><span class="p">.</span><span class="n">u_dsize</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">))</span>
		<span class="n">dump</span><span class="p">.</span><span class="n">u_dsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">START_STACK</span><span class="p">(</span><span class="n">dump</span><span class="p">),</span> <span class="n">dump</span><span class="p">.</span><span class="n">u_ssize</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">))</span>
		<span class="n">dump</span><span class="p">.</span><span class="n">u_ssize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
<span class="cm">/* struct user */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dump_write</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dump</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dump</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">end_coredump</span><span class="p">;</span>
<span class="cm">/* Now dump all of the user data.  Include malloced stuff as well */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dump_seek</span><span class="p">(</span><span class="n">cprm</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dump</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">end_coredump</span><span class="p">;</span>
<span class="cm">/* now we start writing out the user space info */</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">USER_DS</span><span class="p">);</span>
<span class="cm">/* Dump the data area */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dump</span><span class="p">.</span><span class="n">u_dsize</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dump_start</span> <span class="o">=</span> <span class="n">START_DATA</span><span class="p">(</span><span class="n">dump</span><span class="p">);</span>
		<span class="n">dump_size</span> <span class="o">=</span> <span class="n">dump</span><span class="p">.</span><span class="n">u_dsize</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dump_write</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dump_start</span><span class="p">,</span> <span class="n">dump_size</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">end_coredump</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cm">/* Now prepare to dump the stack area */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dump</span><span class="p">.</span><span class="n">u_ssize</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dump_start</span> <span class="o">=</span> <span class="n">START_STACK</span><span class="p">(</span><span class="n">dump</span><span class="p">);</span>
		<span class="n">dump_size</span> <span class="o">=</span> <span class="n">dump</span><span class="p">.</span><span class="n">u_ssize</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dump_write</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dump_start</span><span class="p">,</span> <span class="n">dump_size</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">end_coredump</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">end_coredump:</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">has_dumped</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * create_aout_tables() parses the env- and arg-strings in new user</span>
<span class="cm"> * memory and creates the pointer tables from them, and puts their</span>
<span class="cm"> * addresses on the &quot;stack&quot;, returning the new stack pointer value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="nf">create_aout_tables</span><span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">linux_binprm</span> <span class="o">*</span> <span class="n">bprm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argv</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">__user</span> <span class="o">*</span><span class="n">envp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">argc</span> <span class="o">=</span> <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">envc</span> <span class="o">=</span> <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">envc</span><span class="p">;</span>

	<span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)((</span><span class="o">-</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">p</span><span class="p">);</span>
<span class="cp">#ifdef __alpha__</span>
<span class="cm">/* whee.. test-programs are so much fun. */</span>
	<span class="n">put_user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">--</span><span class="n">sp</span><span class="p">);</span>
	<span class="n">put_user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">--</span><span class="n">sp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bprm</span><span class="o">-&gt;</span><span class="n">loader</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">--</span><span class="n">sp</span><span class="p">);</span>
		<span class="n">put_user</span><span class="p">(</span><span class="mi">1003</span><span class="p">,</span> <span class="o">--</span><span class="n">sp</span><span class="p">);</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">bprm</span><span class="o">-&gt;</span><span class="n">loader</span><span class="p">,</span> <span class="o">--</span><span class="n">sp</span><span class="p">);</span>
		<span class="n">put_user</span><span class="p">(</span><span class="mi">1002</span><span class="p">,</span> <span class="o">--</span><span class="n">sp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">put_user</span><span class="p">(</span><span class="n">bprm</span><span class="o">-&gt;</span><span class="n">exec</span><span class="p">,</span> <span class="o">--</span><span class="n">sp</span><span class="p">);</span>
	<span class="n">put_user</span><span class="p">(</span><span class="mi">1001</span><span class="p">,</span> <span class="o">--</span><span class="n">sp</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">sp</span> <span class="o">-=</span> <span class="n">envc</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">envp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">sp</span><span class="p">;</span>
	<span class="n">sp</span> <span class="o">-=</span> <span class="n">argc</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">argv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">sp</span><span class="p">;</span>
<span class="cp">#ifndef __alpha__</span>
	<span class="n">put_user</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">envp</span><span class="p">,</span><span class="o">--</span><span class="n">sp</span><span class="p">);</span>
	<span class="n">put_user</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">argv</span><span class="p">,</span><span class="o">--</span><span class="n">sp</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">put_user</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="o">--</span><span class="n">sp</span><span class="p">);</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">arg_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">argc</span><span class="o">--&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">argv</span><span class="o">++</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">get_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">++</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">put_user</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">arg_end</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">env_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">envc</span><span class="o">--&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">put_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">envp</span><span class="o">++</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">get_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">++</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">put_user</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="n">envp</span><span class="p">);</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">env_end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * These are the functions used to load a.out style executables and shared</span>
<span class="cm"> * libraries.  There is no binary dependent code anywhere else.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">load_aout_binary</span><span class="p">(</span><span class="k">struct</span> <span class="n">linux_binprm</span> <span class="o">*</span> <span class="n">bprm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span> <span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">exec</span> <span class="n">ex</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fd_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rlim</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">ex</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="k">struct</span> <span class="n">exec</span> <span class="o">*</span><span class="p">)</span> <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>		<span class="cm">/* exec-header */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">N_MAGIC</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ZMAGIC</span> <span class="o">&amp;&amp;</span> <span class="n">N_MAGIC</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span> <span class="o">!=</span> <span class="n">OMAGIC</span> <span class="o">&amp;&amp;</span>
	     <span class="n">N_MAGIC</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QMAGIC</span> <span class="o">&amp;&amp;</span> <span class="n">N_MAGIC</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NMAGIC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">N_TRSIZE</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span> <span class="o">||</span> <span class="n">N_DRSIZE</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">i_size_read</span><span class="p">(</span><span class="n">bprm</span><span class="o">-&gt;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_text</span><span class="o">+</span><span class="n">ex</span><span class="p">.</span><span class="n">a_data</span><span class="o">+</span><span class="n">N_SYMSIZE</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">+</span><span class="n">N_TXTOFF</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOEXEC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Requires a mmap handler. This prevents people from using a.out</span>
<span class="cm">	 * as part of an exploit attack against /proc-related vulnerabilities.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bprm</span><span class="o">-&gt;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span> <span class="o">||</span> <span class="o">!</span><span class="n">bprm</span><span class="o">-&gt;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOEXEC</span><span class="p">;</span>

	<span class="n">fd_offset</span> <span class="o">=</span> <span class="n">N_TXTOFF</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>

	<span class="cm">/* Check initial limits. This avoids letting people circumvent</span>
<span class="cm">	 * size limits imposed on them by creating programs with large</span>
<span class="cm">	 * arrays in the data or bss.</span>
<span class="cm">	 */</span>
	<span class="n">rlim</span> <span class="o">=</span> <span class="n">rlimit</span><span class="p">(</span><span class="n">RLIMIT_DATA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rlim</span> <span class="o">&gt;=</span> <span class="n">RLIM_INFINITY</span><span class="p">)</span>
		<span class="n">rlim</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">a_data</span> <span class="o">+</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_bss</span> <span class="o">&gt;</span> <span class="n">rlim</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Flush all traces of the currently running executable */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">flush_old_exec</span><span class="p">(</span><span class="n">bprm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* OK, This is the point of no return */</span>
<span class="cp">#ifdef __alpha__</span>
	<span class="n">SET_AOUT_PERSONALITY</span><span class="p">(</span><span class="n">bprm</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">set_personality</span><span class="p">(</span><span class="n">PER_LINUX</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">setup_new_exec</span><span class="p">(</span><span class="n">bprm</span><span class="p">);</span>

	<span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">end_code</span> <span class="o">=</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_text</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">start_code</span> <span class="o">=</span> <span class="n">N_TXTADDR</span><span class="p">(</span><span class="n">ex</span><span class="p">));</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">end_data</span> <span class="o">=</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_data</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">start_data</span> <span class="o">=</span> <span class="n">N_DATADDR</span><span class="p">(</span><span class="n">ex</span><span class="p">));</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">brk</span> <span class="o">=</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_bss</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">start_brk</span> <span class="o">=</span> <span class="n">N_BSSADDR</span><span class="p">(</span><span class="n">ex</span><span class="p">));</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">free_area_cache</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_base</span><span class="p">;</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">cached_hole_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">setup_arg_pages</span><span class="p">(</span><span class="n">bprm</span><span class="p">,</span> <span class="n">STACK_TOP</span><span class="p">,</span> <span class="n">EXSTACK_DEFAULT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Someone check-me: is this error path enough? */</span>
		<span class="n">send_sig</span><span class="p">(</span><span class="n">SIGKILL</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">install_exec_creds</span><span class="p">(</span><span class="n">bprm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">N_MAGIC</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span> <span class="o">==</span> <span class="n">OMAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">text_addr</span><span class="p">,</span> <span class="n">map_size</span><span class="p">;</span>
		<span class="n">loff_t</span> <span class="n">pos</span><span class="p">;</span>

		<span class="n">text_addr</span> <span class="o">=</span> <span class="n">N_TXTADDR</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>

<span class="cp">#ifdef __alpha__</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">fd_offset</span><span class="p">;</span>
		<span class="n">map_size</span> <span class="o">=</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_text</span><span class="o">+</span><span class="n">ex</span><span class="p">.</span><span class="n">a_data</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">map_size</span> <span class="o">=</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_text</span><span class="o">+</span><span class="n">ex</span><span class="p">.</span><span class="n">a_data</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">vm_brk</span><span class="p">(</span><span class="n">text_addr</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">,</span> <span class="n">map_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="p">(</span><span class="n">text_addr</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">send_sig</span><span class="p">(</span><span class="n">SIGKILL</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">bprm</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">text_addr</span><span class="p">,</span>
			  <span class="n">ex</span><span class="p">.</span><span class="n">a_text</span><span class="o">+</span><span class="n">ex</span><span class="p">.</span><span class="n">a_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">signed</span> <span class="kt">long</span><span class="p">)</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">send_sig</span><span class="p">(</span><span class="n">SIGKILL</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
			 
		<span class="n">flush_icache_range</span><span class="p">(</span><span class="n">text_addr</span><span class="p">,</span> <span class="n">text_addr</span><span class="o">+</span><span class="n">ex</span><span class="p">.</span><span class="n">a_text</span><span class="o">+</span><span class="n">ex</span><span class="p">.</span><span class="n">a_data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ex</span><span class="p">.</span><span class="n">a_text</span> <span class="o">&amp;</span> <span class="mh">0xfff</span> <span class="o">||</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_data</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">N_MAGIC</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NMAGIC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">printk_ratelimit</span><span class="p">())</span>
		<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;executable not page aligned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">fd_offset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">printk_ratelimit</span><span class="p">())</span>
		<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> 
			       <span class="s">&quot;fd_offset is not page aligned. Please convert program: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bprm</span><span class="o">-&gt;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="o">||</span><span class="p">((</span><span class="n">fd_offset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">loff_t</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">fd_offset</span><span class="p">;</span>
			<span class="n">vm_brk</span><span class="p">(</span><span class="n">N_TXTADDR</span><span class="p">(</span><span class="n">ex</span><span class="p">),</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_text</span><span class="o">+</span><span class="n">ex</span><span class="p">.</span><span class="n">a_data</span><span class="p">);</span>
			<span class="n">bprm</span><span class="o">-&gt;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">bprm</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">N_TXTADDR</span><span class="p">(</span><span class="n">ex</span><span class="p">),</span>
					<span class="n">ex</span><span class="p">.</span><span class="n">a_text</span><span class="o">+</span><span class="n">ex</span><span class="p">.</span><span class="n">a_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>
			<span class="n">flush_icache_range</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">N_TXTADDR</span><span class="p">(</span><span class="n">ex</span><span class="p">),</span>
					   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">N_TXTADDR</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span> <span class="o">+</span>
					   <span class="n">ex</span><span class="p">.</span><span class="n">a_text</span><span class="o">+</span><span class="n">ex</span><span class="p">.</span><span class="n">a_data</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">beyond_if</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">vm_mmap</span><span class="p">(</span><span class="n">bprm</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">,</span> <span class="n">N_TXTADDR</span><span class="p">(</span><span class="n">ex</span><span class="p">),</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_text</span><span class="p">,</span>
			<span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_EXEC</span><span class="p">,</span>
			<span class="n">MAP_FIXED</span> <span class="o">|</span> <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_DENYWRITE</span> <span class="o">|</span> <span class="n">MAP_EXECUTABLE</span><span class="p">,</span>
			<span class="n">fd_offset</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="n">N_TXTADDR</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">send_sig</span><span class="p">(</span><span class="n">SIGKILL</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">vm_mmap</span><span class="p">(</span><span class="n">bprm</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">,</span> <span class="n">N_DATADDR</span><span class="p">(</span><span class="n">ex</span><span class="p">),</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_data</span><span class="p">,</span>
				<span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span> <span class="o">|</span> <span class="n">PROT_EXEC</span><span class="p">,</span>
				<span class="n">MAP_FIXED</span> <span class="o">|</span> <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_DENYWRITE</span> <span class="o">|</span> <span class="n">MAP_EXECUTABLE</span><span class="p">,</span>
				<span class="n">fd_offset</span> <span class="o">+</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_text</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="n">N_DATADDR</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">send_sig</span><span class="p">(</span><span class="n">SIGKILL</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">beyond_if:</span>
	<span class="n">set_binfmt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aout_format</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">set_brk</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">start_brk</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">brk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">send_sig</span><span class="p">(</span><span class="n">SIGKILL</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">start_stack</span> <span class="o">=</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">create_aout_tables</span><span class="p">((</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">,</span> <span class="n">bprm</span><span class="p">);</span>
<span class="cp">#ifdef __alpha__</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gp</span> <span class="o">=</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_gpvalue</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">start_thread</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_entry</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">start_stack</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">load_aout_library</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span> <span class="n">inode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bss</span><span class="p">,</span> <span class="n">start_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exec</span> <span class="n">ex</span><span class="p">;</span>

	<span class="n">inode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOEXEC</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">kernel_read</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ex</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ex</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* We come in here for the regular a.out style of shared libraries */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">N_MAGIC</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ZMAGIC</span> <span class="o">&amp;&amp;</span> <span class="n">N_MAGIC</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span> <span class="o">!=</span> <span class="n">QMAGIC</span><span class="p">)</span> <span class="o">||</span> <span class="n">N_TRSIZE</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">N_DRSIZE</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">ex</span><span class="p">.</span><span class="n">a_entry</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">N_MAGIC</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span> <span class="o">==</span> <span class="n">ZMAGIC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">i_size_read</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_text</span><span class="o">+</span><span class="n">ex</span><span class="p">.</span><span class="n">a_data</span><span class="o">+</span><span class="n">N_SYMSIZE</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">+</span><span class="n">N_TXTOFF</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Requires a mmap handler. This prevents people from using a.out</span>
<span class="cm">	 * as part of an exploit attack against /proc-related vulnerabilities.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span> <span class="o">||</span> <span class="o">!</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">N_FLAGS</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* For  QMAGIC, the starting address is 0x20 into the page.  We mask</span>
<span class="cm">	   this off to get the starting address for the page */</span>

	<span class="n">start_addr</span> <span class="o">=</span>  <span class="n">ex</span><span class="p">.</span><span class="n">a_entry</span> <span class="o">&amp;</span> <span class="mh">0xfffff000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">N_TXTOFF</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">loff_t</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">N_TXTOFF</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
		<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> 
			       <span class="s">&quot;N_TXTOFF is not page aligned. Please convert library: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">vm_brk</span><span class="p">(</span><span class="n">start_addr</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_text</span> <span class="o">+</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_data</span> <span class="o">+</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_bss</span><span class="p">);</span>
		
		<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">start_addr</span><span class="p">,</span>
			<span class="n">ex</span><span class="p">.</span><span class="n">a_text</span> <span class="o">+</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>
		<span class="n">flush_icache_range</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">start_addr</span><span class="p">,</span>
				   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">start_addr</span> <span class="o">+</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_text</span> <span class="o">+</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_data</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Now use mmap to map the library into memory. */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">vm_mmap</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">start_addr</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_text</span> <span class="o">+</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_data</span><span class="p">,</span>
			<span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span> <span class="o">|</span> <span class="n">PROT_EXEC</span><span class="p">,</span>
			<span class="n">MAP_FIXED</span> <span class="o">|</span> <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_DENYWRITE</span><span class="p">,</span>
			<span class="n">N_TXTOFF</span><span class="p">(</span><span class="n">ex</span><span class="p">));</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="n">start_addr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">a_text</span> <span class="o">+</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_data</span><span class="p">);</span>
	<span class="n">bss</span> <span class="o">=</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_text</span> <span class="o">+</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_data</span> <span class="o">+</span> <span class="n">ex</span><span class="p">.</span><span class="n">a_bss</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bss</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">vm_brk</span><span class="p">(</span><span class="n">start_addr</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">bss</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="n">start_addr</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_aout_binfmt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">register_binfmt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aout_format</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exit_aout_binfmt</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_binfmt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aout_format</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">core_initcall</span><span class="p">(</span><span class="n">init_aout_binfmt</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_aout_binfmt</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:1}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../javascript/docco.min.js"></script>
</html>
