<!DOCTYPE html>
<html><head><title>joekychen/linux » Documentation › networking › ifenslave.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ifenslave.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Mode: C;</span>
<span class="cm"> * ifenslave.c: Configure network interfaces for parallel routing.</span>
<span class="cm"> *</span>
<span class="cm"> *	This program controls the Linux implementation of running multiple</span>
<span class="cm"> *	network interfaces in parallel.</span>
<span class="cm"> *</span>
<span class="cm"> * Author:	Donald Becker &lt;becker@cesdis.gsfc.nasa.gov&gt;</span>
<span class="cm"> *		Copyright 1994-1996 Donald Becker</span>
<span class="cm"> *</span>
<span class="cm"> *		This program is free software; you can redistribute it</span>
<span class="cm"> *		and/or modify it under the terms of the GNU General Public</span>
<span class="cm"> *		License as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> *	The author may be reached as becker@CESDIS.gsfc.nasa.gov, or C/O</span>
<span class="cm"> *	Center of Excellence in Space Data and Information Sciences</span>
<span class="cm"> *	   Code 930.5, Goddard Space Flight Center, Greenbelt MD 20771</span>
<span class="cm"> *</span>
<span class="cm"> *  Changes :</span>
<span class="cm"> *    - 2000/10/02 Willy Tarreau &lt;willy at meta-x.org&gt; :</span>
<span class="cm"> *       - few fixes. Master&#39;s MAC address is now correctly taken from</span>
<span class="cm"> *         the first device when not previously set ;</span>
<span class="cm"> *       - detach support : call BOND_RELEASE to detach an enslaved interface.</span>
<span class="cm"> *       - give a mini-howto from command-line help : # ifenslave -h</span>
<span class="cm"> *</span>
<span class="cm"> *    - 2001/02/16 Chad N. Tindel &lt;ctindel at ieee dot org&gt; :</span>
<span class="cm"> *       - Master is now brought down before setting the MAC address.  In</span>
<span class="cm"> *         the 2.4 kernel you can&#39;t change the MAC address while the device is</span>
<span class="cm"> *         up because you get EBUSY.</span>
<span class="cm"> *</span>
<span class="cm"> *    - 2001/09/13 Takao Indoh &lt;indou dot takao at jp dot fujitsu dot com&gt;</span>
<span class="cm"> *       - Added the ability to change the active interface on a mode 1 bond</span>
<span class="cm"> *         at runtime.</span>
<span class="cm"> *</span>
<span class="cm"> *    - 2001/10/23 Chad N. Tindel &lt;ctindel at ieee dot org&gt; :</span>
<span class="cm"> *       - No longer set the MAC address of the master.  The bond device will</span>
<span class="cm"> *         take care of this itself</span>
<span class="cm"> *       - Try the SIOC*** versions of the bonding ioctls before using the</span>
<span class="cm"> *         old versions</span>
<span class="cm"> *    - 2002/02/18 Erik Habbinga &lt;erik_habbinga @ hp dot com&gt; :</span>
<span class="cm"> *       - ifr2.ifr_flags was not initialized in the hwaddr_notset case,</span>
<span class="cm"> *         SIOCGIFFLAGS now called before hwaddr_notset test</span>
<span class="cm"> *</span>
<span class="cm"> *    - 2002/10/31 Tony Cureington &lt;tony.cureington * hp_com&gt; :</span>
<span class="cm"> *       - If the master does not have a hardware address when the first slave</span>
<span class="cm"> *         is enslaved, the master is assigned the hardware address of that</span>
<span class="cm"> *         slave - there is a comment in bonding.c stating &quot;ifenslave takes</span>
<span class="cm"> *         care of this now.&quot; This corrects the problem of slaves having</span>
<span class="cm"> *         different hardware addresses in active-backup mode when</span>
<span class="cm"> *         multiple interfaces are specified on a single ifenslave command</span>
<span class="cm"> *         (ifenslave bond0 eth0 eth1).</span>
<span class="cm"> *</span>
<span class="cm"> *    - 2003/03/18 - Tsippy Mendelson &lt;tsippy.mendelson at intel dot com&gt; and</span>
<span class="cm"> *                   Shmulik Hen &lt;shmulik.hen at intel dot com&gt;</span>
<span class="cm"> *       - Moved setting the slave&#39;s mac address and openning it, from</span>
<span class="cm"> *         the application to the driver. This enables support of modes</span>
<span class="cm"> *         that need to use the unique mac address of each slave.</span>
<span class="cm"> *         The driver also takes care of closing the slave and restoring its</span>
<span class="cm"> *         original mac address upon release.</span>
<span class="cm"> *         In addition, block possibility of enslaving before the master is up.</span>
<span class="cm"> *         This prevents putting the system in an undefined state.</span>
<span class="cm"> *</span>
<span class="cm"> *    - 2003/05/01 - Amir Noam &lt;amir.noam at intel dot com&gt;</span>
<span class="cm"> *       - Added ABI version control to restore compatibility between</span>
<span class="cm"> *         new/old ifenslave and new/old bonding.</span>
<span class="cm"> *       - Prevent adding an adapter that is already a slave.</span>
<span class="cm"> *         Fixes the problem of stalling the transmission and leaving</span>
<span class="cm"> *         the slave in a down state.</span>
<span class="cm"> *</span>
<span class="cm"> *    - 2003/05/01 - Shmulik Hen &lt;shmulik.hen at intel dot com&gt;</span>
<span class="cm"> *       - Prevent enslaving if the bond device is down.</span>
<span class="cm"> *         Fixes the problem of leaving the system in unstable state and</span>
<span class="cm"> *         halting when trying to remove the module.</span>
<span class="cm"> *       - Close socket on all abnormal exists.</span>
<span class="cm"> *       - Add versioning scheme that follows that of the bonding driver.</span>
<span class="cm"> *         current version is 1.0.0 as a base line.</span>
<span class="cm"> *</span>
<span class="cm"> *    - 2003/05/22 - Jay Vosburgh &lt;fubar at us dot ibm dot com&gt;</span>
<span class="cm"> *	 - ifenslave -c was broken; it&#39;s now fixed</span>
<span class="cm"> *	 - Fixed problem with routes vanishing from master during enslave</span>
<span class="cm"> *	   processing.</span>
<span class="cm"> *</span>
<span class="cm"> *    - 2003/05/27 - Amir Noam &lt;amir.noam at intel dot com&gt;</span>
<span class="cm"> *	 - Fix backward compatibility issues:</span>
<span class="cm"> *	   For drivers not using ABI versions, slave was set down while</span>
<span class="cm"> *	   it should be left up before enslaving.</span>
<span class="cm"> *	   Also, master was not set down and the default set_mac_address()</span>
<span class="cm"> *	   would fail and generate an error message in the system log.</span>
<span class="cm"> * 	 - For opt_c: slave should not be set to the master&#39;s setting</span>
<span class="cm"> *	   while it is running. It was already set during enslave. To</span>
<span class="cm"> *	   simplify things, it is now handled separately.</span>
<span class="cm"> *</span>
<span class="cm"> *    - 2003/12/01 - Shmulik Hen &lt;shmulik.hen at intel dot com&gt;</span>
<span class="cm"> *	 - Code cleanup and style changes</span>
<span class="cm"> *	   set version to 1.1.0</span>
<span class="cm"> */</span>

<span class="cp">#define APP_VERSION	&quot;1.1.0&quot;</span>
<span class="cp">#define APP_RELDATE	&quot;December 1, 2003&quot;</span>
<span class="cp">#define APP_NAME	&quot;ifenslave&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">version</span> <span class="o">=</span>
<span class="n">APP_NAME</span> <span class="s">&quot;.c:v&quot;</span> <span class="n">APP_VERSION</span> <span class="s">&quot; (&quot;</span> <span class="n">APP_RELDATE</span> <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;o Donald Becker (becker@cesdis.gsfc.nasa.gov).</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;o Detach support added on 2000/10/02 by Willy Tarreau (willy at meta-x.org).</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;o 2.4 kernel support added on 2001/02/16 by Chad N. Tindel</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  (ctindel at ieee dot org).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">usage_msg</span> <span class="o">=</span>
<span class="s">&quot;Usage: ifenslave [-f] &lt;master-if&gt; &lt;slave-if&gt; [&lt;slave-if&gt;...]</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;       ifenslave -d   &lt;master-if&gt; &lt;slave-if&gt; [&lt;slave-if&gt;...]</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;       ifenslave -c   &lt;master-if&gt; &lt;slave-if&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;       ifenslave --help</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">help_msg</span> <span class="o">=</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;       To create a bond device, simply follow these three steps :</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;       - ensure that the required drivers are properly loaded :</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;         # modprobe bonding ; modprobe &lt;3c59x|eepro100|pcnet32|tulip|...&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;       - assign an IP address to the bond device :</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;         # ifconfig bond0 &lt;addr&gt; netmask &lt;mask&gt; broadcast &lt;bcast&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;       - attach all the interfaces you need to the bond device :</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;         # ifenslave [{-f|--force}] bond0 eth0 [eth1 [eth2]...]</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;         If bond0 didn&#39;t have a MAC address, it will take eth0&#39;s. Then, all</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;         interfaces attached AFTER this assignment will get the same MAC addr.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;         (except for ALB/TLB modes)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;       To set the bond device down and automatically release all the slaves :</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;         # ifconfig bond0 down</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;       To detach a dead interface without setting the bond device down :</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;         # ifenslave {-d|--detach} bond0 eth0 [eth1 [eth2]...]</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;       To change active slave :</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;         # ifenslave {-c|--change-active} bond0 eth0</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;       To show master interface info</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;         # ifenslave bond0</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;       To show all interfaces info</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;       # ifenslave {-a|--all-interfaces}</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;       To be more verbose</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;       # ifenslave {-v|--verbose} ...</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;       # ifenslave {-u|--usage}   Show usage</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;       # ifenslave {-V|--version} Show version</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;       # ifenslave {-h|--help}    This message</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;ctype.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;errno.h&gt;</span>
<span class="cp">#include &lt;fcntl.h&gt;</span>
<span class="cp">#include &lt;getopt.h&gt;</span>
<span class="cp">#include &lt;sys/types.h&gt;</span>
<span class="cp">#include &lt;sys/socket.h&gt;</span>
<span class="cp">#include &lt;sys/ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/if.h&gt;</span>
<span class="cp">#include &lt;net/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;linux/if_bonding.h&gt;</span>
<span class="cp">#include &lt;linux/sockios.h&gt;</span>

<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">u64</span><span class="p">;</span>	<span class="cm">/* hack, so we may include kernel&#39;s ethtool.h */</span>
<span class="k">typedef</span> <span class="n">__uint32_t</span> <span class="n">u32</span><span class="p">;</span>		<span class="cm">/* ditto */</span>
<span class="k">typedef</span> <span class="n">__uint16_t</span> <span class="n">u16</span><span class="p">;</span>		<span class="cm">/* ditto */</span>
<span class="k">typedef</span> <span class="n">__uint8_t</span> <span class="n">u8</span><span class="p">;</span>		<span class="cm">/* ditto */</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>

<span class="k">struct</span> <span class="n">option</span> <span class="n">longopts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* { name  has_arg  *flag  val } */</span>
	<span class="p">{</span><span class="s">&quot;all-interfaces&quot;</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">},</span>	<span class="cm">/* Show all interfaces. */</span>
	<span class="p">{</span><span class="s">&quot;change-active&quot;</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;c&#39;</span><span class="p">},</span>	<span class="cm">/* Change the active slave.  */</span>
	<span class="p">{</span><span class="s">&quot;detach&quot;</span><span class="p">,</span>		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;d&#39;</span><span class="p">},</span>	<span class="cm">/* Detach a slave interface. */</span>
	<span class="p">{</span><span class="s">&quot;force&quot;</span><span class="p">,</span>		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;f&#39;</span><span class="p">},</span>	<span class="cm">/* Force the operation. */</span>
	<span class="p">{</span><span class="s">&quot;help&quot;</span><span class="p">,</span>		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;h&#39;</span><span class="p">},</span>	<span class="cm">/* Give help */</span>
	<span class="p">{</span><span class="s">&quot;usage&quot;</span><span class="p">,</span>		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;u&#39;</span><span class="p">},</span>	<span class="cm">/* Give usage */</span>
	<span class="p">{</span><span class="s">&quot;verbose&quot;</span><span class="p">,</span>		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;v&#39;</span><span class="p">},</span>	<span class="cm">/* Report each action taken. */</span>
	<span class="p">{</span><span class="s">&quot;version&quot;</span><span class="p">,</span>		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;V&#39;</span><span class="p">},</span>	<span class="cm">/* Emit version information. */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Command-line flags. */</span>
<span class="kt">unsigned</span> <span class="kt">int</span>
<span class="n">opt_a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* Show-all-interfaces flag. */</span>
<span class="n">opt_c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* Change-active-slave flag. */</span>
<span class="n">opt_d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* Detach a slave interface. */</span>
<span class="n">opt_f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* Force the operation. */</span>
<span class="n">opt_h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* Help */</span>
<span class="n">opt_u</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* Usage */</span>
<span class="n">opt_v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* Verbose flag. */</span>
<span class="n">opt_V</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Version */</span>

<span class="kt">int</span> <span class="n">skfd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* AF_INET socket for ioctl() calls.*/</span>
<span class="kt">int</span> <span class="n">abi_ver</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* userland - kernel ABI version */</span>
<span class="kt">int</span> <span class="n">hwaddr_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Master&#39;s hwaddr is set */</span>
<span class="kt">int</span> <span class="n">saved_errno</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ifreq</span> <span class="n">master_mtu</span><span class="p">,</span> <span class="n">master_flags</span><span class="p">,</span> <span class="n">master_hwaddr</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">ifreq</span> <span class="n">slave_mtu</span><span class="p">,</span> <span class="n">slave_flags</span><span class="p">,</span> <span class="n">slave_hwaddr</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">dev_ifr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">req_ifr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">req_name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">req_type</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dev_ifr</span> <span class="n">master_ifra</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="o">&amp;</span><span class="n">master_mtu</span><span class="p">,</span>     <span class="s">&quot;SIOCGIFMTU&quot;</span><span class="p">,</span>     <span class="n">SIOCGIFMTU</span><span class="p">},</span>
	<span class="p">{</span><span class="o">&amp;</span><span class="n">master_flags</span><span class="p">,</span>   <span class="s">&quot;SIOCGIFFLAGS&quot;</span><span class="p">,</span>   <span class="n">SIOCGIFFLAGS</span><span class="p">},</span>
	<span class="p">{</span><span class="o">&amp;</span><span class="n">master_hwaddr</span><span class="p">,</span>  <span class="s">&quot;SIOCGIFHWADDR&quot;</span><span class="p">,</span>  <span class="n">SIOCGIFHWADDR</span><span class="p">},</span>
	<span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dev_ifr</span> <span class="n">slave_ifra</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="o">&amp;</span><span class="n">slave_mtu</span><span class="p">,</span>     <span class="s">&quot;SIOCGIFMTU&quot;</span><span class="p">,</span>     <span class="n">SIOCGIFMTU</span><span class="p">},</span>
	<span class="p">{</span><span class="o">&amp;</span><span class="n">slave_flags</span><span class="p">,</span>   <span class="s">&quot;SIOCGIFFLAGS&quot;</span><span class="p">,</span>   <span class="n">SIOCGIFFLAGS</span><span class="p">},</span>
	<span class="p">{</span><span class="o">&amp;</span><span class="n">slave_hwaddr</span><span class="p">,</span>  <span class="s">&quot;SIOCGIFHWADDR&quot;</span><span class="p">,</span>  <span class="n">SIOCGIFHWADDR</span><span class="p">},</span>
	<span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">if_print</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">get_drv_info</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">master_ifname</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">get_if_settings</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dev_ifr</span> <span class="n">ifra</span><span class="p">[]);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">get_slave_flags</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">slave_ifname</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_master_hwaddr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">master_ifname</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">hwaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_slave_hwaddr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">slave_ifname</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">hwaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_slave_mtu</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">slave_ifname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mtu</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_if_flags</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">,</span> <span class="kt">short</span> <span class="n">flags</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_if_up</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">,</span> <span class="kt">short</span> <span class="n">flags</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_if_down</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">,</span> <span class="kt">short</span> <span class="n">flags</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">clear_if_addr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_if_addr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">master_ifname</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">slave_ifname</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">change_active</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">master_ifname</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">slave_ifname</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">enslave</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">master_ifname</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">slave_ifname</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">release</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">master_ifname</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">slave_ifname</span><span class="p">);</span>
<span class="cp">#define v_print(fmt, args...)	\</span>
<span class="cp">	if (opt_v)		\</span>
<span class="cp">		fprintf(stderr, fmt, ## args )</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">spp</span><span class="p">,</span> <span class="o">*</span><span class="n">master_ifname</span><span class="p">,</span> <span class="o">*</span><span class="n">slave_ifname</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">exclusive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">c</span> <span class="o">=</span> <span class="n">getopt_long</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="s">&quot;acdfhuvV&quot;</span><span class="p">,</span> <span class="n">longopts</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">!=</span> <span class="n">EOF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;a&#39;</span>: <span class="n">opt_a</span><span class="o">++</span><span class="p">;</span> <span class="n">exclusive</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;c&#39;</span>: <span class="n">opt_c</span><span class="o">++</span><span class="p">;</span> <span class="n">exclusive</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;d&#39;</span>: <span class="n">opt_d</span><span class="o">++</span><span class="p">;</span> <span class="n">exclusive</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;f&#39;</span>: <span class="n">opt_f</span><span class="o">++</span><span class="p">;</span> <span class="n">exclusive</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;h&#39;</span>: <span class="n">opt_h</span><span class="o">++</span><span class="p">;</span> <span class="n">exclusive</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;u&#39;</span>: <span class="n">opt_u</span><span class="o">++</span><span class="p">;</span> <span class="n">exclusive</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;v&#39;</span>: <span class="n">opt_v</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;V&#39;</span>: <span class="n">opt_V</span><span class="o">++</span><span class="p">;</span> <span class="n">exclusive</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">usage_msg</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* options check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">exclusive</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">usage_msg</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opt_v</span> <span class="o">||</span> <span class="n">opt_V</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opt_V</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opt_u</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">usage_msg</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opt_h</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">usage_msg</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">help_msg</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Open a basic socket */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">skfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">&quot;socket&quot;</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opt_a</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">optind</span> <span class="o">==</span> <span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* No remaining args */</span>
			<span class="cm">/* show all interfaces */</span>
			<span class="n">if_print</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Just show usage */</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">usage_msg</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Copy the interface name */</span>
	<span class="n">spp</span> <span class="o">=</span> <span class="n">argv</span> <span class="o">+</span> <span class="n">optind</span><span class="p">;</span>
	<span class="n">master_ifname</span> <span class="o">=</span> <span class="o">*</span><span class="n">spp</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">master_ifname</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">usage_msg</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* exchange abi version with bonding module */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">get_drv_info</span><span class="p">(</span><span class="n">master_ifname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
			<span class="s">&quot;Master &#39;%s&#39;: Error: handshake with driver failed. &quot;</span>
			<span class="s">&quot;Aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">master_ifname</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">slave_ifname</span> <span class="o">=</span> <span class="o">*</span><span class="n">spp</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slave_ifname</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opt_d</span> <span class="o">||</span> <span class="n">opt_c</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">usage_msg</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* A single arg means show the</span>
<span class="cm">		 * configuration for this interface</span>
<span class="cm">		 */</span>
		<span class="n">if_print</span><span class="p">(</span><span class="n">master_ifname</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">get_if_settings</span><span class="p">(</span><span class="n">master_ifname</span><span class="p">,</span> <span class="n">master_ifra</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Probably a good reason not to go on */</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
			<span class="s">&quot;Master &#39;%s&#39;: Error: get settings failed: %s. &quot;</span>
			<span class="s">&quot;Aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">master_ifname</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check if master is indeed a master;</span>
<span class="cm">	 * if not then fail any operation</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">master_flags</span><span class="p">.</span><span class="n">ifr_flags</span> <span class="o">&amp;</span> <span class="n">IFF_MASTER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
			<span class="s">&quot;Illegal operation; the specified interface &#39;%s&#39; &quot;</span>
			<span class="s">&quot;is not a master. Aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">master_ifname</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check if master is up; if not then fail any operation */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">master_flags</span><span class="p">.</span><span class="n">ifr_flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
			<span class="s">&quot;Illegal operation; the specified master interface &quot;</span>
			<span class="s">&quot;&#39;%s&#39; is not up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">master_ifname</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Only for enslaving */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">opt_c</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">opt_d</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sa_family_t</span> <span class="n">master_family</span> <span class="o">=</span> <span class="n">master_hwaddr</span><span class="p">.</span><span class="n">ifr_hwaddr</span><span class="p">.</span><span class="n">sa_family</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hwaddr</span> <span class="o">=</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">master_hwaddr</span><span class="p">.</span><span class="n">ifr_hwaddr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">;</span>

		<span class="cm">/* The family &#39;1&#39; is ARPHRD_ETHER for ethernet. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">master_family</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">opt_f</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
				<span class="s">&quot;Illegal operation: The specified master &quot;</span>
				<span class="s">&quot;interface &#39;%s&#39; is not ethernet-like.</span><span class="se">\n</span><span class="s"> &quot;</span>
				<span class="s">&quot;This program is designed to work with &quot;</span>
				<span class="s">&quot;ethernet-like network interfaces.</span><span class="se">\n</span><span class="s"> &quot;</span>
				<span class="s">&quot;Use the &#39;-f&#39; option to force the &quot;</span>
				<span class="s">&quot;operation.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">master_ifname</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check master&#39;s hw addr */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hwaddr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hwaddr_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hwaddr_set</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">v_print</span><span class="p">(</span><span class="s">&quot;current hardware address of master &#39;%s&#39; &quot;</span>
				<span class="s">&quot;is %2.2x:%2.2x:%2.2x:%2.2x:%2.2x:%2.2x, &quot;</span>
				<span class="s">&quot;type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">master_ifname</span><span class="p">,</span>
				<span class="n">hwaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hwaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				<span class="n">hwaddr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">hwaddr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
				<span class="n">hwaddr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">hwaddr</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
				<span class="n">master_family</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Accepts only one slave */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opt_c</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* change active slave */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">get_slave_flags</span><span class="p">(</span><span class="n">slave_ifname</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
				<span class="s">&quot;Slave &#39;%s&#39;: Error: get flags failed. &quot;</span>
				<span class="s">&quot;Aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">slave_ifname</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">change_active</span><span class="p">(</span><span class="n">master_ifname</span><span class="p">,</span> <span class="n">slave_ifname</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
				<span class="s">&quot;Master &#39;%s&#39;, Slave &#39;%s&#39;: Error: &quot;</span>
				<span class="s">&quot;Change active failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">master_ifname</span><span class="p">,</span> <span class="n">slave_ifname</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Accept multiple slaves */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opt_d</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* detach a slave interface from the master */</span>
				<span class="n">rv</span> <span class="o">=</span> <span class="n">get_slave_flags</span><span class="p">(</span><span class="n">slave_ifname</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Can&#39;t work with this slave. */</span>
					<span class="cm">/* remember the error and skip it*/</span>
					<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
						<span class="s">&quot;Slave &#39;%s&#39;: Error: get flags &quot;</span>
						<span class="s">&quot;failed. Skipping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">slave_ifname</span><span class="p">);</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">rv</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">rv</span> <span class="o">=</span> <span class="n">release</span><span class="p">(</span><span class="n">master_ifname</span><span class="p">,</span> <span class="n">slave_ifname</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
						<span class="s">&quot;Master &#39;%s&#39;, Slave &#39;%s&#39;: Error: &quot;</span>
						<span class="s">&quot;Release failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">master_ifname</span><span class="p">,</span> <span class="n">slave_ifname</span><span class="p">);</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">rv</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* attach a slave interface to the master */</span>
				<span class="n">rv</span> <span class="o">=</span> <span class="n">get_if_settings</span><span class="p">(</span><span class="n">slave_ifname</span><span class="p">,</span> <span class="n">slave_ifra</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Can&#39;t work with this slave. */</span>
					<span class="cm">/* remember the error and skip it*/</span>
					<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
						<span class="s">&quot;Slave &#39;%s&#39;: Error: get &quot;</span>
						<span class="s">&quot;settings failed: %s. &quot;</span>
						<span class="s">&quot;Skipping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">slave_ifname</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">rv</span><span class="p">));</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">rv</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">rv</span> <span class="o">=</span> <span class="n">enslave</span><span class="p">(</span><span class="n">master_ifname</span><span class="p">,</span> <span class="n">slave_ifname</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
						<span class="s">&quot;Master &#39;%s&#39;, Slave &#39;%s&#39;: Error: &quot;</span>
						<span class="s">&quot;Enslave failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">master_ifname</span><span class="p">,</span> <span class="n">slave_ifname</span><span class="p">);</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">rv</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">slave_ifname</span> <span class="o">=</span> <span class="o">*</span><span class="n">spp</span><span class="o">++</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skfd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">close</span><span class="p">(</span><span class="n">skfd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">short</span> <span class="n">mif_flags</span><span class="p">;</span>

<span class="cm">/* Get the inteface configuration from the kernel. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">if_getconfig</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifreq</span> <span class="n">ifr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">metric</span><span class="p">,</span> <span class="n">mtu</span><span class="p">;</span>	<span class="cm">/* Parameters of the master interface. */</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">dstaddr</span><span class="p">,</span> <span class="n">broadaddr</span><span class="p">,</span> <span class="n">netmask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hwaddr</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">SIOCGIFFLAGS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">mif_flags</span> <span class="o">=</span> <span class="n">ifr</span><span class="p">.</span><span class="n">ifr_flags</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;The result of SIOCGIFFLAGS on %s is %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">ifname</span><span class="p">,</span> <span class="n">ifr</span><span class="p">.</span><span class="n">ifr_flags</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">SIOCGIFADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;The result of SIOCGIFADDR is %2.2x.%2.2x.%2.2x.%2.2x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">ifr</span><span class="p">.</span><span class="n">ifr_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ifr</span><span class="p">.</span><span class="n">ifr_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	       <span class="n">ifr</span><span class="p">.</span><span class="n">ifr_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ifr</span><span class="p">.</span><span class="n">ifr_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">SIOCGIFHWADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Gotta convert from &#39;char&#39; to unsigned for printf(). */</span>
	<span class="n">hwaddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_hwaddr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;The result of SIOCGIFHWADDR is type %d  &quot;</span>
	       <span class="s">&quot;%2.2x:%2.2x:%2.2x:%2.2x:%2.2x:%2.2x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">ifr</span><span class="p">.</span><span class="n">ifr_hwaddr</span><span class="p">.</span><span class="n">sa_family</span><span class="p">,</span> <span class="n">hwaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hwaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	       <span class="n">hwaddr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">hwaddr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">hwaddr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">hwaddr</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">SIOCGIFMETRIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">metric</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">metric</span> <span class="o">=</span> <span class="n">ifr</span><span class="p">.</span><span class="n">ifr_metric</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;The result of SIOCGIFMETRIC is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">metric</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">SIOCGIFMTU</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mtu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mtu</span> <span class="o">=</span> <span class="n">ifr</span><span class="p">.</span><span class="n">ifr_mtu</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;The result of SIOCGIFMTU is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mtu</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">SIOCGIFDSTADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dstaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dstaddr</span> <span class="o">=</span> <span class="n">ifr</span><span class="p">.</span><span class="n">ifr_dstaddr</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">SIOCGIFBRDADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">broadaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">broadaddr</span> <span class="o">=</span> <span class="n">ifr</span><span class="p">.</span><span class="n">ifr_broadaddr</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">SIOCGIFNETMASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netmask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">netmask</span> <span class="o">=</span> <span class="n">ifr</span><span class="p">.</span><span class="n">ifr_netmask</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">if_print</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ifconf</span> <span class="n">ifc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ifname</span> <span class="o">==</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ifc</span><span class="p">.</span><span class="n">ifc_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
		<span class="n">ifc</span><span class="p">.</span><span class="n">ifc_buf</span> <span class="o">=</span> <span class="n">buff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">SIOCGIFCONF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">perror</span><span class="p">(</span><span class="s">&quot;SIOCGIFCONF failed&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ifr</span> <span class="o">=</span> <span class="n">ifc</span><span class="p">.</span><span class="n">ifc_req</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ifc</span><span class="p">.</span><span class="n">ifc_len</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ifreq</span><span class="p">);</span> <span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ifr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">if_getconfig</span><span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
					<span class="s">&quot;%s: unknown interface.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_name</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(((</span><span class="n">mif_flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">opt_a</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
			<span class="cm">/*ife_print(&amp;ife);*/</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">if_getconfig</span><span class="p">(</span><span class="n">ifname</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
				<span class="s">&quot;%s: unknown interface.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_drv_info</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">master_ifname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifreq</span> <span class="n">ifr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">endptr</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ifr</span><span class="p">));</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">master_ifname</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
	<span class="n">ifr</span><span class="p">.</span><span class="n">ifr_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">caddr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">info</span><span class="p">;</span>

	<span class="n">info</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">ETHTOOL_GDRVINFO</span><span class="p">;</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;ifenslave&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">fw_version</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">BOND_ABI_VERSION</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">SIOCETHTOOL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EOPNOTSUPP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">saved_errno</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
		<span class="n">v_print</span><span class="p">(</span><span class="s">&quot;Master &#39;%s&#39;: Error: get bonding info failed %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">master_ifname</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">saved_errno</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">abi_ver</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">fw_version</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">endptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">endptr</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">v_print</span><span class="p">(</span><span class="s">&quot;Master &#39;%s&#39;: Error: got invalid string as an ABI &quot;</span>
			<span class="s">&quot;version from the bonding module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">master_ifname</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">v_print</span><span class="p">(</span><span class="s">&quot;ABI ver is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">abi_ver</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">change_active</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">master_ifname</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">slave_ifname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifreq</span> <span class="n">ifr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">slave_flags</span><span class="p">.</span><span class="n">ifr_flags</span> <span class="o">&amp;</span> <span class="n">IFF_SLAVE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
			<span class="s">&quot;Illegal operation: The specified slave interface &quot;</span>
			<span class="s">&quot;&#39;%s&#39; is not a slave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">slave_ifname</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">master_ifname</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_slave</span><span class="p">,</span> <span class="n">slave_ifname</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">SIOCBONDCHANGEACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">BOND_CHANGE_ACTIVE_OLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">saved_errno</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
		<span class="n">v_print</span><span class="p">(</span><span class="s">&quot;Master &#39;%s&#39;: Error: SIOCBONDCHANGEACTIVE failed: &quot;</span>
			<span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">master_ifname</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">saved_errno</span><span class="p">));</span>
		<span class="n">res</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">enslave</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">master_ifname</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">slave_ifname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifreq</span> <span class="n">ifr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slave_flags</span><span class="p">.</span><span class="n">ifr_flags</span> <span class="o">&amp;</span> <span class="n">IFF_SLAVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
			<span class="s">&quot;Illegal operation: The specified slave interface &quot;</span>
			<span class="s">&quot;&#39;%s&#39; is already a slave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">slave_ifname</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">set_if_down</span><span class="p">(</span><span class="n">slave_ifname</span><span class="p">,</span> <span class="n">slave_flags</span><span class="p">.</span><span class="n">ifr_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
			<span class="s">&quot;Slave &#39;%s&#39;: Error: bring interface down failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">slave_ifname</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">abi_ver</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Older bonding versions would panic if the slave has no IP</span>
<span class="cm">		 * address, so get the IP setting from the master.</span>
<span class="cm">		 */</span>
		<span class="n">set_if_addr</span><span class="p">(</span><span class="n">master_ifname</span><span class="p">,</span> <span class="n">slave_ifname</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">clear_if_addr</span><span class="p">(</span><span class="n">slave_ifname</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
				<span class="s">&quot;Slave &#39;%s&#39;: Error: clear address failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">slave_ifname</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">master_mtu</span><span class="p">.</span><span class="n">ifr_mtu</span> <span class="o">!=</span> <span class="n">slave_mtu</span><span class="p">.</span><span class="n">ifr_mtu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">set_slave_mtu</span><span class="p">(</span><span class="n">slave_ifname</span><span class="p">,</span> <span class="n">master_mtu</span><span class="p">.</span><span class="n">ifr_mtu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
				<span class="s">&quot;Slave &#39;%s&#39;: Error: set MTU failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">slave_ifname</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwaddr_set</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Master already has an hwaddr</span>
<span class="cm">		 * so set it&#39;s hwaddr to the slave</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abi_ver</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* The driver is using an old ABI, so</span>
<span class="cm">			 * the application sets the slave&#39;s</span>
<span class="cm">			 * hwaddr</span>
<span class="cm">			 */</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">set_slave_hwaddr</span><span class="p">(</span><span class="n">slave_ifname</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="p">(</span><span class="n">master_hwaddr</span><span class="p">.</span><span class="n">ifr_hwaddr</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
					<span class="s">&quot;Slave &#39;%s&#39;: Error: set hw address &quot;</span>
					<span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">slave_ifname</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">undo_mtu</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* For old ABI the application needs to bring the</span>
<span class="cm">			 * slave back up</span>
<span class="cm">			 */</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">set_if_up</span><span class="p">(</span><span class="n">slave_ifname</span><span class="p">,</span> <span class="n">slave_flags</span><span class="p">.</span><span class="n">ifr_flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
					<span class="s">&quot;Slave &#39;%s&#39;: Error: bring interface &quot;</span>
					<span class="s">&quot;down failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">slave_ifname</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">undo_slave_mac</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* The driver is using a new ABI,</span>
<span class="cm">		 * so the driver takes care of setting</span>
<span class="cm">		 * the slave&#39;s hwaddr and bringing</span>
<span class="cm">		 * it up again</span>
<span class="cm">		 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* No hwaddr for master yet, so</span>
<span class="cm">		 * set the slave&#39;s hwaddr to it</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abi_ver</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* For old ABI, the master needs to be</span>
<span class="cm">			 * down before setting its hwaddr</span>
<span class="cm">			 */</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">set_if_down</span><span class="p">(</span><span class="n">master_ifname</span><span class="p">,</span> <span class="n">master_flags</span><span class="p">.</span><span class="n">ifr_flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
					<span class="s">&quot;Master &#39;%s&#39;: Error: bring interface &quot;</span>
					<span class="s">&quot;down failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">master_ifname</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">undo_mtu</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">res</span> <span class="o">=</span> <span class="n">set_master_hwaddr</span><span class="p">(</span><span class="n">master_ifname</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="p">(</span><span class="n">slave_hwaddr</span><span class="p">.</span><span class="n">ifr_hwaddr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
				<span class="s">&quot;Master &#39;%s&#39;: Error: set hw address &quot;</span>
				<span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">master_ifname</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">undo_mtu</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">abi_ver</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* For old ABI, bring the master</span>
<span class="cm">			 * back up</span>
<span class="cm">			 */</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">set_if_up</span><span class="p">(</span><span class="n">master_ifname</span><span class="p">,</span> <span class="n">master_flags</span><span class="p">.</span><span class="n">ifr_flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
					<span class="s">&quot;Master &#39;%s&#39;: Error: bring interface &quot;</span>
					<span class="s">&quot;up failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">master_ifname</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">undo_master_mac</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">hwaddr_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Do the real thing */</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">master_ifname</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_slave</span><span class="p">,</span> <span class="n">slave_ifname</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">SIOCBONDENSLAVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">BOND_ENSLAVE_OLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">saved_errno</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
		<span class="n">v_print</span><span class="p">(</span><span class="s">&quot;Master &#39;%s&#39;: Error: SIOCBONDENSLAVE failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">master_ifname</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">saved_errno</span><span class="p">));</span>
		<span class="n">res</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">undo_master_mac</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* rollback (best effort) */</span>
<span class="nl">undo_master_mac:</span>
	<span class="n">set_master_hwaddr</span><span class="p">(</span><span class="n">master_ifname</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">master_hwaddr</span><span class="p">.</span><span class="n">ifr_hwaddr</span><span class="p">));</span>
	<span class="n">hwaddr_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">undo_mtu</span><span class="p">;</span>
<span class="nl">undo_slave_mac:</span>
	<span class="n">set_slave_hwaddr</span><span class="p">(</span><span class="n">slave_ifname</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">slave_hwaddr</span><span class="p">.</span><span class="n">ifr_hwaddr</span><span class="p">));</span>
<span class="nl">undo_mtu:</span>
	<span class="n">set_slave_mtu</span><span class="p">(</span><span class="n">slave_ifname</span><span class="p">,</span> <span class="n">slave_mtu</span><span class="p">.</span><span class="n">ifr_mtu</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">release</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">master_ifname</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">slave_ifname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifreq</span> <span class="n">ifr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">slave_flags</span><span class="p">.</span><span class="n">ifr_flags</span> <span class="o">&amp;</span> <span class="n">IFF_SLAVE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
			<span class="s">&quot;Illegal operation: The specified slave interface &quot;</span>
			<span class="s">&quot;&#39;%s&#39; is not a slave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">slave_ifname</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">master_ifname</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_slave</span><span class="p">,</span> <span class="n">slave_ifname</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">SIOCBONDRELEASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">BOND_RELEASE_OLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">saved_errno</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
		<span class="n">v_print</span><span class="p">(</span><span class="s">&quot;Master &#39;%s&#39;: Error: SIOCBONDRELEASE failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">master_ifname</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">saved_errno</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">abi_ver</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The driver is using an old ABI, so we&#39;ll set the interface</span>
<span class="cm">		 * down to avoid any conflicts due to same MAC/IP</span>
<span class="cm">		 */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">set_if_down</span><span class="p">(</span><span class="n">slave_ifname</span><span class="p">,</span> <span class="n">slave_flags</span><span class="p">.</span><span class="n">ifr_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
				<span class="s">&quot;Slave &#39;%s&#39;: Error: bring interface &quot;</span>
				<span class="s">&quot;down failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">slave_ifname</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* set to default mtu */</span>
	<span class="n">set_slave_mtu</span><span class="p">(</span><span class="n">slave_ifname</span><span class="p">,</span> <span class="mi">1500</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_if_settings</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dev_ifr</span> <span class="n">ifra</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ifra</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">req_ifr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">ifra</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">req_ifr</span><span class="o">-&gt;</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">ifname</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">ifra</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">req_type</span><span class="p">,</span> <span class="n">ifra</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">req_ifr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">saved_errno</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
			<span class="n">v_print</span><span class="p">(</span><span class="s">&quot;Interface &#39;%s&#39;: Error: %s failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ifname</span><span class="p">,</span> <span class="n">ifra</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">req_name</span><span class="p">,</span>
				<span class="n">strerror</span><span class="p">(</span><span class="n">saved_errno</span><span class="p">));</span>

			<span class="k">return</span> <span class="n">saved_errno</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_slave_flags</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">slave_ifname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">slave_flags</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">slave_ifname</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">SIOCGIFFLAGS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slave_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saved_errno</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
		<span class="n">v_print</span><span class="p">(</span><span class="s">&quot;Slave &#39;%s&#39;: Error: SIOCGIFFLAGS failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">slave_ifname</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">saved_errno</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">v_print</span><span class="p">(</span><span class="s">&quot;Slave %s: flags %04X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">slave_ifname</span><span class="p">,</span> <span class="n">slave_flags</span><span class="p">.</span><span class="n">ifr_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_master_hwaddr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">master_ifname</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">hwaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hwaddr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ifreq</span> <span class="n">ifr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">master_ifname</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_hwaddr</span><span class="p">),</span> <span class="n">hwaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="p">));</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">SIOCSIFHWADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saved_errno</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
		<span class="n">v_print</span><span class="p">(</span><span class="s">&quot;Master &#39;%s&#39;: Error: SIOCSIFHWADDR failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">master_ifname</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">saved_errno</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">v_print</span><span class="p">(</span><span class="s">&quot;Master &#39;%s&#39;: hardware address set to &quot;</span>
			<span class="s">&quot;%2.2x:%2.2x:%2.2x:%2.2x:%2.2x:%2.2x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">master_ifname</span><span class="p">,</span> <span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
			<span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_slave_hwaddr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">slave_ifname</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">hwaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hwaddr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ifreq</span> <span class="n">ifr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">slave_ifname</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_hwaddr</span><span class="p">),</span> <span class="n">hwaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="p">));</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">SIOCSIFHWADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saved_errno</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>

		<span class="n">v_print</span><span class="p">(</span><span class="s">&quot;Slave &#39;%s&#39;: Error: SIOCSIFHWADDR failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">slave_ifname</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">saved_errno</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">saved_errno</span> <span class="o">==</span> <span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">v_print</span><span class="p">(</span><span class="s">&quot;  The device is busy: it must be idle &quot;</span>
				<span class="s">&quot;before running this command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">saved_errno</span> <span class="o">==</span> <span class="n">EOPNOTSUPP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">v_print</span><span class="p">(</span><span class="s">&quot;  The device does not support setting &quot;</span>
				<span class="s">&quot;the MAC address.</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="s">&quot;  Your kernel likely does not support slave &quot;</span>
				<span class="s">&quot;devices.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">saved_errno</span> <span class="o">==</span> <span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">v_print</span><span class="p">(</span><span class="s">&quot;  The device&#39;s address type does not match &quot;</span>
				<span class="s">&quot;the master&#39;s address type.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">v_print</span><span class="p">(</span><span class="s">&quot;Slave &#39;%s&#39;: hardware address set to &quot;</span>
			<span class="s">&quot;%2.2x:%2.2x:%2.2x:%2.2x:%2.2x:%2.2x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">slave_ifname</span><span class="p">,</span> <span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
			<span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_slave_mtu</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">slave_ifname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifreq</span> <span class="n">ifr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ifr</span><span class="p">.</span><span class="n">ifr_mtu</span> <span class="o">=</span> <span class="n">mtu</span><span class="p">;</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">slave_ifname</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">SIOCSIFMTU</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saved_errno</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
		<span class="n">v_print</span><span class="p">(</span><span class="s">&quot;Slave &#39;%s&#39;: Error: SIOCSIFMTU failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">slave_ifname</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">saved_errno</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">v_print</span><span class="p">(</span><span class="s">&quot;Slave &#39;%s&#39;: MTU set to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slave_ifname</span><span class="p">,</span> <span class="n">mtu</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_if_flags</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">,</span> <span class="kt">short</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifreq</span> <span class="n">ifr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ifr</span><span class="p">.</span><span class="n">ifr_flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">ifname</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">SIOCSIFFLAGS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saved_errno</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
		<span class="n">v_print</span><span class="p">(</span><span class="s">&quot;Interface &#39;%s&#39;: Error: SIOCSIFFLAGS failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ifname</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">saved_errno</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">v_print</span><span class="p">(</span><span class="s">&quot;Interface &#39;%s&#39;: flags set to %04X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ifname</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_if_up</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">,</span> <span class="kt">short</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">set_if_flags</span><span class="p">(</span><span class="n">ifname</span><span class="p">,</span> <span class="n">flags</span> <span class="o">|</span> <span class="n">IFF_UP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_if_down</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">,</span> <span class="kt">short</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">set_if_flags</span><span class="p">(</span><span class="n">ifname</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IFF_UP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">clear_if_addr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifreq</span> <span class="n">ifr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">ifname</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
	<span class="n">ifr</span><span class="p">.</span><span class="n">ifr_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">));</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">SIOCSIFADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saved_errno</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
		<span class="n">v_print</span><span class="p">(</span><span class="s">&quot;Interface &#39;%s&#39;: Error: SIOCSIFADDR failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ifname</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">saved_errno</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">v_print</span><span class="p">(</span><span class="s">&quot;Interface &#39;%s&#39;: address cleared</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_if_addr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">master_ifname</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">slave_ifname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ifreq</span> <span class="n">ifr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ipaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">req_name</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">g_ioctl</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">s_ioctl</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">ifra</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="s">&quot;IFADDR&quot;</span><span class="p">,</span> <span class="s">&quot;addr&quot;</span><span class="p">,</span> <span class="n">SIOCGIFADDR</span><span class="p">,</span> <span class="n">SIOCSIFADDR</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;DSTADDR&quot;</span><span class="p">,</span> <span class="s">&quot;destination addr&quot;</span><span class="p">,</span> <span class="n">SIOCGIFDSTADDR</span><span class="p">,</span> <span class="n">SIOCSIFDSTADDR</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;BRDADDR&quot;</span><span class="p">,</span> <span class="s">&quot;broadcast addr&quot;</span><span class="p">,</span> <span class="n">SIOCGIFBRDADDR</span><span class="p">,</span> <span class="n">SIOCSIFBRDADDR</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&quot;NETMASK&quot;</span><span class="p">,</span> <span class="s">&quot;netmask&quot;</span><span class="p">,</span> <span class="n">SIOCGIFNETMASK</span><span class="p">,</span> <span class="n">SIOCSIFNETMASK</span><span class="p">},</span>
		<span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">};</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ifra</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">req_name</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">master_ifname</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">ifra</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">g_ioctl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">saved_errno</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>

			<span class="n">v_print</span><span class="p">(</span><span class="s">&quot;Interface &#39;%s&#39;: Error: SIOCG%s failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">master_ifname</span><span class="p">,</span> <span class="n">ifra</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">req_name</span><span class="p">,</span>
				<span class="n">strerror</span><span class="p">(</span><span class="n">saved_errno</span><span class="p">));</span>

			<span class="n">ifr</span><span class="p">.</span><span class="n">ifr_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">strncpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span> <span class="n">slave_ifname</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">skfd</span><span class="p">,</span> <span class="n">ifra</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">s_ioctl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">saved_errno</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>

			<span class="n">v_print</span><span class="p">(</span><span class="s">&quot;Interface &#39;%s&#39;: Error: SIOCS%s failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">slave_ifname</span><span class="p">,</span> <span class="n">ifra</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">req_name</span><span class="p">,</span>
				<span class="n">strerror</span><span class="p">(</span><span class="n">saved_errno</span><span class="p">));</span>

		<span class="p">}</span>

		<span class="n">ipaddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">;</span>
		<span class="n">v_print</span><span class="p">(</span><span class="s">&quot;Interface &#39;%s&#39;: set IP %s to %d.%d.%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">slave_ifname</span><span class="p">,</span> <span class="n">ifra</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span>
			<span class="n">ipaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ipaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ipaddr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ipaddr</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Local variables:</span>
<span class="cm"> *  version-control: t</span>
<span class="cm"> *  kept-new-versions: 5</span>
<span class="cm"> *  c-indent-level: 4</span>
<span class="cm"> *  c-basic-offset: 4</span>
<span class="cm"> *  tab-width: 4</span>
<span class="cm"> *  compile-command: &quot;gcc -Wall -Wstrict-prototypes -O -I/usr/src/linux/include ifenslave.c -o ifenslave&quot;</span>
<span class="cm"> * End:</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
