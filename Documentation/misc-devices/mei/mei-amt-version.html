<!DOCTYPE html>
<html><head><title>joekychen/linux » Documentation › misc-devices › mei › mei-amt-version.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mei-amt-version.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> * Intel Management Engine Interface (Intel MEI) Linux driver</span>
<span class="cm"> * Intel MEI Interface Header</span>
<span class="cm"> *</span>
<span class="cm"> * This file is provided under a dual BSD/GPLv2 license.  When using or</span>
<span class="cm"> * redistributing this file, you may do so under either license.</span>
<span class="cm"> *</span>
<span class="cm"> * GPL LICENSE SUMMARY</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2012 Intel Corporation. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of version 2 of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110,</span>
<span class="cm"> * USA</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is included in this distribution</span>
<span class="cm"> * in the file called LICENSE.GPL.</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> *	Intel Corporation.</span>
<span class="cm"> *	linux-mei@linux.intel.com</span>
<span class="cm"> *	http://www.intel.com</span>
<span class="cm"> *</span>
<span class="cm"> * BSD LICENSE</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2003 - 2012 Intel Corporation. All rights reserved.</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> *</span>
<span class="cm"> *  * Redistributions of source code must retain the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> *  * Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer in</span>
<span class="cm"> *    the documentation and/or other materials provided with the</span>
<span class="cm"> *    distribution.</span>
<span class="cm"> *  * Neither the name Intel Corporation nor the names of its</span>
<span class="cm"> *    contributors may be used to endorse or promote products derived</span>
<span class="cm"> *    from this software without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="cm"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="cm"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<span class="cm"> * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<span class="cm"> * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<span class="cm"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<span class="cm"> * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<span class="cm"> * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<span class="cm"> * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="cm"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="cm"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;fcntl.h&gt;</span>
<span class="cp">#include &lt;sys/ioctl.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;errno.h&gt;</span>
<span class="cp">#include &lt;stdint.h&gt;</span>
<span class="cp">#include &lt;stdbool.h&gt;</span>
<span class="cp">#include &lt;bits/wordsize.h&gt;</span>
<span class="cp">#include &lt;linux/mei.h&gt;</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * Intel Management Engine Interface</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cp">#define mei_msg(_me, fmt, ARGS...) do {         \</span>
<span class="cp">	if (_me-&gt;verbose)                       \</span>
<span class="cp">		fprintf(stderr, fmt, ##ARGS);	\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define mei_err(_me, fmt, ARGS...) do {         \</span>
<span class="cp">	fprintf(stderr, &quot;Error: &quot; fmt, ##ARGS); \</span>
<span class="cp">} while (0)</span>

<span class="k">struct</span> <span class="n">mei</span> <span class="p">{</span>
	<span class="n">uuid_le</span> <span class="n">guid</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">initialized</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">verbose</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">prot_ver</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mei_deinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">mei</span> <span class="o">*</span><span class="n">cl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">close</span><span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">);</span>
	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">prot_ver</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cl</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">mei_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mei</span> <span class="o">*</span><span class="n">me</span><span class="p">,</span> <span class="k">const</span> <span class="n">uuid_le</span> <span class="o">*</span><span class="n">guid</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">req_protocol_version</span><span class="p">,</span> <span class="n">bool</span> <span class="n">verbose</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mei_client</span> <span class="o">*</span><span class="n">cl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mei_connect_client_data</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">mei_deinit</span><span class="p">(</span><span class="n">me</span><span class="p">);</span>

	<span class="n">me</span><span class="o">-&gt;</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">;</span>

	<span class="n">me</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/mei&quot;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mei_err</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="s">&quot;Cannot establish a handle to the Intel MEI driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">guid</span><span class="p">,</span> <span class="n">guid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">guid</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	<span class="n">me</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">.</span><span class="n">in_client_uuid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">guid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">guid</span><span class="p">));</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="n">IOCTL_MEI_CONNECT_CLIENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mei_err</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="s">&quot;IOCTL_MEI_CONNECT_CLIENT receive message. err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">.</span><span class="n">out_client_properties</span><span class="p">;</span>
	<span class="n">mei_msg</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="s">&quot;max_message_length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">max_msg_length</span><span class="p">);</span>
	<span class="n">mei_msg</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="s">&quot;protocol_version %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">protocol_version</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">req_protocol_version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">cl</span><span class="o">-&gt;</span><span class="n">protocol_version</span> <span class="o">!=</span> <span class="n">req_protocol_version</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mei_err</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="s">&quot;Intel MEI protocol version not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">me</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">max_msg_length</span><span class="p">;</span>
	<span class="n">me</span><span class="o">-&gt;</span><span class="n">prot_ver</span> <span class="o">=</span> <span class="n">cl</span><span class="o">-&gt;</span><span class="n">protocol_version</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">mei_deinit</span><span class="p">(</span><span class="n">me</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">mei_recv_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">mei</span> <span class="o">*</span><span class="n">me</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			<span class="kt">ssize_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">mei_msg</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="s">&quot;call read length = %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mei_err</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="s">&quot;read failed with status %zd %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rc</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="n">mei_deinit</span><span class="p">(</span><span class="n">me</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mei_msg</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="s">&quot;read succeeded with result %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">mei_send_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">mei</span> <span class="o">*</span><span class="n">me</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			<span class="kt">ssize_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">written</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">fd_set</span> <span class="n">set</span><span class="p">;</span>

	<span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="n">timeout</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">;</span>

	<span class="n">mei_msg</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="s">&quot;call write length = %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">written</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">written</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
		<span class="n">mei_err</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="s">&quot;write failed with status %zd %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">written</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">FD_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">set</span><span class="p">);</span>
	<span class="n">FD_SET</span><span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">set</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">set</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">FD_ISSET</span><span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">set</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mei_msg</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="s">&quot;write success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mei_err</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="s">&quot;write failed on timeout with status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* rc &lt; 0 */</span>
		<span class="n">mei_err</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="s">&quot;write failed on select with status %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">written</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mei_deinit</span><span class="p">(</span><span class="n">me</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm"> * Intel Advanced Management Technolgy ME Client</span>
<span class="cm"> ***************************************************************************/</span>

<span class="cp">#define AMT_MAJOR_VERSION 1</span>
<span class="cp">#define AMT_MINOR_VERSION 1</span>

<span class="cp">#define AMT_STATUS_SUCCESS                0x0</span>
<span class="cp">#define AMT_STATUS_INTERNAL_ERROR         0x1</span>
<span class="cp">#define AMT_STATUS_NOT_READY              0x2</span>
<span class="cp">#define AMT_STATUS_INVALID_AMT_MODE       0x3</span>
<span class="cp">#define AMT_STATUS_INVALID_MESSAGE_LENGTH 0x4</span>

<span class="cp">#define AMT_STATUS_HOST_IF_EMPTY_RESPONSE  0x4000</span>
<span class="cp">#define AMT_STATUS_SDK_RESOURCES      0x1004</span>


<span class="cp">#define AMT_BIOS_VERSION_LEN   65</span>
<span class="cp">#define AMT_VERSIONS_NUMBER    50</span>
<span class="cp">#define AMT_UNICODE_STRING_LEN 20</span>

<span class="k">struct</span> <span class="n">amt_unicode_string</span> <span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">length</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">string</span><span class="p">[</span><span class="n">AMT_UNICODE_STRING_LEN</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">amt_version_type</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">amt_unicode_string</span> <span class="n">description</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">amt_unicode_string</span> <span class="n">version</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">amt_version</span> <span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">major</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">minor</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">amt_code_versions</span> <span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">bios</span><span class="p">[</span><span class="n">AMT_BIOS_VERSION_LEN</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">amt_version_type</span> <span class="n">versions</span><span class="p">[</span><span class="n">AMT_VERSIONS_NUMBER</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/***************************************************************************</span>
<span class="cm"> * Intel Advanced Management Technolgy Host Interface</span>
<span class="cm"> ***************************************************************************/</span>

<span class="k">struct</span> <span class="n">amt_host_if_msg_header</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">amt_version</span> <span class="n">version</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">_reserved</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">command</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">amt_host_if_resp_header</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">amt_host_if_msg_header</span> <span class="n">header</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">const</span> <span class="n">uuid_le</span> <span class="n">MEI_IAMTHIF</span> <span class="o">=</span> <span class="n">UUID_LE</span><span class="p">(</span><span class="mh">0x12f80028</span><span class="p">,</span> <span class="mh">0xb4b7</span><span class="p">,</span> <span class="mh">0x4b2d</span><span class="p">,</span>  \
				<span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">);</span>

<span class="cp">#define AMT_HOST_IF_CODE_VERSIONS_REQUEST  0x0400001A</span>
<span class="cp">#define AMT_HOST_IF_CODE_VERSIONS_RESPONSE 0x0480001A</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">amt_host_if_msg_header</span> <span class="n">CODE_VERSION_REQ</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="p">{</span><span class="n">AMT_MAJOR_VERSION</span><span class="p">,</span> <span class="n">AMT_MINOR_VERSION</span><span class="p">},</span>
	<span class="p">.</span><span class="n">_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">AMT_HOST_IF_CODE_VERSIONS_REQUEST</span><span class="p">,</span>
	<span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">amt_host_if</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mei</span> <span class="n">mei_cl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">send_timeout</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">initialized</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">static</span> <span class="n">bool</span> <span class="nf">amt_host_if_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">amt_host_if</span> <span class="o">*</span><span class="n">acmd</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">send_timeout</span><span class="p">,</span> <span class="n">bool</span> <span class="n">verbose</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acmd</span><span class="o">-&gt;</span><span class="n">send_timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">send_timeout</span><span class="p">)</span> <span class="o">?</span> <span class="n">send_timeout</span> <span class="o">:</span> <span class="mi">20000</span><span class="p">;</span>
	<span class="n">acmd</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="n">mei_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acmd</span><span class="o">-&gt;</span><span class="n">mei_cl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">MEI_IAMTHIF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">acmd</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amt_host_if_deinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">amt_host_if</span> <span class="o">*</span><span class="n">acmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mei_deinit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acmd</span><span class="o">-&gt;</span><span class="n">mei_cl</span><span class="p">);</span>
	<span class="n">acmd</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">amt_verify_code_versions</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">amt_host_if_resp_header</span> <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">status</span> <span class="o">=</span> <span class="n">AMT_STATUS_SUCCESS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">amt_code_versions</span> <span class="o">*</span><span class="n">code_ver</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">code_ver_len</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ver_type_cnt</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">code_ver</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">amt_code_versions</span> <span class="o">*</span><span class="p">)</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="cm">/* length - sizeof(status) */</span>
	<span class="n">code_ver_len</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
	<span class="n">ver_type_cnt</span> <span class="o">=</span> <span class="n">code_ver_len</span> <span class="o">-</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">code_ver</span><span class="o">-&gt;</span><span class="n">bios</span><span class="p">)</span> <span class="o">-</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">code_ver</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code_ver</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="n">ver_type_cnt</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amt_version_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">AMT_STATUS_INTERNAL_ERROR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">code_ver</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">code_ver</span><span class="o">-&gt;</span><span class="n">versions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">description</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">AMT_UNICODE_STRING_LEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">AMT_STATUS_INTERNAL_ERROR</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">code_ver</span><span class="o">-&gt;</span><span class="n">versions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">version</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">code_ver</span><span class="o">-&gt;</span><span class="n">versions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">version</span><span class="p">.</span><span class="n">string</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span> <span class="o">||</span>
		    <span class="n">len</span> <span class="o">!=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">code_ver</span><span class="o">-&gt;</span><span class="n">versions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">version</span><span class="p">.</span><span class="n">string</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">AMT_STATUS_INTERNAL_ERROR</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">amt_verify_response_header</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">command</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">amt_host_if_msg_header</span> <span class="o">*</span><span class="n">resp_hdr</span><span class="p">,</span>
				<span class="kt">uint32_t</span> <span class="n">response_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">response_size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amt_host_if_resp_header</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">AMT_STATUS_INTERNAL_ERROR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">response_size</span> <span class="o">!=</span> <span class="p">(</span><span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amt_host_if_msg_header</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">AMT_STATUS_INTERNAL_ERROR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">!=</span> <span class="n">command</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">AMT_STATUS_INTERNAL_ERROR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">_reserved</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">AMT_STATUS_INTERNAL_ERROR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">major</span> <span class="o">!=</span> <span class="n">AMT_MAJOR_VERSION</span> <span class="o">||</span>
		   <span class="n">resp_hdr</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">minor</span> <span class="o">&lt;</span> <span class="n">AMT_MINOR_VERSION</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">AMT_STATUS_INTERNAL_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">AMT_STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">amt_host_if_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">amt_host_if</span> <span class="o">*</span><span class="n">acmd</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">command</span><span class="p">,</span> <span class="kt">ssize_t</span> <span class="n">command_sz</span><span class="p">,</span>
			<span class="kt">uint8_t</span> <span class="o">**</span><span class="n">read_buf</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">rcmd</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">expected_sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">in_buf_sz</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">out_buf_sz</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">written</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">amt_host_if_resp_header</span> <span class="o">*</span><span class="n">msg_hdr</span><span class="p">;</span>

	<span class="n">in_buf_sz</span> <span class="o">=</span> <span class="n">acmd</span><span class="o">-&gt;</span><span class="n">mei_cl</span><span class="p">.</span><span class="n">buf_size</span><span class="p">;</span>
	<span class="o">*</span><span class="n">read_buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">in_buf_sz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">read_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">AMT_STATUS_SDK_RESOURCES</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">*</span><span class="n">read_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">in_buf_sz</span><span class="p">);</span>
	<span class="n">msg_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">amt_host_if_resp_header</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">read_buf</span><span class="p">;</span>

	<span class="n">written</span> <span class="o">=</span> <span class="n">mei_send_msg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acmd</span><span class="o">-&gt;</span><span class="n">mei_cl</span><span class="p">,</span>
				<span class="n">command</span><span class="p">,</span> <span class="n">command_sz</span><span class="p">,</span> <span class="n">acmd</span><span class="o">-&gt;</span><span class="n">send_timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">written</span> <span class="o">!=</span> <span class="n">command_sz</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">AMT_STATUS_INTERNAL_ERROR</span><span class="p">;</span>

	<span class="n">out_buf_sz</span> <span class="o">=</span> <span class="n">mei_recv_msg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acmd</span><span class="o">-&gt;</span><span class="n">mei_cl</span><span class="p">,</span> <span class="o">*</span><span class="n">read_buf</span><span class="p">,</span> <span class="n">in_buf_sz</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">out_buf_sz</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">AMT_STATUS_HOST_IF_EMPTY_RESPONSE</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">msg_hdr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">AMT_STATUS_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">amt_verify_response_header</span><span class="p">(</span><span class="n">rcmd</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">msg_hdr</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">,</span> <span class="n">out_buf_sz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">AMT_STATUS_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">expected_sz</span> <span class="o">&amp;&amp;</span> <span class="n">expected_sz</span> <span class="o">!=</span> <span class="n">out_buf_sz</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">AMT_STATUS_INTERNAL_ERROR</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">AMT_STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">amt_get_code_versions</span><span class="p">(</span><span class="k">struct</span> <span class="n">amt_host_if</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">amt_code_versions</span> <span class="o">*</span><span class="n">versions</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amt_host_if_resp_header</span> <span class="o">*</span><span class="n">response</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">amt_host_if_call</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span>
			<span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">CODE_VERSION_REQ</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">CODE_VERSION_REQ</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">uint8_t</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">response</span><span class="p">,</span>
			<span class="n">AMT_HOST_IF_CODE_VERSIONS_RESPONSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">AMT_STATUS_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">amt_verify_code_versions</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">AMT_STATUS_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">versions</span><span class="p">,</span> <span class="n">response</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amt_code_versions</span><span class="p">));</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">response</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">free</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/************************** end of amt_host_if_command ***********************/</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amt_code_versions</span> <span class="n">ver</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">amt_host_if</span> <span class="n">acmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">verbose</span><span class="p">;</span>

	<span class="n">verbose</span> <span class="o">=</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;-v&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">amt_host_if_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acmd</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">verbose</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">amt_get_code_versions</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ver</span><span class="p">);</span>

	<span class="n">amt_host_if_deinit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acmd</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AMT_STATUS_HOST_IF_EMPTY_RESPONSE</span>:
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Intel AMT: DISABLED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AMT_STATUS_SUCCESS</span>:
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Intel AMT: ENABLED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ver</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ver</span><span class="p">.</span><span class="n">versions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">description</span><span class="p">.</span><span class="n">string</span><span class="p">,</span>
				<span class="n">ver</span><span class="p">.</span><span class="n">versions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">version</span><span class="p">.</span><span class="n">string</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;An error has occurred</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
