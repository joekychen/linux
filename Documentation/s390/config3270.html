<!DOCTYPE html>
<html><head><title>joekychen/linux » Documentation › s390 › config3270.sh

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>config3270.sh</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="c">#!/bin/sh</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>config3270 -- Autoconfigure /dev/3270/* and /etc/inittab</p>

<pre><code>  Usage:
          config3270

  Output:
          /tmp/mkdev3270

  Operation:
          1. Run this script
          2. Run the script it produces: /tmp/mkdev3270
          3. Issue "telinit q" or reboot, as appropriate.
</code></pre></td><td class="code"><div class="highlight"><pre><span class="nv">P</span><span class="o">=</span>/proc/tty/driver/tty3270
<span class="nv">ROOT</span><span class="o">=</span>
<span class="nv">D</span><span class="o">=</span><span class="nv">$ROOT</span>/dev
<span class="nv">SUBD</span><span class="o">=</span>3270
<span class="nv">TTY</span><span class="o">=</span><span class="nv">$SUBD</span>/tty
<span class="nv">TUB</span><span class="o">=</span><span class="nv">$SUBD</span>/tub
<span class="nv">SCR</span><span class="o">=</span><span class="nv">$ROOT</span>/tmp/mkdev3270
<span class="nv">SCRTMP</span><span class="o">=</span><span class="nv">$SCR</span>.a
<span class="nv">GETTYLINE</span><span class="o">=</span>:2345:respawn:/sbin/mingetty
<span class="nv">INITTAB</span><span class="o">=</span><span class="nv">$ROOT</span>/etc/inittab
<span class="nv">NINITTAB</span><span class="o">=</span><span class="nv">$ROOT</span>/etc/NEWinittab
<span class="nv">OINITTAB</span><span class="o">=</span><span class="nv">$ROOT</span>/etc/OLDinittab
<span class="nv">ADDNOTE</span><span class="o">=</span><span class="se">\\</span><span class="s2">&quot;# Additional mingettys for the 3270/tty* driver, tub3270 ---\\&quot;</span>

<span class="k">if</span> ! ls <span class="nv">$P</span> &gt; /dev/null 2&gt;&amp;1; <span class="k">then</span>
<span class="k">	</span>modprobe tub3270 &gt; /dev/null 2&gt;&amp;1
<span class="k">fi</span>
ls <span class="nv">$P</span> &gt; /dev/null 2&gt;&amp;1 <span class="o">||</span> <span class="nb">exit </span>1</pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Initialize two files, one for /dev/3270 commands and one
to replace the /etc/inittab file (old one saved in OLDinittab)</p></td><td class="code"><div class="highlight"><pre><span class="nb">echo</span> <span class="s2">&quot;#!/bin/sh&quot;</span> &gt; <span class="nv">$SCR</span> <span class="o">||</span> <span class="nb">exit </span>1
<span class="nb">echo</span> <span class="s2">&quot; &quot;</span> &gt;&gt; <span class="nv">$SCR</span>
<span class="nb">echo</span> <span class="s2">&quot;# Script built by /sbin/config3270&quot;</span> &gt;&gt; <span class="nv">$SCR</span>
<span class="k">if</span> <span class="o">[</span> ! -d /dev/dasd <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span><span class="nb">echo </span>rm -rf <span class="s2">&quot;$D/$SUBD/*&quot;</span> &gt;&gt; <span class="nv">$SCR</span>
<span class="k">fi</span>
<span class="nb">echo</span> <span class="s2">&quot;grep -v $TTY $INITTAB &gt; $NINITTAB&quot;</span> &gt; <span class="nv">$SCRTMP</span> <span class="o">||</span> <span class="nb">exit </span>1
<span class="nb">echo</span> <span class="s2">&quot;echo $ADDNOTE &gt;&gt; $NINITTAB&quot;</span> &gt;&gt; <span class="nv">$SCRTMP</span>
<span class="k">if</span> <span class="o">[</span> ! -d /dev/dasd <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span><span class="nb">echo </span>mkdir -p <span class="nv">$D</span>/<span class="nv">$SUBD</span> &gt;&gt; <span class="nv">$SCR</span>
<span class="k">fi</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Now query the tub3270 driver for 3270 device information
and add appropriate mknod and mingetty lines to our files</p></td><td class="code"><div class="highlight"><pre><span class="nb">echo </span><span class="nv">what</span><span class="o">=</span>config &gt; <span class="nv">$P</span>
<span class="k">while </span><span class="nb">read </span>devno maj min;do
	<span class="k">if</span> <span class="o">[</span> <span class="nv">$min</span> <span class="o">=</span> 0 <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nv">fsmaj</span><span class="o">=</span><span class="nv">$maj</span>
		<span class="k">if</span> <span class="o">[</span> ! -d /dev/dasd <span class="o">]</span>; <span class="k">then</span>
<span class="k">			</span><span class="nb">echo </span>mknod <span class="nv">$D</span>/<span class="nv">$TUB</span> c <span class="nv">$fsmaj</span> 0 &gt;&gt; <span class="nv">$SCR</span>
			<span class="nb">echo </span>chmod 666 <span class="nv">$D</span>/<span class="nv">$TUB</span> &gt;&gt; <span class="nv">$SCR</span>
		<span class="k">fi</span>
<span class="k">	elif</span> <span class="o">[</span> <span class="nv">$maj</span> <span class="o">=</span> CONSOLE <span class="o">]</span>; <span class="k">then</span>
<span class="k">		if</span> <span class="o">[</span> ! -d /dev/dasd <span class="o">]</span>; <span class="k">then</span>
<span class="k">			</span><span class="nb">echo </span>mknod <span class="nv">$D</span>/<span class="nv">$TUB$devno</span> c <span class="nv">$fsmaj</span> <span class="nv">$min</span> &gt;&gt; <span class="nv">$SCR</span>
		<span class="k">fi</span>
<span class="k">	else</span>
<span class="k">		if</span> <span class="o">[</span> ! -d /dev/dasd <span class="o">]</span>; <span class="k">then</span>
<span class="k">			</span><span class="nb">echo </span>mknod <span class="nv">$D</span>/<span class="nv">$TTY$devno</span> c <span class="nv">$maj</span> <span class="nv">$min</span> &gt;&gt;<span class="nv">$SCR</span>
			<span class="nb">echo </span>mknod <span class="nv">$D</span>/<span class="nv">$TUB$devno</span> c <span class="nv">$fsmaj</span> <span class="nv">$min</span> &gt;&gt; <span class="nv">$SCR</span>
		<span class="k">fi</span>
<span class="k">		</span><span class="nb">echo</span> <span class="s2">&quot;echo t$min$GETTYLINE $TTY$devno &gt;&gt; $NINITTAB&quot;</span> &gt;&gt; <span class="nv">$SCRTMP</span>
	<span class="k">fi</span>
<span class="k">done</span> &lt; <span class="nv">$P</span>

<span class="nb">echo </span>mv <span class="nv">$INITTAB</span> <span class="nv">$OINITTAB</span> &gt;&gt; <span class="nv">$SCRTMP</span> <span class="o">||</span> <span class="nb">exit </span>1
<span class="nb">echo </span>mv <span class="nv">$NINITTAB</span> <span class="nv">$INITTAB</span> &gt;&gt; <span class="nv">$SCRTMP</span>
cat <span class="nv">$SCRTMP</span> &gt;&gt; <span class="nv">$SCR</span>
rm <span class="nv">$SCRTMP</span>
<span class="nb">exit </span>0

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
