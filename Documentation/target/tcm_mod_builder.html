<!DOCTYPE html>
<html><head><title>joekychen/linux » Documentation › target › tcm_mod_builder.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>tcm_mod_builder.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="c">#!/usr/bin/python</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>The TCM v4 multi-protocol fabric module generation script for drivers/target/$NEW_MOD</p>

<p>Copyright (c) 2010 Rising Tide Systems
Copyright (c) 2010 Linux-iSCSI.org</p>

<p>Author: nab@kernel.org</p></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">subprocess</span> <span class="kn">as</span> <span class="nn">sub</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">optparse</span>

<span class="n">tcm_dir</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

<span class="n">fabric_ops</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">fabric_mod_dir</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
<span class="n">fabric_mod_port</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
<span class="n">fabric_mod_init_port</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

<span class="k">def</span> <span class="nf">tcm_mod_err</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
	<span class="k">print</span> <span class="n">msg</span>
	<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">tcm_mod_create_module_subdir</span><span class="p">(</span><span class="n">fabric_mod_dir_var</span><span class="p">):</span>

	<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">fabric_mod_dir_var</span><span class="p">)</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
		<span class="k">return</span> <span class="mi">1</span>

	<span class="k">print</span> <span class="s">&quot;Creating fabric_mod_dir: &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_dir_var</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">fabric_mod_dir_var</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
		<span class="n">tcm_mod_err</span><span class="p">(</span><span class="s">&quot;Unable to mkdir &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_dir_var</span><span class="p">)</span>

	<span class="k">return</span>

<span class="k">def</span> <span class="nf">tcm_mod_build_FC_include</span><span class="p">(</span><span class="n">fabric_mod_dir_var</span><span class="p">,</span> <span class="n">fabric_mod_name</span><span class="p">):</span>
	<span class="k">global</span> <span class="n">fabric_mod_port</span>
	<span class="k">global</span> <span class="n">fabric_mod_init_port</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

	<span class="n">f</span> <span class="o">=</span> <span class="n">fabric_mod_dir_var</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_base.h&quot;</span>
	<span class="k">print</span> <span class="s">&quot;Writing file: &quot;</span> <span class="o">+</span> <span class="n">f</span>

	<span class="n">p</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span>
		<span class="n">tcm_mod_err</span><span class="p">(</span><span class="s">&quot;Unable to open file: &quot;</span> <span class="o">+</span> <span class="n">f</span><span class="p">)</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="s">&quot;#define &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;_VERSION	</span><span class="se">\&quot;</span><span class="s">v0.1</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#define &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;_NAMELEN	32</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_nacl {</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* Binary World Wide unique Port Name for FC Initiator Nport */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	u64 nport_wwpn;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* ASCII formatted WWPN for FC Initiator Nport */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	char nport_name[&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;_NAMELEN];</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* Returned by &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_make_nodeacl() */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct se_node_acl se_node_acl;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;};</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tpg {</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* FC lport target portal group tag for TCM */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	u16 lport_tpgt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* Pointer back to &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_lport */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_lport *lport;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* Returned by &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_make_tpg() */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct se_portal_group se_tpg;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;};</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_lport {</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* SCSI protocol the lport is providing */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	u8 lport_proto_id;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* Binary World Wide unique Port Name for FC Target Lport */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	u64 lport_wwpn;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* ASCII formatted WWPN for FC Target Lport */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	char lport_name[&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;_NAMELEN];</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* Returned by &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_make_lport() */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct se_wwn lport_wwn;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;};</span><span class="se">\n</span><span class="s">&quot;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
		<span class="n">tcm_mod_err</span><span class="p">(</span><span class="s">&quot;Unable to write f: &quot;</span> <span class="o">+</span> <span class="n">f</span><span class="p">)</span>

	<span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

	<span class="n">fabric_mod_port</span> <span class="o">=</span> <span class="s">&quot;lport&quot;</span>
	<span class="n">fabric_mod_init_port</span> <span class="o">=</span> <span class="s">&quot;nport&quot;</span>

	<span class="k">return</span>

<span class="k">def</span> <span class="nf">tcm_mod_build_SAS_include</span><span class="p">(</span><span class="n">fabric_mod_dir_var</span><span class="p">,</span> <span class="n">fabric_mod_name</span><span class="p">):</span>
	<span class="k">global</span> <span class="n">fabric_mod_port</span>
	<span class="k">global</span> <span class="n">fabric_mod_init_port</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

	<span class="n">f</span> <span class="o">=</span> <span class="n">fabric_mod_dir_var</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_base.h&quot;</span>
	<span class="k">print</span> <span class="s">&quot;Writing file: &quot;</span> <span class="o">+</span> <span class="n">f</span>

	<span class="n">p</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span>
		<span class="n">tcm_mod_err</span><span class="p">(</span><span class="s">&quot;Unable to open file: &quot;</span> <span class="o">+</span> <span class="n">f</span><span class="p">)</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="s">&quot;#define &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;_VERSION  </span><span class="se">\&quot;</span><span class="s">v0.1</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#define &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;_NAMELEN 32</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_nacl {</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* Binary World Wide unique Port Name for SAS Initiator port */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	u64 iport_wwpn;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* ASCII formatted WWPN for Sas Initiator port */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	char iport_name[&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;_NAMELEN];</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* Returned by &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_make_nodeacl() */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct se_node_acl se_node_acl;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;};</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tpg {</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* SAS port target portal group tag for TCM */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	u16 tport_tpgt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* Pointer back to &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tport */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tport *tport;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* Returned by &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_make_tpg() */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct se_portal_group se_tpg;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;};</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tport {</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* SCSI protocol the tport is providing */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	u8 tport_proto_id;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* Binary World Wide unique Port Name for SAS Target port */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	u64 tport_wwpn;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* ASCII formatted WWPN for SAS Target port */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	char tport_name[&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;_NAMELEN];</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* Returned by &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_make_tport() */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct se_wwn tport_wwn;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;};</span><span class="se">\n</span><span class="s">&quot;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
		<span class="n">tcm_mod_err</span><span class="p">(</span><span class="s">&quot;Unable to write f: &quot;</span> <span class="o">+</span> <span class="n">f</span><span class="p">)</span>

	<span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

	<span class="n">fabric_mod_port</span> <span class="o">=</span> <span class="s">&quot;tport&quot;</span>
	<span class="n">fabric_mod_init_port</span> <span class="o">=</span> <span class="s">&quot;iport&quot;</span>

	<span class="k">return</span>

<span class="k">def</span> <span class="nf">tcm_mod_build_iSCSI_include</span><span class="p">(</span><span class="n">fabric_mod_dir_var</span><span class="p">,</span> <span class="n">fabric_mod_name</span><span class="p">):</span>
	<span class="k">global</span> <span class="n">fabric_mod_port</span>
	<span class="k">global</span> <span class="n">fabric_mod_init_port</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

	<span class="n">f</span> <span class="o">=</span> <span class="n">fabric_mod_dir_var</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_base.h&quot;</span>
	<span class="k">print</span> <span class="s">&quot;Writing file: &quot;</span> <span class="o">+</span> <span class="n">f</span>

	<span class="n">p</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span>
		<span class="n">tcm_mod_err</span><span class="p">(</span><span class="s">&quot;Unable to open file: &quot;</span> <span class="o">+</span> <span class="n">f</span><span class="p">)</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="s">&quot;#define &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;_VERSION  </span><span class="se">\&quot;</span><span class="s">v0.1</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#define &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;_NAMELEN 32</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_nacl {</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* ASCII formatted InitiatorName */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	char iport_name[&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;_NAMELEN];</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* Returned by &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_make_nodeacl() */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct se_node_acl se_node_acl;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;};</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tpg {</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* iSCSI target portal group tag for TCM */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	u16 tport_tpgt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* Pointer back to &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tport */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tport *tport;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* Returned by &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_make_tpg() */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct se_portal_group se_tpg;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;};</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tport {</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* SCSI protocol the tport is providing */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	u8 tport_proto_id;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* ASCII formatted TargetName for IQN */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	char tport_name[&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;_NAMELEN];</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* Returned by &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_make_tport() */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct se_wwn tport_wwn;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;};</span><span class="se">\n</span><span class="s">&quot;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
		<span class="n">tcm_mod_err</span><span class="p">(</span><span class="s">&quot;Unable to write f: &quot;</span> <span class="o">+</span> <span class="n">f</span><span class="p">)</span>

	<span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

	<span class="n">fabric_mod_port</span> <span class="o">=</span> <span class="s">&quot;tport&quot;</span>
	<span class="n">fabric_mod_init_port</span> <span class="o">=</span> <span class="s">&quot;iport&quot;</span>

	<span class="k">return</span>

<span class="k">def</span> <span class="nf">tcm_mod_build_base_includes</span><span class="p">(</span><span class="n">proto_ident</span><span class="p">,</span> <span class="n">fabric_mod_dir_val</span><span class="p">,</span> <span class="n">fabric_mod_name</span><span class="p">):</span>

	<span class="k">if</span> <span class="n">proto_ident</span> <span class="o">==</span> <span class="s">&quot;FC&quot;</span><span class="p">:</span>
		<span class="n">tcm_mod_build_FC_include</span><span class="p">(</span><span class="n">fabric_mod_dir_val</span><span class="p">,</span> <span class="n">fabric_mod_name</span><span class="p">)</span>
	<span class="k">elif</span> <span class="n">proto_ident</span> <span class="o">==</span> <span class="s">&quot;SAS&quot;</span><span class="p">:</span>
		<span class="n">tcm_mod_build_SAS_include</span><span class="p">(</span><span class="n">fabric_mod_dir_val</span><span class="p">,</span> <span class="n">fabric_mod_name</span><span class="p">)</span>
	<span class="k">elif</span> <span class="n">proto_ident</span> <span class="o">==</span> <span class="s">&quot;iSCSI&quot;</span><span class="p">:</span>
		<span class="n">tcm_mod_build_iSCSI_include</span><span class="p">(</span><span class="n">fabric_mod_dir_val</span><span class="p">,</span> <span class="n">fabric_mod_name</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">print</span> <span class="s">&quot;Unsupported proto_ident: &quot;</span> <span class="o">+</span> <span class="n">proto_ident</span>
		<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

	<span class="k">return</span>

<span class="k">def</span> <span class="nf">tcm_mod_build_configfs</span><span class="p">(</span><span class="n">proto_ident</span><span class="p">,</span> <span class="n">fabric_mod_dir_var</span><span class="p">,</span> <span class="n">fabric_mod_name</span><span class="p">):</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

	<span class="n">f</span> <span class="o">=</span> <span class="n">fabric_mod_dir_var</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_configfs.c&quot;</span>
	<span class="k">print</span> <span class="s">&quot;Writing file: &quot;</span> <span class="o">+</span> <span class="n">f</span>

        <span class="n">p</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span>
                <span class="n">tcm_mod_err</span><span class="p">(</span><span class="s">&quot;Unable to open file: &quot;</span> <span class="o">+</span> <span class="n">f</span><span class="p">)</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="s">&quot;#include &lt;linux/module.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;linux/moduleparam.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;linux/version.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;generated/utsrelease.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;linux/utsname.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;linux/init.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;linux/slab.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;linux/kthread.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;linux/types.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;linux/string.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;linux/configfs.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;linux/ctype.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;asm/unaligned.h&gt;</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;target/target_core_base.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;target/target_core_fabric.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;target/target_core_fabric_configfs.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;target/target_core_configfs.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;target/configfs_macros.h&gt;</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include </span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_base.h</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include </span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_fabric.h</span><span class="se">\&quot;\n\n</span><span class="s">&quot;</span>

	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;/* Local pointer to allocated TCM configfs fabric module */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;struct target_fabric_configfs *&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_fabric_configfs;</span><span class="se">\n\n</span><span class="s">&quot;</span>

	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;static struct se_node_acl *&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_make_nodeacl(</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct se_portal_group *se_tpg,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct config_group *group,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	const char *name)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct se_node_acl *se_nacl, *se_nacl_new;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_nacl *nacl;</span><span class="se">\n</span><span class="s">&quot;</span>

	<span class="k">if</span> <span class="n">proto_ident</span> <span class="o">==</span> <span class="s">&quot;FC&quot;</span> <span class="ow">or</span> <span class="n">proto_ident</span> <span class="o">==</span> <span class="s">&quot;SAS&quot;</span><span class="p">:</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	u64 wwpn = 0;</span><span class="se">\n</span><span class="s">&quot;</span>

	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	u32 nexus_depth;</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_parse_wwn(name, &amp;wwpn, 1) &lt; 0)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		return ERR_PTR(-EINVAL); */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	se_nacl_new = &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_alloc_fabric_acl(se_tpg);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	if (!se_nacl_new)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		return ERR_PTR(-ENOMEM);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;//#warning FIXME: Hardcoded nexus depth in &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_make_nodeacl()</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	nexus_depth = 1;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/*</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	 * se_nacl_new may be released by core_tpg_add_initiator_node_acl()</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	 * when converting a NodeACL from demo mode -&gt; explict</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	 */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	se_nacl = core_tpg_add_initiator_node_acl(se_tpg, se_nacl_new,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;				name, nexus_depth);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	if (IS_ERR(se_nacl)) {</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_release_fabric_acl(se_tpg, se_nacl_new);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		return se_nacl;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	}</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/*</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	 * Locate our struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_nacl and set the FC Nport WWPN</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	 */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	nacl = container_of(se_nacl, struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_nacl, se_node_acl);</span><span class="se">\n</span><span class="s">&quot;</span>

	<span class="k">if</span> <span class="n">proto_ident</span> <span class="o">==</span> <span class="s">&quot;FC&quot;</span> <span class="ow">or</span> <span class="n">proto_ident</span> <span class="o">==</span> <span class="s">&quot;SAS&quot;</span><span class="p">:</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	nacl-&gt;&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_init_port</span> <span class="o">+</span> <span class="s">&quot;_wwpn = wwpn;</span><span class="se">\n</span><span class="s">&quot;</span>

	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_format_wwn(&amp;nacl-&gt;&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_init_port</span> <span class="o">+</span> <span class="s">&quot;_name[0], &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;_NAMELEN, wwpn); */</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return se_nacl;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;static void &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_drop_nodeacl(struct se_node_acl *se_acl)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_nacl *nacl = container_of(se_acl,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;				struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_nacl, se_node_acl);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	core_tpg_del_initiator_node_acl(se_acl-&gt;se_tpg, se_acl, 1);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	kfree(nacl);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>

	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;static struct se_portal_group *&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_make_tpg(</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct se_wwn *wwn,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct config_group *group,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	const char *name)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;*&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot; = container_of(wwn,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;			struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;_wwn);</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tpg *tpg;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	unsigned long tpgt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	int ret;</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	if (strstr(name, </span><span class="se">\&quot;</span><span class="s">tpgt_</span><span class="se">\&quot;</span><span class="s">) != name)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		return ERR_PTR(-EINVAL);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	if (strict_strtoul(name + 5, 10, &amp;tpgt) || tpgt &gt; UINT_MAX)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		return ERR_PTR(-EINVAL);</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	tpg = kzalloc(sizeof(struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tpg), GFP_KERNEL);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	if (!tpg) {</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		printk(KERN_ERR </span><span class="se">\&quot;</span><span class="s">Unable to allocate struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tpg</span><span class="se">\&quot;</span><span class="s">);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		return ERR_PTR(-ENOMEM);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	}</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	tpg-&gt;&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot; = &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	tpg-&gt;&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;_tpgt = tpgt;</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	ret = core_tpg_register(&amp;&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_fabric_configfs-&gt;tf_ops, wwn,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;				&amp;tpg-&gt;se_tpg, (void *)tpg,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;				TRANSPORT_TPG_TYPE_NORMAL);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	if (ret &lt; 0) {</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		kfree(tpg);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		return NULL;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	}</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return &amp;tpg-&gt;se_tpg;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;static void &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_drop_tpg(struct se_portal_group *se_tpg)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tpg *tpg = container_of(se_tpg,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;				struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tpg, se_tpg);</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	core_tpg_deregister(se_tpg);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	kfree(tpg);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>

	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;static struct se_wwn *&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_make_&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;(</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct target_fabric_configfs *tf,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct config_group *group,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	const char *name)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot; *&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;;</span><span class="se">\n</span><span class="s">&quot;</span>

	<span class="k">if</span> <span class="n">proto_ident</span> <span class="o">==</span> <span class="s">&quot;FC&quot;</span> <span class="ow">or</span> <span class="n">proto_ident</span> <span class="o">==</span> <span class="s">&quot;SAS&quot;</span><span class="p">:</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	u64 wwpn = 0;</span><span class="se">\n\n</span><span class="s">&quot;</span>

	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* if (&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_parse_wwn(name, &amp;wwpn, 1) &lt; 0)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		return ERR_PTR(-EINVAL); */</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot; = kzalloc(sizeof(struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;), GFP_KERNEL);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	if (!&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;) {</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		printk(KERN_ERR </span><span class="se">\&quot;</span><span class="s">Unable to allocate struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		return ERR_PTR(-ENOMEM);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	}</span><span class="se">\n</span><span class="s">&quot;</span>

	<span class="k">if</span> <span class="n">proto_ident</span> <span class="o">==</span> <span class="s">&quot;FC&quot;</span> <span class="ow">or</span> <span class="n">proto_ident</span> <span class="o">==</span> <span class="s">&quot;SAS&quot;</span><span class="p">:</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;-&gt;&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;_wwpn = wwpn;</span><span class="se">\n</span><span class="s">&quot;</span>

	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/* &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_format_wwn(&amp;&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;-&gt;&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;_name[0], &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;_NAMELEN, wwpn); */</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return &amp;&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;-&gt;&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;_wwn;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;static void &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_drop_&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;(struct se_wwn *wwn)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot; *&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot; = container_of(wwn,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;				struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;_wwn);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	kfree(&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;static ssize_t &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_wwn_show_attr_version(</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct target_fabric_configfs *tf,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	char *page)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return sprintf(page, </span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; fabric module </span><span class="si">%s</span><span class="s"> on </span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		</span><span class="se">\&quot;</span><span class="s">on </span><span class="se">\&quot;</span><span class="s">UTS_RELEASE</span><span class="se">\&quot;\\</span><span class="s">n</span><span class="se">\&quot;</span><span class="s">, &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;_VERSION, utsname()-&gt;sysname,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		utsname()-&gt;machine);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;TF_WWN_ATTR_RO(&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;, version);</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;static struct configfs_attribute *&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_wwn_attrs[] = {</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	&amp;&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_wwn_version.attr,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	NULL,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;};</span><span class="se">\n\n</span><span class="s">&quot;</span>

	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;static struct target_core_fabric_ops &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_ops = {</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.get_fabric_name		= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_fabric_name,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.get_fabric_proto_ident		= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_fabric_proto_ident,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.tpg_get_wwn			= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_fabric_wwn,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.tpg_get_tag			= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_tag,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.tpg_get_default_depth		= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_default_depth,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.tpg_get_pr_transport_id	= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_pr_transport_id,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.tpg_get_pr_transport_id_len	= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_pr_transport_id_len,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.tpg_parse_pr_out_transport_id	= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_parse_pr_out_transport_id,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.tpg_check_demo_mode		= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_check_false,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.tpg_check_demo_mode_cache	= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_check_true,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.tpg_check_demo_mode_write_protect = &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_check_true,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.tpg_check_prod_mode_write_protect = &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_check_false,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.tpg_alloc_fabric_acl		= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_alloc_fabric_acl,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.tpg_release_fabric_acl		= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_release_fabric_acl,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.tpg_get_inst_index		= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tpg_get_inst_index,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.release_cmd			= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_release_cmd,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.shutdown_session		= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_shutdown_session,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.close_session			= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_close_session,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.stop_session			= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_stop_session,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.fall_back_to_erl0		= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_reset_nexus,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.sess_logged_in			= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_sess_logged_in,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.sess_get_index			= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_sess_get_index,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.sess_get_initiator_sid		= NULL,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.write_pending			= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_write_pending,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.write_pending_status		= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_write_pending_status,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.set_default_node_attributes	= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_set_default_node_attrs,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.get_task_tag			= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_task_tag,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.get_cmd_state			= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_cmd_state,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.queue_data_in			= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_queue_data_in,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.queue_status			= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_queue_status,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.queue_tm_rsp			= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_queue_tm_rsp,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.get_fabric_sense_len		= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_fabric_sense_len,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.set_fabric_sense_len		= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_set_fabric_sense_len,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.is_state_remove		= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_is_state_remove,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/*</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	 * Setup function pointers for generic logic in target_core_fabric_configfs.c</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	 */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.fabric_make_wwn		= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_make_&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.fabric_drop_wwn		= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_drop_&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.fabric_make_tpg		= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_make_tpg,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.fabric_drop_tpg		= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_drop_tpg,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.fabric_post_link		= NULL,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.fabric_pre_unlink		= NULL,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.fabric_make_np			= NULL,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.fabric_drop_np			= NULL,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.fabric_make_nodeacl		= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_make_nodeacl,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	.fabric_drop_nodeacl		= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_drop_nodeacl,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;};</span><span class="se">\n\n</span><span class="s">&quot;</span>

	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;static int &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_register_configfs(void)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct target_fabric_configfs *fabric;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	int ret;</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	printk(KERN_INFO </span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; fabric module </span><span class="si">%s</span><span class="s"> on </span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		</span><span class="se">\&quot;</span><span class="s"> on </span><span class="se">\&quot;</span><span class="s">UTS_RELEASE</span><span class="se">\&quot;\\</span><span class="s">n</span><span class="se">\&quot;</span><span class="s">,&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;_VERSION, utsname()-&gt;sysname,</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		utsname()-&gt;machine);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/*</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	 * Register the top level struct config_item_type with TCM core</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	 */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	fabric = target_fabric_configfs_init(THIS_MODULE, </span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	if (IS_ERR(fabric)) {</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		printk(KERN_ERR </span><span class="se">\&quot;</span><span class="s">target_fabric_configfs_init() failed</span><span class="se">\\</span><span class="s">n</span><span class="se">\&quot;</span><span class="s">);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		return PTR_ERR(fabric);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	}</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/*</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	 * Setup fabric-&gt;tf_ops from our local &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_ops</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	 */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	fabric-&gt;tf_ops = &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_ops;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/*</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	 * Setup default attribute lists for various fabric-&gt;tf_cit_tmpl</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	 */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	TF_CIT_TMPL(fabric)-&gt;tfc_wwn_cit.ct_attrs = &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_wwn_attrs;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	TF_CIT_TMPL(fabric)-&gt;tfc_tpg_base_cit.ct_attrs = NULL;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	TF_CIT_TMPL(fabric)-&gt;tfc_tpg_attrib_cit.ct_attrs = NULL;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	TF_CIT_TMPL(fabric)-&gt;tfc_tpg_param_cit.ct_attrs = NULL;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	TF_CIT_TMPL(fabric)-&gt;tfc_tpg_np_base_cit.ct_attrs = NULL;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	TF_CIT_TMPL(fabric)-&gt;tfc_tpg_nacl_base_cit.ct_attrs = NULL;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	TF_CIT_TMPL(fabric)-&gt;tfc_tpg_nacl_attrib_cit.ct_attrs = NULL;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	TF_CIT_TMPL(fabric)-&gt;tfc_tpg_nacl_auth_cit.ct_attrs = NULL;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	TF_CIT_TMPL(fabric)-&gt;tfc_tpg_nacl_param_cit.ct_attrs = NULL;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/*</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	 * Register the fabric for use within TCM</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	 */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	ret = target_fabric_configfs_register(fabric);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	if (ret &lt; 0) {</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		printk(KERN_ERR </span><span class="se">\&quot;</span><span class="s">target_fabric_configfs_register() failed</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;				</span><span class="se">\&quot;</span><span class="s"> for &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">n</span><span class="se">\&quot;</span><span class="s">);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		return ret;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	}</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	/*</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	 * Setup our local pointer to *fabric</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	 */</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_fabric_configfs = fabric;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	printk(KERN_INFO </span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">+</span>  <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;[0] - Set fabric -&gt; &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_fabric_configfs</span><span class="se">\\</span><span class="s">n</span><span class="se">\&quot;</span><span class="s">);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return 0;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;};</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;static void __exit &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_deregister_configfs(void)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	if (!&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_fabric_configfs)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		return;</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	target_fabric_configfs_deregister(&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_fabric_configfs);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_fabric_configfs = NULL;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	printk(KERN_INFO </span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">+</span>  <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;[0] - Cleared &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_fabric_configfs</span><span class="se">\\</span><span class="s">n</span><span class="se">\&quot;</span><span class="s">);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;};</span><span class="se">\n\n</span><span class="s">&quot;</span>

	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;static int __init &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_init(void)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	int ret;</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	ret = &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_register_configfs();</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	if (ret &lt; 0)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		return ret;</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return 0;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;};</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;static void __exit &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_exit(void)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_deregister_configfs();</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;};</span><span class="se">\n\n</span><span class="s">&quot;</span>

	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;MODULE_DESCRIPTION(</span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; series fabric driver</span><span class="se">\&quot;</span><span class="s">);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;MODULE_LICENSE(</span><span class="se">\&quot;</span><span class="s">GPL</span><span class="se">\&quot;</span><span class="s">);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;module_init(&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_init);</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;module_exit(&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_exit);</span><span class="se">\n</span><span class="s">&quot;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
		<span class="n">tcm_mod_err</span><span class="p">(</span><span class="s">&quot;Unable to write f: &quot;</span> <span class="o">+</span> <span class="n">f</span><span class="p">)</span>

	<span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

	<span class="k">return</span>

<span class="k">def</span> <span class="nf">tcm_mod_scan_fabric_ops</span><span class="p">(</span><span class="n">tcm_dir</span><span class="p">):</span>

	<span class="n">fabric_ops_api</span> <span class="o">=</span> <span class="n">tcm_dir</span> <span class="o">+</span> <span class="s">&quot;include/target/target_core_fabric.h&quot;</span>

	<span class="k">print</span> <span class="s">&quot;Using tcm_mod_scan_fabric_ops: &quot;</span> <span class="o">+</span> <span class="n">fabric_ops_api</span>
	<span class="n">process_fo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fabric_ops_api</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>

	<span class="n">line</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
	<span class="k">while</span> <span class="n">line</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">process_fo</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;struct target_core_fabric_ops {&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
			<span class="n">line</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
			<span class="k">continue</span>

		<span class="k">if</span> <span class="n">process_fo</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">process_fo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">line</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Search for function pointer</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;\(\*&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
				<span class="k">continue</span>

			<span class="n">fabric_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
			<span class="k">continue</span>

		<span class="n">line</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Search for function pointer</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;\(\*&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
			<span class="k">continue</span>

		<span class="n">fabric_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>

	<span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
	<span class="k">return</span>

<span class="k">def</span> <span class="nf">tcm_mod_dump_fabric_ops</span><span class="p">(</span><span class="n">proto_ident</span><span class="p">,</span> <span class="n">fabric_mod_dir_var</span><span class="p">,</span> <span class="n">fabric_mod_name</span><span class="p">):</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
	<span class="n">bufi</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

	<span class="n">f</span> <span class="o">=</span> <span class="n">fabric_mod_dir_var</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_fabric.c&quot;</span>
	<span class="k">print</span> <span class="s">&quot;Writing file: &quot;</span> <span class="o">+</span> <span class="n">f</span>

	<span class="n">p</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span>
		<span class="n">tcm_mod_err</span><span class="p">(</span><span class="s">&quot;Unable to open file: &quot;</span> <span class="o">+</span> <span class="n">f</span><span class="p">)</span>

	<span class="n">fi</span> <span class="o">=</span> <span class="n">fabric_mod_dir_var</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_fabric.h&quot;</span>
	<span class="k">print</span> <span class="s">&quot;Writing file: &quot;</span> <span class="o">+</span> <span class="n">fi</span>

	<span class="n">pi</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">pi</span><span class="p">:</span>
		<span class="n">tcm_mod_err</span><span class="p">(</span><span class="s">&quot;Unable to open file: &quot;</span> <span class="o">+</span> <span class="n">fi</span><span class="p">)</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="s">&quot;#include &lt;linux/slab.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;linux/kthread.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;linux/types.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;linux/list.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;linux/types.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;linux/string.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;linux/ctype.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;asm/unaligned.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;scsi/scsi.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;scsi/scsi_host.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;scsi/scsi_device.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;scsi/scsi_cmnd.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;scsi/libfc.h&gt;</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;target/target_core_base.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;target/target_core_fabric.h&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include &lt;target/target_core_configfs.h&gt;</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include </span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_base.h</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;#include </span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_fabric.h</span><span class="se">\&quot;\n\n</span><span class="s">&quot;</span>

	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;int &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_check_true(struct se_portal_group *se_tpg)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return 1;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;int &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_check_true(struct se_portal_group *);</span><span class="se">\n</span><span class="s">&quot;</span>

	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;int &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_check_false(struct se_portal_group *se_tpg)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return 0;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
	<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;int &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_check_false(struct se_portal_group *);</span><span class="se">\n</span><span class="s">&quot;</span>

	<span class="n">total_fabric_ops</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fabric_ops</span><span class="p">)</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

	<span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">total_fabric_ops</span><span class="p">:</span>
		<span class="n">fo</span> <span class="o">=</span> <span class="n">fabric_ops</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><pre><code>print "fabric_ops: " + fo
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;get_fabric_name&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;char *&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_fabric_name(void)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return </span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;char *&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_fabric_name(void);</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="k">continue</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;get_fabric_proto_ident&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;u8 &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_fabric_proto_ident(struct se_portal_group *se_tpg)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tpg *tpg = container_of(se_tpg,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;				struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tpg, se_tpg);</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot; *&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot; = tpg-&gt;&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	u8 proto_id;</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	switch (&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;-&gt;&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;_proto_id) {</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="k">if</span> <span class="n">proto_ident</span> <span class="o">==</span> <span class="s">&quot;FC&quot;</span><span class="p">:</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	case SCSI_PROTOCOL_FCP:</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	default:</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		proto_id = fc_get_fabric_proto_ident(se_tpg);</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		break;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="k">elif</span> <span class="n">proto_ident</span> <span class="o">==</span> <span class="s">&quot;SAS&quot;</span><span class="p">:</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	case SCSI_PROTOCOL_SAS:</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	default:</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		proto_id = sas_get_fabric_proto_ident(se_tpg);</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		break;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="k">elif</span> <span class="n">proto_ident</span> <span class="o">==</span> <span class="s">&quot;iSCSI&quot;</span><span class="p">:</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	case SCSI_PROTOCOL_ISCSI:</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	default:</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		proto_id = iscsi_get_fabric_proto_ident(se_tpg);</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		break;</span><span class="se">\n</span><span class="s">&quot;</span>

			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return proto_id;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;u8 &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_fabric_proto_ident(struct se_portal_group *);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;get_wwn&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;char *&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_fabric_wwn(struct se_portal_group *se_tpg)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tpg *tpg = container_of(se_tpg,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;				struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tpg, se_tpg);</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot; *&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot; = tpg-&gt;&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;;</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return &amp;&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;-&gt;&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;_name[0];</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;char *&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_fabric_wwn(struct se_portal_group *);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;get_tag&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;u16 &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_tag(struct se_portal_group *se_tpg)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tpg *tpg = container_of(se_tpg,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;				struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tpg, se_tpg);</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return tpg-&gt;&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;_tpgt;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;u16 &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_tag(struct se_portal_group *);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;get_default_depth&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;u32 &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_default_depth(struct se_portal_group *se_tpg)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return 1;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;u32 &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_default_depth(struct se_portal_group *);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;get_pr_transport_id\)\(&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;u32 &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_pr_transport_id(</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct se_portal_group *se_tpg,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct se_node_acl *se_nacl,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct t10_pr_registration *pr_reg,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	int *format_code,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	unsigned char *buf)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tpg *tpg = container_of(se_tpg,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;				struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tpg, se_tpg);</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot; *&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot; = tpg-&gt;&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	int ret = 0;</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	switch (&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;-&gt;&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;_proto_id) {</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="k">if</span> <span class="n">proto_ident</span> <span class="o">==</span> <span class="s">&quot;FC&quot;</span><span class="p">:</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	case SCSI_PROTOCOL_FCP:</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	default:</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		ret = fc_get_pr_transport_id(se_tpg, se_nacl, pr_reg,</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;					format_code, buf);</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		break;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="k">elif</span> <span class="n">proto_ident</span> <span class="o">==</span> <span class="s">&quot;SAS&quot;</span><span class="p">:</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	case SCSI_PROTOCOL_SAS:</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	default:</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		ret = sas_get_pr_transport_id(se_tpg, se_nacl, pr_reg,</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;					format_code, buf);</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		break;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="k">elif</span> <span class="n">proto_ident</span> <span class="o">==</span> <span class="s">&quot;iSCSI&quot;</span><span class="p">:</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	case SCSI_PROTOCOL_ISCSI:</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	default:</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		ret = iscsi_get_pr_transport_id(se_tpg, se_nacl, pr_reg,</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;					format_code, buf);</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		break;</span><span class="se">\n</span><span class="s">&quot;</span>

			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return ret;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;u32 &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_pr_transport_id(struct se_portal_group *,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;			struct se_node_acl *, struct t10_pr_registration *,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;			int *, unsigned char *);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;get_pr_transport_id_len\)\(&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;u32 &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_pr_transport_id_len(</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct se_portal_group *se_tpg,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct se_node_acl *se_nacl,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct t10_pr_registration *pr_reg,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	int *format_code)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tpg *tpg = container_of(se_tpg,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;				struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tpg, se_tpg);</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot; *&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot; = tpg-&gt;&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	int ret = 0;</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	switch (&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;-&gt;&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;_proto_id) {</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="k">if</span> <span class="n">proto_ident</span> <span class="o">==</span> <span class="s">&quot;FC&quot;</span><span class="p">:</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	case SCSI_PROTOCOL_FCP:</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	default:</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		ret = fc_get_pr_transport_id_len(se_tpg, se_nacl, pr_reg,</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;					format_code);</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		break;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="k">elif</span> <span class="n">proto_ident</span> <span class="o">==</span> <span class="s">&quot;SAS&quot;</span><span class="p">:</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	case SCSI_PROTOCOL_SAS:</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	default:</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		ret = sas_get_pr_transport_id_len(se_tpg, se_nacl, pr_reg,</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;					format_code);</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		break;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="k">elif</span> <span class="n">proto_ident</span> <span class="o">==</span> <span class="s">&quot;iSCSI&quot;</span><span class="p">:</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	case SCSI_PROTOCOL_ISCSI:</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	default:</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		ret = iscsi_get_pr_transport_id_len(se_tpg, se_nacl, pr_reg,</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;					format_code);</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		break;</span><span class="se">\n</span><span class="s">&quot;</span>


			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return ret;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;u32 &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_pr_transport_id_len(struct se_portal_group *,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;			struct se_node_acl *, struct t10_pr_registration *,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;			int *);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;parse_pr_out_transport_id\)\(&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;char *&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_parse_pr_out_transport_id(</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct se_portal_group *se_tpg,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	const char *buf,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	u32 *out_tid_len,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	char **port_nexus_ptr)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tpg *tpg = container_of(se_tpg,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;				struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tpg, se_tpg);</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot; *&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot; = tpg-&gt;&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	char *tid = NULL;</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	switch (&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;-&gt;&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_port</span> <span class="o">+</span> <span class="s">&quot;_proto_id) {</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="k">if</span> <span class="n">proto_ident</span> <span class="o">==</span> <span class="s">&quot;FC&quot;</span><span class="p">:</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	case SCSI_PROTOCOL_FCP:</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	default:</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		tid = fc_parse_pr_out_transport_id(se_tpg, buf, out_tid_len,</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;					port_nexus_ptr);</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="k">elif</span> <span class="n">proto_ident</span> <span class="o">==</span> <span class="s">&quot;SAS&quot;</span><span class="p">:</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	case SCSI_PROTOCOL_SAS:</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	default:</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		tid = sas_parse_pr_out_transport_id(se_tpg, buf, out_tid_len,</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;					port_nexus_ptr);</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="k">elif</span> <span class="n">proto_ident</span> <span class="o">==</span> <span class="s">&quot;iSCSI&quot;</span><span class="p">:</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	case SCSI_PROTOCOL_ISCSI:</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	default:</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		tid = iscsi_parse_pr_out_transport_id(se_tpg, buf, out_tid_len,</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;					port_nexus_ptr);</span><span class="se">\n</span><span class="s">&quot;</span>

			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return tid;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;char *&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_parse_pr_out_transport_id(struct se_portal_group *,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span>	<span class="s">&quot;			const char *, u32 *, char **);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;alloc_fabric_acl\)\(&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;struct se_node_acl *&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_alloc_fabric_acl(struct se_portal_group *se_tpg)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_nacl *nacl;</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	nacl = kzalloc(sizeof(struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_nacl), GFP_KERNEL);</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	if (!nacl) {</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		printk(KERN_ERR </span><span class="se">\&quot;</span><span class="s">Unable to allocate struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_nacl</span><span class="se">\\</span><span class="s">n</span><span class="se">\&quot;</span><span class="s">);</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;		return NULL;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return &amp;nacl-&gt;se_node_acl;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;struct se_node_acl *&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_alloc_fabric_acl(struct se_portal_group *);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;release_fabric_acl\)\(&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;void &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_release_fabric_acl(</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct se_portal_group *se_tpg,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct se_node_acl *se_nacl)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_nacl *nacl = container_of(se_nacl,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;			struct &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_nacl, se_node_acl);</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	kfree(nacl);</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;void &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_release_fabric_acl(struct se_portal_group *,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span>	<span class="s">&quot;			struct se_node_acl *);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;tpg_get_inst_index\)\(&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;u32 &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tpg_get_inst_index(struct se_portal_group *se_tpg)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return 1;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;u32 &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_tpg_get_inst_index(struct se_portal_group *);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;\*release_cmd\)\(&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;void &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_release_cmd(struct se_cmd *se_cmd)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;void &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_release_cmd(struct se_cmd *);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;shutdown_session\)\(&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;int &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_shutdown_session(struct se_session *se_sess)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return 0;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;int &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_shutdown_session(struct se_session *);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;close_session\)\(&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;void &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_close_session(struct se_session *se_sess)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;void &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_close_session(struct se_session *);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;stop_session\)\(&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;void &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_stop_session(struct se_session *se_sess, int sess_sleep , int conn_sleep)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;void &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_stop_session(struct se_session *, int, int);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;fall_back_to_erl0\)\(&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;void &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_reset_nexus(struct se_session *se_sess)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;void &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_reset_nexus(struct se_session *);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;sess_logged_in\)\(&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;int &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_sess_logged_in(struct se_session *se_sess)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return 0;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;int &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_sess_logged_in(struct se_session *);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;sess_get_index\)\(&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;u32 &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_sess_get_index(struct se_session *se_sess)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return 0;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;u32 &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_sess_get_index(struct se_session *);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;write_pending\)\(&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;int &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_write_pending(struct se_cmd *se_cmd)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return 0;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;int &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_write_pending(struct se_cmd *);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;write_pending_status\)\(&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;int &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_write_pending_status(struct se_cmd *se_cmd)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return 0;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;int &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_write_pending_status(struct se_cmd *);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;set_default_node_attributes\)\(&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;void &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_set_default_node_attrs(struct se_node_acl *nacl)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;void &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_set_default_node_attrs(struct se_node_acl *);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;get_task_tag\)\(&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;u32 &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_task_tag(struct se_cmd *se_cmd)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return 0;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;u32 &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_task_tag(struct se_cmd *);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;get_cmd_state\)\(&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;int &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_cmd_state(struct se_cmd *se_cmd)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return 0;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;int &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_cmd_state(struct se_cmd *);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;queue_data_in\)\(&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;int &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_queue_data_in(struct se_cmd *se_cmd)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return 0;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;int &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_queue_data_in(struct se_cmd *);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;queue_status\)\(&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;int &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_queue_status(struct se_cmd *se_cmd)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return 0;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;int &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_queue_status(struct se_cmd *);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;queue_tm_rsp\)\(&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;int &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_queue_tm_rsp(struct se_cmd *se_cmd)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return 0;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;int &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_queue_tm_rsp(struct se_cmd *);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;get_fabric_sense_len\)\(&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;u16 &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_fabric_sense_len(void)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return 0;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;u16 &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_get_fabric_sense_len(void);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;set_fabric_sense_len\)\(&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;u16 &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_set_fabric_sense_len(struct se_cmd *se_cmd, u32 sense_length)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return 0;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;u16 &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_set_fabric_sense_len(struct se_cmd *, u32);</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;is_state_remove\)\(&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="p">):</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;int &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_is_state_remove(struct se_cmd *se_cmd)</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	return 0;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n\n</span><span class="s">&quot;</span>
			<span class="n">bufi</span> <span class="o">+=</span> <span class="s">&quot;int &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_is_state_remove(struct se_cmd *);</span><span class="se">\n</span><span class="s">&quot;</span>


	<span class="n">ret</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
		<span class="n">tcm_mod_err</span><span class="p">(</span><span class="s">&quot;Unable to write f: &quot;</span> <span class="o">+</span> <span class="n">f</span><span class="p">)</span>

	<span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pi</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bufi</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
		<span class="n">tcm_mod_err</span><span class="p">(</span><span class="s">&quot;Unable to write fi: &quot;</span> <span class="o">+</span> <span class="n">fi</span><span class="p">)</span>

	<span class="n">pi</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
	<span class="k">return</span>

<span class="k">def</span> <span class="nf">tcm_mod_build_kbuild</span><span class="p">(</span><span class="n">fabric_mod_dir_var</span><span class="p">,</span> <span class="n">fabric_mod_name</span><span class="p">):</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
	<span class="n">f</span> <span class="o">=</span> <span class="n">fabric_mod_dir_var</span> <span class="o">+</span> <span class="s">&quot;/Makefile&quot;</span>
	<span class="k">print</span> <span class="s">&quot;Writing file: &quot;</span> <span class="o">+</span> <span class="n">f</span>

	<span class="n">p</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span>
		<span class="n">tcm_mod_err</span><span class="p">(</span><span class="s">&quot;Unable to open file: &quot;</span> <span class="o">+</span> <span class="n">f</span><span class="p">)</span>

	<span class="n">buf</span> <span class="o">+=</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;-objs			:= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_fabric.o </span><span class="se">\\\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;					   &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;_configfs.o</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;obj-$(CONFIG_&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;)		+= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;.o</span><span class="se">\n</span><span class="s">&quot;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
		<span class="n">tcm_mod_err</span><span class="p">(</span><span class="s">&quot;Unable to write f: &quot;</span> <span class="o">+</span> <span class="n">f</span><span class="p">)</span>

	<span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
	<span class="k">return</span>

<span class="k">def</span> <span class="nf">tcm_mod_build_kconfig</span><span class="p">(</span><span class="n">fabric_mod_dir_var</span><span class="p">,</span> <span class="n">fabric_mod_name</span><span class="p">):</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
	<span class="n">f</span> <span class="o">=</span> <span class="n">fabric_mod_dir_var</span> <span class="o">+</span> <span class="s">&quot;/Kconfig&quot;</span>
	<span class="k">print</span> <span class="s">&quot;Writing file: &quot;</span> <span class="o">+</span> <span class="n">f</span>

	<span class="n">p</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span>
		<span class="n">tcm_mod_err</span><span class="p">(</span><span class="s">&quot;Unable to open file: &quot;</span> <span class="o">+</span> <span class="n">f</span><span class="p">)</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="s">&quot;config &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	tristate </span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; fabric module</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	depends on TARGET_CORE &amp;&amp; CONFIGFS_FS</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	default n</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	---help---</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;	Say Y here to enable the &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; fabric module</span><span class="se">\n</span><span class="s">&quot;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
		<span class="n">tcm_mod_err</span><span class="p">(</span><span class="s">&quot;Unable to write f: &quot;</span> <span class="o">+</span> <span class="n">f</span><span class="p">)</span>

	<span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
	<span class="k">return</span>

<span class="k">def</span> <span class="nf">tcm_mod_add_kbuild</span><span class="p">(</span><span class="n">tcm_dir</span><span class="p">,</span> <span class="n">fabric_mod_name</span><span class="p">):</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="s">&quot;obj-$(CONFIG_&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;)	+= &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;/</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="n">kbuild</span> <span class="o">=</span> <span class="n">tcm_dir</span> <span class="o">+</span> <span class="s">&quot;/drivers/target/Makefile&quot;</span>

	<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">kbuild</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span>
	<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
	<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
	<span class="k">return</span>

<span class="k">def</span> <span class="nf">tcm_mod_add_kconfig</span><span class="p">(</span><span class="n">tcm_dir</span><span class="p">,</span> <span class="n">fabric_mod_name</span><span class="p">):</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="s">&quot;source </span><span class="se">\&quot;</span><span class="s">drivers/target/&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;/Kconfig</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
	<span class="n">kconfig</span> <span class="o">=</span> <span class="n">tcm_dir</span> <span class="o">+</span> <span class="s">&quot;/drivers/target/Kconfig&quot;</span>

	<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">kconfig</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span>
	<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
	<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
	<span class="k">return</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">modname</span><span class="p">,</span> <span class="n">proto_ident</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>proto<em>ident = "FC"
proto</em>ident = "SAS"
proto_ident = "iSCSI"</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tcm_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">();</span>
	<span class="n">tcm_dir</span> <span class="o">+=</span> <span class="s">&quot;/../../&quot;</span>
	<span class="k">print</span> <span class="s">&quot;tcm_dir: &quot;</span> <span class="o">+</span> <span class="n">tcm_dir</span>
	<span class="n">fabric_mod_name</span> <span class="o">=</span> <span class="n">modname</span>
	<span class="n">fabric_mod_dir</span> <span class="o">=</span> <span class="n">tcm_dir</span> <span class="o">+</span> <span class="s">&quot;drivers/target/&quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span>
	<span class="k">print</span> <span class="s">&quot;Set fabric_mod_name: &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span>
	<span class="k">print</span> <span class="s">&quot;Set fabric_mod_dir: &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_dir</span>
	<span class="k">print</span> <span class="s">&quot;Using proto_ident: &quot;</span> <span class="o">+</span> <span class="n">proto_ident</span>

	<span class="k">if</span> <span class="n">proto_ident</span> <span class="o">!=</span> <span class="s">&quot;FC&quot;</span> <span class="ow">and</span> <span class="n">proto_ident</span> <span class="o">!=</span> <span class="s">&quot;SAS&quot;</span> <span class="ow">and</span> <span class="n">proto_ident</span> <span class="o">!=</span> <span class="s">&quot;iSCSI&quot;</span><span class="p">:</span>
		<span class="k">print</span> <span class="s">&quot;Unsupported proto_ident: &quot;</span> <span class="o">+</span> <span class="n">proto_ident</span>
		<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tcm_mod_create_module_subdir</span><span class="p">(</span><span class="n">fabric_mod_dir</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
		<span class="k">print</span> <span class="s">&quot;tcm_mod_create_module_subdir() failed because module already exists!&quot;</span>
		<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

	<span class="n">tcm_mod_build_base_includes</span><span class="p">(</span><span class="n">proto_ident</span><span class="p">,</span> <span class="n">fabric_mod_dir</span><span class="p">,</span> <span class="n">fabric_mod_name</span><span class="p">)</span>
	<span class="n">tcm_mod_scan_fabric_ops</span><span class="p">(</span><span class="n">tcm_dir</span><span class="p">)</span>
	<span class="n">tcm_mod_dump_fabric_ops</span><span class="p">(</span><span class="n">proto_ident</span><span class="p">,</span> <span class="n">fabric_mod_dir</span><span class="p">,</span> <span class="n">fabric_mod_name</span><span class="p">)</span>
	<span class="n">tcm_mod_build_configfs</span><span class="p">(</span><span class="n">proto_ident</span><span class="p">,</span> <span class="n">fabric_mod_dir</span><span class="p">,</span> <span class="n">fabric_mod_name</span><span class="p">)</span>
	<span class="n">tcm_mod_build_kbuild</span><span class="p">(</span><span class="n">fabric_mod_dir</span><span class="p">,</span> <span class="n">fabric_mod_name</span><span class="p">)</span>
	<span class="n">tcm_mod_build_kconfig</span><span class="p">(</span><span class="n">fabric_mod_dir</span><span class="p">,</span> <span class="n">fabric_mod_name</span><span class="p">)</span>

	<span class="nb">input</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&quot;Would you like to add &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;to drivers/target/Makefile..? [yes,no]: &quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nb">input</span> <span class="o">==</span> <span class="s">&quot;yes&quot;</span> <span class="ow">or</span> <span class="nb">input</span> <span class="o">==</span> <span class="s">&quot;y&quot;</span><span class="p">:</span>
		<span class="n">tcm_mod_add_kbuild</span><span class="p">(</span><span class="n">tcm_dir</span><span class="p">,</span> <span class="n">fabric_mod_name</span><span class="p">)</span>

	<span class="nb">input</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&quot;Would you like to add &quot;</span> <span class="o">+</span> <span class="n">fabric_mod_name</span> <span class="o">+</span> <span class="s">&quot;to drivers/target/Kconfig..? [yes,no]: &quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nb">input</span> <span class="o">==</span> <span class="s">&quot;yes&quot;</span> <span class="ow">or</span> <span class="nb">input</span> <span class="o">==</span> <span class="s">&quot;y&quot;</span><span class="p">:</span>
		<span class="n">tcm_mod_add_kconfig</span><span class="p">(</span><span class="n">tcm_dir</span><span class="p">,</span> <span class="n">fabric_mod_name</span><span class="p">)</span>

	<span class="k">return</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-m&#39;</span><span class="p">,</span> <span class="s">&#39;--modulename&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;Module name&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;modname&#39;</span><span class="p">,</span>
		<span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;string&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-p&#39;</span><span class="p">,</span> <span class="s">&#39;--protoident&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;Protocol Ident&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;protoident&#39;</span><span class="p">,</span>
		<span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;string&#39;</span><span class="p">)</span>

<span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

<span class="n">mandatories</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;modname&#39;</span><span class="p">,</span> <span class="s">&#39;protoident&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mandatories</span><span class="p">:</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">m</span><span class="p">]:</span>
		<span class="k">print</span> <span class="s">&quot;mandatory option is missing</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
		<span class="nb">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>

	<span class="n">main</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">modname</span><span class="p">),</span> <span class="n">opts</span><span class="o">.</span><span class="n">protoident</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
