<!DOCTYPE html>
<html><head><title>joekychen/linux » Documentation › trace › postprocess › trace-vmscan-postprocess.pl

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>trace-vmscan-postprocess.pl</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="c1">#!/usr/bin/perl</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>This is a POC for reading the text representation of trace output related to
page reclaim. It makes an attempt to extract some high-level information on
what is going on. The accuracy of the parser may vary</p>

<p>Example usage: trace-vmscan-postprocess.pl &lt; /sys/kernel/debug/tracing/trace_pipe
other options
  --read-procstat    If the trace lacks process info, get it from /proc
  --ignore-pid    Aggregate processes of the same name together</p>

<p>Copyright (c) IBM Corporation 2009
Author: Mel Gorman <a href="&#x6D;&#97;&#105;&#x6C;&#116;o:&#109;&#101;&#x6C;&#x40;&#x63;&#115;&#x6E;&#46;&#117;&#x6C;.&#105;&#x65;">&#109;&#101;&#x6C;&#x40;&#x63;&#115;&#x6E;&#46;&#117;&#x6C;.&#105;&#x65;</a></p></td><td class="code"><div class="highlight"><pre><span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Getopt::</span><span class="n">Long</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Tracepoint events</p></td><td class="code"><div class="highlight"><pre><span class="k">use</span> <span class="n">constant</span> <span class="n">MM_VMSCAN_DIRECT_RECLAIM_BEGIN</span>	<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">MM_VMSCAN_DIRECT_RECLAIM_END</span>	<span class="o">=&gt;</span> <span class="mi">2</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">MM_VMSCAN_KSWAPD_WAKE</span>		<span class="o">=&gt;</span> <span class="mi">3</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">MM_VMSCAN_KSWAPD_SLEEP</span>		<span class="o">=&gt;</span> <span class="mi">4</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">MM_VMSCAN_LRU_SHRINK_ACTIVE</span>	<span class="o">=&gt;</span> <span class="mi">5</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">MM_VMSCAN_LRU_SHRINK_INACTIVE</span>	<span class="o">=&gt;</span> <span class="mi">6</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">MM_VMSCAN_LRU_ISOLATE</span>		<span class="o">=&gt;</span> <span class="mi">7</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">MM_VMSCAN_WRITEPAGE_FILE_SYNC</span>	<span class="o">=&gt;</span> <span class="mi">8</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">MM_VMSCAN_WRITEPAGE_ANON_SYNC</span>	<span class="o">=&gt;</span> <span class="mi">9</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">MM_VMSCAN_WRITEPAGE_FILE_ASYNC</span>	<span class="o">=&gt;</span> <span class="mi">10</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">MM_VMSCAN_WRITEPAGE_ANON_ASYNC</span>	<span class="o">=&gt;</span> <span class="mi">11</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">MM_VMSCAN_WRITEPAGE_ASYNC</span>		<span class="o">=&gt;</span> <span class="mi">12</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">EVENT_UNKNOWN</span>			<span class="o">=&gt;</span> <span class="mi">13</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Per-order events</p></td><td class="code"><div class="highlight"><pre><span class="k">use</span> <span class="n">constant</span> <span class="n">MM_VMSCAN_DIRECT_RECLAIM_BEGIN_PERORDER</span> <span class="o">=&gt;</span> <span class="mi">11</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">MM_VMSCAN_WAKEUP_KSWAPD_PERORDER</span> 	<span class="o">=&gt;</span> <span class="mi">12</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">MM_VMSCAN_KSWAPD_WAKE_PERORDER</span>	<span class="o">=&gt;</span> <span class="mi">13</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">HIGH_KSWAPD_REWAKEUP_PERORDER</span>	<span class="o">=&gt;</span> <span class="mi">14</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Constants used to track state</p></td><td class="code"><div class="highlight"><pre><span class="k">use</span> <span class="n">constant</span> <span class="n">STATE_DIRECT_BEGIN</span> 		<span class="o">=&gt;</span> <span class="mi">15</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">STATE_DIRECT_ORDER</span> 		<span class="o">=&gt;</span> <span class="mi">16</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">STATE_KSWAPD_BEGIN</span>			<span class="o">=&gt;</span> <span class="mi">17</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">STATE_KSWAPD_ORDER</span>			<span class="o">=&gt;</span> <span class="mi">18</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>High-level events extrapolated from tracepoints</p></td><td class="code"><div class="highlight"><pre><span class="k">use</span> <span class="n">constant</span> <span class="n">HIGH_DIRECT_RECLAIM_LATENCY</span>	<span class="o">=&gt;</span> <span class="mi">19</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">HIGH_KSWAPD_LATENCY</span>		<span class="o">=&gt;</span> <span class="mi">20</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">HIGH_KSWAPD_REWAKEUP</span>		<span class="o">=&gt;</span> <span class="mi">21</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">HIGH_NR_SCANNED</span>			<span class="o">=&gt;</span> <span class="mi">22</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">HIGH_NR_TAKEN</span>			<span class="o">=&gt;</span> <span class="mi">23</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">HIGH_NR_RECLAIMED</span>			<span class="o">=&gt;</span> <span class="mi">24</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">HIGH_NR_CONTIG_DIRTY</span>		<span class="o">=&gt;</span> <span class="mi">25</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">%perprocesspid</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%perprocess</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%last_procmap</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$opt_ignorepid</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$opt_read_procstat</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$total_wakeup_kswapd</span><span class="p">;</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$total_direct_reclaim</span><span class="p">,</span> <span class="nv">$total_direct_nr_scanned</span><span class="p">);</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$total_direct_latency</span><span class="p">,</span> <span class="nv">$total_kswapd_latency</span><span class="p">);</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$total_direct_nr_reclaimed</span><span class="p">);</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$total_direct_writepage_file_sync</span><span class="p">,</span> <span class="nv">$total_direct_writepage_file_async</span><span class="p">);</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$total_direct_writepage_anon_sync</span><span class="p">,</span> <span class="nv">$total_direct_writepage_anon_async</span><span class="p">);</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$total_kswapd_nr_scanned</span><span class="p">,</span> <span class="nv">$total_kswapd_wake</span><span class="p">);</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$total_kswapd_writepage_file_sync</span><span class="p">,</span> <span class="nv">$total_kswapd_writepage_file_async</span><span class="p">);</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$total_kswapd_writepage_anon_sync</span><span class="p">,</span> <span class="nv">$total_kswapd_writepage_anon_async</span><span class="p">);</span>
<span class="k">my</span> <span class="p">(</span><span class="nv">$total_kswapd_nr_reclaimed</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Catch sigint and exit on request</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">$sigint_report</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$sigint_exit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$sigint_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$sigint_received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">sigint_handler</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$current_time</span> <span class="o">=</span> <span class="nb">time</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$current_time</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="nv">$sigint_received</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">print</span> <span class="s">&quot;SIGINT received, report pending. Hit ctrl-c again to exit\n&quot;</span><span class="p">;</span>
		<span class="nv">$sigint_report</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$sigint_exit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;Second SIGINT received quickly, exiting\n&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nv">$sigint_exit</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$sigint_exit</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">print</span> <span class="s">&quot;Many SIGINTs received, exiting now without report\n&quot;</span><span class="p">;</span>
		<span class="nb">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nv">$sigint_received</span> <span class="o">=</span> <span class="nv">$current_time</span><span class="p">;</span>
	<span class="nv">$sigint_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="nv">$SIG</span><span class="p">{</span><span class="n">INT</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;sigint_handler&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Parse command line options</p></td><td class="code"><div class="highlight"><pre><span class="n">GetOptions</span><span class="p">(</span>
	<span class="s">&#39;ignore-pid&#39;</span>	 <span class="o">=&gt;</span>	<span class="o">\</span><span class="nv">$opt_ignorepid</span><span class="p">,</span>
	<span class="s">&#39;read-procstat&#39;</span>	 <span class="o">=&gt;</span>	<span class="o">\</span><span class="nv">$opt_read_procstat</span><span class="p">,</span>
<span class="p">);</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Defaults for dynamically discovered regex's</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">$regex_direct_begin_default</span> <span class="o">=</span> <span class="s">&#39;order=([0-9]*) may_writepage=([0-9]*) gfp_flags=([A-Z_|]*)&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$regex_direct_end_default</span> <span class="o">=</span> <span class="s">&#39;nr_reclaimed=([0-9]*)&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$regex_kswapd_wake_default</span> <span class="o">=</span> <span class="s">&#39;nid=([0-9]*) order=([0-9]*)&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$regex_kswapd_sleep_default</span> <span class="o">=</span> <span class="s">&#39;nid=([0-9]*)&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$regex_wakeup_kswapd_default</span> <span class="o">=</span> <span class="s">&#39;nid=([0-9]*) zid=([0-9]*) order=([0-9]*)&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$regex_lru_isolate_default</span> <span class="o">=</span> <span class="s">&#39;isolate_mode=([0-9]*) order=([0-9]*) nr_requested=([0-9]*) nr_scanned=([0-9]*) nr_taken=([0-9]*) contig_taken=([0-9]*) contig_dirty=([0-9]*) contig_failed=([0-9]*)&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$regex_lru_shrink_inactive_default</span> <span class="o">=</span> <span class="s">&#39;nid=([0-9]*) zid=([0-9]*) nr_scanned=([0-9]*) nr_reclaimed=([0-9]*) priority=([0-9]*) flags=([A-Z_|]*)&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$regex_lru_shrink_active_default</span> <span class="o">=</span> <span class="s">&#39;lru=([A-Z_]*) nr_scanned=([0-9]*) nr_rotated=([0-9]*) priority=([0-9]*)&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$regex_writepage_default</span> <span class="o">=</span> <span class="s">&#39;page=([0-9a-f]*) pfn=([0-9]*) flags=([A-Z_|]*)&#39;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Dyanically discovered regex</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">$regex_direct_begin</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$regex_direct_end</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$regex_kswapd_wake</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$regex_kswapd_sleep</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$regex_wakeup_kswapd</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$regex_lru_isolate</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$regex_lru_shrink_inactive</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$regex_lru_shrink_active</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$regex_writepage</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Static regex used. Specified like this for readability and for use with /o
                     (process_pid)     (cpus      )   ( time  )   (tpoint    ) (details)</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">$regex_traceevent</span> <span class="o">=</span> <span class="s">&#39;\s*([a-zA-Z0-9-]*)\s*(\[[0-9]*\])\s*([0-9.]*):\s*([a-zA-Z_]*):\s*(.*)&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$regex_statname</span> <span class="o">=</span> <span class="s">&#39;[-0-9]*\s\((.*)\).*&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$regex_statppid</span> <span class="o">=</span> <span class="s">&#39;[-0-9]*\s\(.*\)\s[A-Za-z]\s([0-9]*).*&#39;</span><span class="p">;</span>

<span class="k">sub </span><span class="nf">generate_traceevent_regex</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$event</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$default</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$regex</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Read the event format or use the default</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">open</span> <span class="p">(</span><span class="n">FORMAT</span><span class="p">,</span> <span class="s">&quot;/sys/kernel/debug/tracing/events/$event/format&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">print</span><span class="p">(</span><span class="s">&quot;WARNING: Event $event format string not found\n&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nv">$default</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">my</span> <span class="nv">$line</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nb">eof</span><span class="p">(</span><span class="n">FORMAT</span><span class="p">))</span> <span class="p">{</span>
			<span class="nv">$line</span> <span class="o">=</span> <span class="sr">&lt;FORMAT&gt;</span><span class="p">;</span>
			<span class="nv">$line</span> <span class="o">=~</span> <span class="sr">s/, REC-&gt;.*//</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^print fmt:\s&quot;(.*)&quot;.*/</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$regex</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
				<span class="nv">$regex</span> <span class="o">=~</span> <span class="sr">s/%s/\([0-9a-zA-Z|_]*\)/g</span><span class="p">;</span>
				<span class="nv">$regex</span> <span class="o">=~</span> <span class="sr">s/%p/\([0-9a-f]*\)/g</span><span class="p">;</span>
				<span class="nv">$regex</span> <span class="o">=~</span> <span class="sr">s/%d/\([-0-9]*\)/g</span><span class="p">;</span>
				<span class="nv">$regex</span> <span class="o">=~</span> <span class="sr">s/%ld/\([-0-9]*\)/g</span><span class="p">;</span>
				<span class="nv">$regex</span> <span class="o">=~</span> <span class="sr">s/%lu/\([0-9]*\)/g</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Can't handle the print_flags stuff but in the context of this
script, it really doesn't matter</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">$regex</span> <span class="o">=~</span> <span class="sr">s/\(REC.*\) \? __print_flags.*//</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Verify fields are in the right order</p></td><td class="code"><div class="highlight"><pre>	<span class="k">my</span> <span class="nv">$tuple</span><span class="p">;</span>
	<span class="k">foreach</span> <span class="nv">$tuple</span> <span class="p">(</span><span class="nb">split</span> <span class="sr">/\s/</span><span class="p">,</span> <span class="nv">$regex</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">my</span> <span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="sr">/=/</span><span class="p">,</span> <span class="nv">$tuple</span><span class="p">);</span>
		<span class="k">my</span> <span class="nv">$expected</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$key</span> <span class="ow">ne</span> <span class="nv">$expected</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span><span class="p">(</span><span class="s">&quot;WARNING: Format not as expected for event $event &#39;$key&#39; != &#39;$expected&#39;\n&quot;</span><span class="p">);</span>
			<span class="nv">$regex</span> <span class="o">=~</span> <span class="sr">s/$key=\((.*)\)/$key=$1/</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nb">shift</span><span class="p">)</span> <span class="p">{</span>
		<span class="nb">die</span><span class="p">(</span><span class="s">&quot;Fewer fields than expected in format&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nv">$regex</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$regex_direct_begin</span> <span class="o">=</span> <span class="n">generate_traceevent_regex</span><span class="p">(</span>
			<span class="s">&quot;vmscan/mm_vmscan_direct_reclaim_begin&quot;</span><span class="p">,</span>
			<span class="nv">$regex_direct_begin_default</span><span class="p">,</span>
			<span class="s">&quot;order&quot;</span><span class="p">,</span> <span class="s">&quot;may_writepage&quot;</span><span class="p">,</span>
			<span class="s">&quot;gfp_flags&quot;</span><span class="p">);</span>
<span class="nv">$regex_direct_end</span> <span class="o">=</span> <span class="n">generate_traceevent_regex</span><span class="p">(</span>
			<span class="s">&quot;vmscan/mm_vmscan_direct_reclaim_end&quot;</span><span class="p">,</span>
			<span class="nv">$regex_direct_end_default</span><span class="p">,</span>
			<span class="s">&quot;nr_reclaimed&quot;</span><span class="p">);</span>
<span class="nv">$regex_kswapd_wake</span> <span class="o">=</span> <span class="n">generate_traceevent_regex</span><span class="p">(</span>
			<span class="s">&quot;vmscan/mm_vmscan_kswapd_wake&quot;</span><span class="p">,</span>
			<span class="nv">$regex_kswapd_wake_default</span><span class="p">,</span>
			<span class="s">&quot;nid&quot;</span><span class="p">,</span> <span class="s">&quot;order&quot;</span><span class="p">);</span>
<span class="nv">$regex_kswapd_sleep</span> <span class="o">=</span> <span class="n">generate_traceevent_regex</span><span class="p">(</span>
			<span class="s">&quot;vmscan/mm_vmscan_kswapd_sleep&quot;</span><span class="p">,</span>
			<span class="nv">$regex_kswapd_sleep_default</span><span class="p">,</span>
			<span class="s">&quot;nid&quot;</span><span class="p">);</span>
<span class="nv">$regex_wakeup_kswapd</span> <span class="o">=</span> <span class="n">generate_traceevent_regex</span><span class="p">(</span>
			<span class="s">&quot;vmscan/mm_vmscan_wakeup_kswapd&quot;</span><span class="p">,</span>
			<span class="nv">$regex_wakeup_kswapd_default</span><span class="p">,</span>
			<span class="s">&quot;nid&quot;</span><span class="p">,</span> <span class="s">&quot;zid&quot;</span><span class="p">,</span> <span class="s">&quot;order&quot;</span><span class="p">);</span>
<span class="nv">$regex_lru_isolate</span> <span class="o">=</span> <span class="n">generate_traceevent_regex</span><span class="p">(</span>
			<span class="s">&quot;vmscan/mm_vmscan_lru_isolate&quot;</span><span class="p">,</span>
			<span class="nv">$regex_lru_isolate_default</span><span class="p">,</span>
			<span class="s">&quot;isolate_mode&quot;</span><span class="p">,</span> <span class="s">&quot;order&quot;</span><span class="p">,</span>
			<span class="s">&quot;nr_requested&quot;</span><span class="p">,</span> <span class="s">&quot;nr_scanned&quot;</span><span class="p">,</span> <span class="s">&quot;nr_taken&quot;</span><span class="p">,</span>
			<span class="s">&quot;contig_taken&quot;</span><span class="p">,</span> <span class="s">&quot;contig_dirty&quot;</span><span class="p">,</span> <span class="s">&quot;contig_failed&quot;</span><span class="p">);</span>
<span class="nv">$regex_lru_shrink_inactive</span> <span class="o">=</span> <span class="n">generate_traceevent_regex</span><span class="p">(</span>
			<span class="s">&quot;vmscan/mm_vmscan_lru_shrink_inactive&quot;</span><span class="p">,</span>
			<span class="nv">$regex_lru_shrink_inactive_default</span><span class="p">,</span>
			<span class="s">&quot;nid&quot;</span><span class="p">,</span> <span class="s">&quot;zid&quot;</span><span class="p">,</span>
			<span class="s">&quot;nr_scanned&quot;</span><span class="p">,</span> <span class="s">&quot;nr_reclaimed&quot;</span><span class="p">,</span> <span class="s">&quot;priority&quot;</span><span class="p">,</span>
			<span class="s">&quot;flags&quot;</span><span class="p">);</span>
<span class="nv">$regex_lru_shrink_active</span> <span class="o">=</span> <span class="n">generate_traceevent_regex</span><span class="p">(</span>
			<span class="s">&quot;vmscan/mm_vmscan_lru_shrink_active&quot;</span><span class="p">,</span>
			<span class="nv">$regex_lru_shrink_active_default</span><span class="p">,</span>
			<span class="s">&quot;nid&quot;</span><span class="p">,</span> <span class="s">&quot;zid&quot;</span><span class="p">,</span>
			<span class="s">&quot;lru&quot;</span><span class="p">,</span>
			<span class="s">&quot;nr_scanned&quot;</span><span class="p">,</span> <span class="s">&quot;nr_rotated&quot;</span><span class="p">,</span> <span class="s">&quot;priority&quot;</span><span class="p">);</span>
<span class="nv">$regex_writepage</span> <span class="o">=</span> <span class="n">generate_traceevent_regex</span><span class="p">(</span>
			<span class="s">&quot;vmscan/mm_vmscan_writepage&quot;</span><span class="p">,</span>
			<span class="nv">$regex_writepage_default</span><span class="p">,</span>
			<span class="s">&quot;page&quot;</span><span class="p">,</span> <span class="s">&quot;pfn&quot;</span><span class="p">,</span> <span class="s">&quot;flags&quot;</span><span class="p">);</span>

<span class="k">sub </span><span class="nf">read_statline</span><span class="p">($)</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$pid</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">my</span> <span class="nv">$statline</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">STAT</span><span class="p">,</span> <span class="s">&quot;/proc/$pid/stat&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="nv">$statline</span> <span class="o">=</span> <span class="sr">&lt;STAT&gt;</span><span class="p">;</span>
		<span class="nb">close</span><span class="p">(</span><span class="n">STAT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$statline</span> <span class="ow">eq</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$statline</span> <span class="o">=</span> <span class="s">&quot;-1 (UNKNOWN_PROCESS_NAME) R 0&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nv">$statline</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">guess_process_pid</span><span class="p">($$)</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$pid</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">my</span> <span class="nv">$statline</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="s">&quot;swapper-0&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$statline</span> <span class="o">!~</span> <span class="sr">/$regex_statname/o</span><span class="p">)</span> <span class="p">{</span>
		<span class="nb">die</span><span class="p">(</span><span class="s">&quot;Failed to math stat line for process name :: $statline&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="s">&quot;$1-$pid&quot;</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>Convert sec.usec timestamp format</p></td><td class="code"><div class="highlight"><pre><span class="k">sub </span><span class="nf">timestamp_to_ms</span><span class="p">($)</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$timestamp</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">my</span> <span class="p">(</span><span class="nv">$sec</span><span class="p">,</span> <span class="nv">$usec</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span> <span class="p">(</span><span class="sr">/\./</span><span class="p">,</span> <span class="nv">$timestamp</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="nv">$sec</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nv">$usec</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">process_events</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$traceevent</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$process_pid</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$cpus</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$timestamp</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$tracepoint</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$details</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$statline</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Read each line of the event log</p></td><td class="code"><div class="highlight"><pre><span class="n">EVENT_PROCESS:</span>
	<span class="k">while</span> <span class="p">(</span><span class="nv">$traceevent</span> <span class="o">=</span> <span class="sr">&lt;STDIN&gt;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$traceevent</span> <span class="o">=~</span><span class="sr"> /$regex_traceevent/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$process_pid</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
			<span class="nv">$timestamp</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>
			<span class="nv">$tracepoint</span> <span class="o">=</span> <span class="nv">$4</span><span class="p">;</span>

			<span class="nv">$process_pid</span> <span class="o">=~</span><span class="sr"> /(.*)-([0-9]*)$/</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$process</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$pid</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="nv">$process</span> <span class="ow">eq</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$process</span> <span class="o">=</span> <span class="nv">$last_procmap</span><span class="p">{</span><span class="nv">$pid</span><span class="p">};</span>
				<span class="nv">$process_pid</span> <span class="o">=</span> <span class="s">&quot;$process-$pid&quot;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="nv">$last_procmap</span><span class="p">{</span><span class="nv">$pid</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$process</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="nv">$opt_read_procstat</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$statline</span> <span class="o">=</span> <span class="n">read_statline</span><span class="p">(</span><span class="nv">$pid</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="nv">$opt_read_procstat</span> <span class="o">&amp;&amp;</span> <span class="nv">$process</span> <span class="ow">eq</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="nv">$process_pid</span> <span class="o">=</span> <span class="n">guess_process_pid</span><span class="p">(</span><span class="nv">$pid</span><span class="p">,</span> <span class="nv">$statline</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">next</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Perl Switch() sucks majorly</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$tracepoint</span> <span class="ow">eq</span> <span class="s">&quot;mm_vmscan_direct_reclaim_begin&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$timestamp</span> <span class="o">=</span> <span class="n">timestamp_to_ms</span><span class="p">(</span><span class="nv">$timestamp</span><span class="p">);</span>
			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_DIRECT_RECLAIM_BEGIN</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">STATE_DIRECT_BEGIN</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$timestamp</span><span class="p">;</span>

			<span class="nv">$details</span> <span class="o">=</span> <span class="nv">$5</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$details</span> <span class="o">!~</span> <span class="sr">/$regex_direct_begin/o</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">print</span> <span class="s">&quot;WARNING: Failed to parse mm_vmscan_direct_reclaim_begin as expected\n&quot;</span><span class="p">;</span>
				<span class="k">print</span> <span class="s">&quot;         $details\n&quot;</span><span class="p">;</span>
				<span class="k">print</span> <span class="s">&quot;         $regex_direct_begin\n&quot;</span><span class="p">;</span>
				<span class="k">next</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">my</span> <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_DIRECT_RECLAIM_BEGIN_PERORDER</span><span class="p">}[</span><span class="nv">$order</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">STATE_DIRECT_ORDER</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$order</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$tracepoint</span> <span class="ow">eq</span> <span class="s">&quot;mm_vmscan_direct_reclaim_end&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Count the event itself</p></td><td class="code"><div class="highlight"><pre>			<span class="k">my</span> <span class="nv">$index</span> <span class="o">=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_DIRECT_RECLAIM_END</span><span class="p">};</span>
			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_DIRECT_RECLAIM_END</span><span class="p">}</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>Record how long direct reclaim took this time</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">STATE_DIRECT_BEGIN</span><span class="p">})</span> <span class="p">{</span>
				<span class="nv">$timestamp</span> <span class="o">=</span> <span class="n">timestamp_to_ms</span><span class="p">(</span><span class="nv">$timestamp</span><span class="p">);</span>
				<span class="k">my</span> <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">STATE_DIRECT_ORDER</span><span class="p">};</span>
				<span class="k">my</span> <span class="nv">$latency</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$timestamp</span> <span class="o">-</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">STATE_DIRECT_BEGIN</span><span class="p">});</span>
				<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_DIRECT_RECLAIM_LATENCY</span><span class="p">}[</span><span class="nv">$index</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;$order-$latency&quot;</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$tracepoint</span> <span class="ow">eq</span> <span class="s">&quot;mm_vmscan_kswapd_wake&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$details</span> <span class="o">=</span> <span class="nv">$5</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$details</span> <span class="o">!~</span> <span class="sr">/$regex_kswapd_wake/o</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">print</span> <span class="s">&quot;WARNING: Failed to parse mm_vmscan_kswapd_wake as expected\n&quot;</span><span class="p">;</span>
				<span class="k">print</span> <span class="s">&quot;         $details\n&quot;</span><span class="p">;</span>
				<span class="k">print</span> <span class="s">&quot;         $regex_kswapd_wake\n&quot;</span><span class="p">;</span>
				<span class="k">next</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">my</span> <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">STATE_KSWAPD_ORDER</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$order</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">STATE_KSWAPD_BEGIN</span><span class="p">})</span> <span class="p">{</span>
				<span class="nv">$timestamp</span> <span class="o">=</span> <span class="n">timestamp_to_ms</span><span class="p">(</span><span class="nv">$timestamp</span><span class="p">);</span>
				<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_KSWAPD_WAKE</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
				<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">STATE_KSWAPD_BEGIN</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$timestamp</span><span class="p">;</span>
				<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_KSWAPD_WAKE_PERORDER</span><span class="p">}[</span><span class="nv">$order</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_KSWAPD_REWAKEUP</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
				<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_KSWAPD_REWAKEUP_PERORDER</span><span class="p">}[</span><span class="nv">$order</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$tracepoint</span> <span class="ow">eq</span> <span class="s">&quot;mm_vmscan_kswapd_sleep&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>Count the event itself</p></td><td class="code"><div class="highlight"><pre>			<span class="k">my</span> <span class="nv">$index</span> <span class="o">=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_KSWAPD_SLEEP</span><span class="p">};</span>
			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_KSWAPD_SLEEP</span><span class="p">}</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>Record how long kswapd was awake</p></td><td class="code"><div class="highlight"><pre>			<span class="nv">$timestamp</span> <span class="o">=</span> <span class="n">timestamp_to_ms</span><span class="p">(</span><span class="nv">$timestamp</span><span class="p">);</span>
			<span class="k">my</span> <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">STATE_KSWAPD_ORDER</span><span class="p">};</span>
			<span class="k">my</span> <span class="nv">$latency</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$timestamp</span> <span class="o">-</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">STATE_KSWAPD_BEGIN</span><span class="p">});</span>
			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_KSWAPD_LATENCY</span><span class="p">}[</span><span class="nv">$index</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;$order-$latency&quot;</span><span class="p">;</span>
			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">STATE_KSWAPD_BEGIN</span><span class="p">}</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$tracepoint</span> <span class="ow">eq</span> <span class="s">&quot;mm_vmscan_wakeup_kswapd&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WAKEUP_KSWAPD</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>

			<span class="nv">$details</span> <span class="o">=</span> <span class="nv">$5</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$details</span> <span class="o">!~</span> <span class="sr">/$regex_wakeup_kswapd/o</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">print</span> <span class="s">&quot;WARNING: Failed to parse mm_vmscan_wakeup_kswapd as expected\n&quot;</span><span class="p">;</span>
				<span class="k">print</span> <span class="s">&quot;         $details\n&quot;</span><span class="p">;</span>
				<span class="k">print</span> <span class="s">&quot;         $regex_wakeup_kswapd\n&quot;</span><span class="p">;</span>
				<span class="k">next</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">my</span> <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>
			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WAKEUP_KSWAPD_PERORDER</span><span class="p">}[</span><span class="nv">$order</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$tracepoint</span> <span class="ow">eq</span> <span class="s">&quot;mm_vmscan_lru_isolate&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$details</span> <span class="o">=</span> <span class="nv">$5</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$details</span> <span class="o">!~</span> <span class="sr">/$regex_lru_isolate/o</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">print</span> <span class="s">&quot;WARNING: Failed to parse mm_vmscan_lru_isolate as expected\n&quot;</span><span class="p">;</span>
				<span class="k">print</span> <span class="s">&quot;         $details\n&quot;</span><span class="p">;</span>
				<span class="k">print</span> <span class="s">&quot;         $regex_lru_isolate/o\n&quot;</span><span class="p">;</span>
				<span class="k">next</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">my</span> <span class="nv">$isolate_mode</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$nr_scanned</span> <span class="o">=</span> <span class="nv">$4</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$nr_contig_dirty</span> <span class="o">=</span> <span class="nv">$7</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>To closer match vmstat scanning statistics, only count isolate<em>both
and isolate</em>inactive as scanning. isolate<em>active is rotation
isolate</em>inactive == 1
isolate<em>active   == 2
isolate</em>both     == 3</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="nv">$isolate_mode</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_NR_SCANNED</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$nr_scanned</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_NR_CONTIG_DIRTY</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$nr_contig_dirty</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$tracepoint</span> <span class="ow">eq</span> <span class="s">&quot;mm_vmscan_lru_shrink_inactive&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$details</span> <span class="o">=</span> <span class="nv">$5</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$details</span> <span class="o">!~</span> <span class="sr">/$regex_lru_shrink_inactive/o</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">print</span> <span class="s">&quot;WARNING: Failed to parse mm_vmscan_lru_shrink_inactive as expected\n&quot;</span><span class="p">;</span>
				<span class="k">print</span> <span class="s">&quot;         $details\n&quot;</span><span class="p">;</span>
				<span class="k">print</span> <span class="s">&quot;         $regex_lru_shrink_inactive/o\n&quot;</span><span class="p">;</span>
				<span class="k">next</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">my</span> <span class="nv">$nr_reclaimed</span> <span class="o">=</span> <span class="nv">$4</span><span class="p">;</span>
			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_NR_RECLAIMED</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$nr_reclaimed</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$tracepoint</span> <span class="ow">eq</span> <span class="s">&quot;mm_vmscan_writepage&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$details</span> <span class="o">=</span> <span class="nv">$5</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$details</span> <span class="o">!~</span> <span class="sr">/$regex_writepage/o</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">print</span> <span class="s">&quot;WARNING: Failed to parse mm_vmscan_writepage as expected\n&quot;</span><span class="p">;</span>
				<span class="k">print</span> <span class="s">&quot;         $details\n&quot;</span><span class="p">;</span>
				<span class="k">print</span> <span class="s">&quot;         $regex_writepage\n&quot;</span><span class="p">;</span>
				<span class="k">next</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">my</span> <span class="nv">$flags</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$file</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$sync_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$flags</span> <span class="o">=~</span><span class="sr"> /RECLAIM_WB_FILE/</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$file</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$flags</span> <span class="o">=~</span><span class="sr"> /RECLAIM_WB_SYNC/</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$sync_io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$sync_io</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="nv">$file</span><span class="p">)</span> <span class="p">{</span>
					<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_FILE_SYNC</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_ANON_SYNC</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="nv">$file</span><span class="p">)</span> <span class="p">{</span>
					<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_FILE_ASYNC</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_ANON_ASYNC</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">EVENT_UNKNOWN</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="nv">$sigint_pending</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">last</span> <span class="n">EVENT_PROCESS</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">dump_stats</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$hashref</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">%stats</span> <span class="o">=</span> <span class="nv">%$hashref</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>Dump per-process stats</p></td><td class="code"><div class="highlight"><pre>	<span class="k">my</span> <span class="nv">$process_pid</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$max_strlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>Get the maximum process name</p></td><td class="code"><div class="highlight"><pre>	<span class="k">foreach</span> <span class="nv">$process_pid</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%perprocesspid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">my</span> <span class="nv">$len</span> <span class="o">=</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$process_pid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$len</span> <span class="o">&gt;</span> <span class="nv">$max_strlen</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$max_strlen</span> <span class="o">=</span> <span class="nv">$len</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nv">$max_strlen</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>Work out latencies</p></td><td class="code"><div class="highlight"><pre>	<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;\n&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="o">!</span><span class="nv">$opt_ignorepid</span><span class="p">;</span>
	<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;Reclaim latencies expressed as order-latency_in_ms\n&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="o">!</span><span class="nv">$opt_ignorepid</span><span class="p">;</span>
	<span class="k">foreach</span> <span class="nv">$process_pid</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%stats</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_DIRECT_RECLAIM_LATENCY</span><span class="p">}[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_KSWAPD_LATENCY</span><span class="p">}[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">next</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="nb">printf</span> <span class="s">&quot;%-&quot;</span> <span class="o">.</span> <span class="nv">$max_strlen</span> <span class="o">.</span> <span class="s">&quot;s &quot;</span><span class="p">,</span> <span class="nv">$process_pid</span> <span class="k">if</span> <span class="o">!</span><span class="nv">$opt_ignorepid</span><span class="p">;</span>
		<span class="k">my</span> <span class="nv">$index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_DIRECT_RECLAIM_LATENCY</span><span class="p">}[</span><span class="nv">$index</span><span class="p">]</span> <span class="o">||</span>
			<span class="nb">defined</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_KSWAPD_LATENCY</span><span class="p">}[</span><span class="nv">$index</span><span class="p">])</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_DIRECT_RECLAIM_LATENCY</span><span class="p">}[</span><span class="nv">$index</span><span class="p">])</span> <span class="p">{</span>
				<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_DIRECT_RECLAIM_LATENCY</span><span class="p">}[</span><span class="nv">$index</span><span class="p">])</span> <span class="k">if</span> <span class="o">!</span><span class="nv">$opt_ignorepid</span><span class="p">;</span>
				<span class="k">my</span> <span class="p">(</span><span class="nv">$dummy</span><span class="p">,</span> <span class="nv">$latency</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="sr">/-/</span><span class="p">,</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_DIRECT_RECLAIM_LATENCY</span><span class="p">}[</span><span class="nv">$index</span><span class="p">]);</span>
				<span class="nv">$total_direct_latency</span> <span class="o">+=</span> <span class="nv">$latency</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_KSWAPD_LATENCY</span><span class="p">}[</span><span class="nv">$index</span><span class="p">])</span> <span class="k">if</span> <span class="o">!</span><span class="nv">$opt_ignorepid</span><span class="p">;</span>
				<span class="k">my</span> <span class="p">(</span><span class="nv">$dummy</span><span class="p">,</span> <span class="nv">$latency</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="sr">/-/</span><span class="p">,</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_KSWAPD_LATENCY</span><span class="p">}[</span><span class="nv">$index</span><span class="p">]);</span>
				<span class="nv">$total_kswapd_latency</span> <span class="o">+=</span> <span class="nv">$latency</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="nv">$index</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">print</span> <span class="s">&quot;\n&quot;</span> <span class="k">if</span> <span class="o">!</span><span class="nv">$opt_ignorepid</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>Print out process activity</p></td><td class="code"><div class="highlight"><pre>	<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;\n&quot;</span><span class="p">);</span>
	<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;%-&quot;</span> <span class="o">.</span> <span class="nv">$max_strlen</span> <span class="o">.</span> <span class="s">&quot;s %8s %10s   %8s %8s  %8s %8s %8s %8s\n&quot;</span><span class="p">,</span> <span class="s">&quot;Process&quot;</span><span class="p">,</span> <span class="s">&quot;Direct&quot;</span><span class="p">,</span>  <span class="s">&quot;Wokeup&quot;</span><span class="p">,</span> <span class="s">&quot;Pages&quot;</span><span class="p">,</span>   <span class="s">&quot;Pages&quot;</span><span class="p">,</span>   <span class="s">&quot;Pages&quot;</span><span class="p">,</span>   <span class="s">&quot;Pages&quot;</span><span class="p">,</span>     <span class="s">&quot;Time&quot;</span><span class="p">);</span>
	<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;%-&quot;</span> <span class="o">.</span> <span class="nv">$max_strlen</span> <span class="o">.</span> <span class="s">&quot;s %8s %10s   %8s %8s  %8s %8s %8s %8s\n&quot;</span><span class="p">,</span> <span class="s">&quot;details&quot;</span><span class="p">,</span> <span class="s">&quot;Rclms&quot;</span><span class="p">,</span>   <span class="s">&quot;Kswapd&quot;</span><span class="p">,</span> <span class="s">&quot;Scanned&quot;</span><span class="p">,</span> <span class="s">&quot;Rclmed&quot;</span><span class="p">,</span>  <span class="s">&quot;Sync-IO&quot;</span><span class="p">,</span> <span class="s">&quot;ASync-IO&quot;</span><span class="p">,</span>  <span class="s">&quot;Stalled&quot;</span><span class="p">);</span>
	<span class="k">foreach</span> <span class="nv">$process_pid</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%stats</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_DIRECT_RECLAIM_BEGIN</span><span class="p">})</span> <span class="p">{</span>
			<span class="k">next</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="nv">$total_direct_reclaim</span> <span class="o">+=</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_DIRECT_RECLAIM_BEGIN</span><span class="p">};</span>
		<span class="nv">$total_wakeup_kswapd</span> <span class="o">+=</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WAKEUP_KSWAPD</span><span class="p">};</span>
		<span class="nv">$total_direct_nr_scanned</span> <span class="o">+=</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_NR_SCANNED</span><span class="p">};</span>
		<span class="nv">$total_direct_nr_reclaimed</span> <span class="o">+=</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_NR_RECLAIMED</span><span class="p">};</span>
		<span class="nv">$total_direct_writepage_file_sync</span> <span class="o">+=</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_FILE_SYNC</span><span class="p">};</span>
		<span class="nv">$total_direct_writepage_anon_sync</span> <span class="o">+=</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_ANON_SYNC</span><span class="p">};</span>
		<span class="nv">$total_direct_writepage_file_async</span> <span class="o">+=</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_FILE_ASYNC</span><span class="p">};</span>

		<span class="nv">$total_direct_writepage_anon_async</span> <span class="o">+=</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_ANON_ASYNC</span><span class="p">};</span>

		<span class="k">my</span> <span class="nv">$index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">my</span> <span class="nv">$this_reclaim_delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_DIRECT_RECLAIM_LATENCY</span><span class="p">}[</span><span class="nv">$index</span><span class="p">])</span> <span class="p">{</span>
			 <span class="k">my</span> <span class="p">(</span><span class="nv">$dummy</span><span class="p">,</span> <span class="nv">$latency</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="sr">/-/</span><span class="p">,</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_DIRECT_RECLAIM_LATENCY</span><span class="p">}[</span><span class="nv">$index</span><span class="p">]);</span>
			<span class="nv">$this_reclaim_delay</span> <span class="o">+=</span> <span class="nv">$latency</span><span class="p">;</span>
			<span class="nv">$index</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;%-&quot;</span> <span class="o">.</span> <span class="nv">$max_strlen</span> <span class="o">.</span> <span class="s">&quot;s %8d %10d   %8u %8u  %8u %8u %8.3f&quot;</span><span class="p">,</span>
			<span class="nv">$process_pid</span><span class="p">,</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_DIRECT_RECLAIM_BEGIN</span><span class="p">},</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WAKEUP_KSWAPD</span><span class="p">},</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_NR_SCANNED</span><span class="p">},</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_NR_RECLAIMED</span><span class="p">},</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_FILE_SYNC</span><span class="p">}</span> <span class="o">+</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_ANON_SYNC</span><span class="p">},</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_FILE_ASYNC</span><span class="p">}</span> <span class="o">+</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_ANON_ASYNC</span><span class="p">},</span>
			<span class="nv">$this_reclaim_delay</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_DIRECT_RECLAIM_BEGIN</span><span class="p">})</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;      &quot;</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$order</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="nv">$order</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">my</span> <span class="nv">$count</span> <span class="o">=</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_DIRECT_RECLAIM_BEGIN_PERORDER</span><span class="p">}[</span><span class="nv">$order</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="nv">$count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">print</span> <span class="s">&quot;direct-$order=$count &quot;</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WAKEUP_KSWAPD</span><span class="p">})</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;      &quot;</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$order</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="nv">$order</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">my</span> <span class="nv">$count</span> <span class="o">=</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WAKEUP_KSWAPD_PERORDER</span><span class="p">}[</span><span class="nv">$order</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="nv">$count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">print</span> <span class="s">&quot;wakeup-$order=$count &quot;</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_NR_CONTIG_DIRTY</span><span class="p">})</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;      &quot;</span><span class="p">;</span>
			<span class="k">my</span> <span class="nv">$count</span> <span class="o">=</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_NR_CONTIG_DIRTY</span><span class="p">};</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">print</span> <span class="s">&quot;contig-dirty=$count &quot;</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">print</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>Print out kswapd activity</p></td><td class="code"><div class="highlight"><pre>	<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;\n&quot;</span><span class="p">);</span>
	<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;%-&quot;</span> <span class="o">.</span> <span class="nv">$max_strlen</span> <span class="o">.</span> <span class="s">&quot;s %8s %10s   %8s   %8s %8s %8s\n&quot;</span><span class="p">,</span> <span class="s">&quot;Kswapd&quot;</span><span class="p">,</span>   <span class="s">&quot;Kswapd&quot;</span><span class="p">,</span>  <span class="s">&quot;Order&quot;</span><span class="p">,</span>     <span class="s">&quot;Pages&quot;</span><span class="p">,</span>   <span class="s">&quot;Pages&quot;</span><span class="p">,</span>   <span class="s">&quot;Pages&quot;</span><span class="p">,</span>  <span class="s">&quot;Pages&quot;</span><span class="p">);</span>
	<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;%-&quot;</span> <span class="o">.</span> <span class="nv">$max_strlen</span> <span class="o">.</span> <span class="s">&quot;s %8s %10s   %8s   %8s %8s %8s\n&quot;</span><span class="p">,</span> <span class="s">&quot;Instance&quot;</span><span class="p">,</span> <span class="s">&quot;Wakeups&quot;</span><span class="p">,</span> <span class="s">&quot;Re-wakeup&quot;</span><span class="p">,</span> <span class="s">&quot;Scanned&quot;</span><span class="p">,</span> <span class="s">&quot;Rclmed&quot;</span><span class="p">,</span>  <span class="s">&quot;Sync-IO&quot;</span><span class="p">,</span> <span class="s">&quot;ASync-IO&quot;</span><span class="p">);</span>
	<span class="k">foreach</span> <span class="nv">$process_pid</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%stats</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_KSWAPD_WAKE</span><span class="p">})</span> <span class="p">{</span>
			<span class="k">next</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="nv">$total_kswapd_wake</span> <span class="o">+=</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_KSWAPD_WAKE</span><span class="p">};</span>
		<span class="nv">$total_kswapd_nr_scanned</span> <span class="o">+=</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_NR_SCANNED</span><span class="p">};</span>
		<span class="nv">$total_kswapd_nr_reclaimed</span> <span class="o">+=</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_NR_RECLAIMED</span><span class="p">};</span>
		<span class="nv">$total_kswapd_writepage_file_sync</span> <span class="o">+=</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_FILE_SYNC</span><span class="p">};</span>
		<span class="nv">$total_kswapd_writepage_anon_sync</span> <span class="o">+=</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_ANON_SYNC</span><span class="p">};</span>
		<span class="nv">$total_kswapd_writepage_file_async</span> <span class="o">+=</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_FILE_ASYNC</span><span class="p">};</span>
		<span class="nv">$total_kswapd_writepage_anon_async</span> <span class="o">+=</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_ANON_ASYNC</span><span class="p">};</span>

		<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;%-&quot;</span> <span class="o">.</span> <span class="nv">$max_strlen</span> <span class="o">.</span> <span class="s">&quot;s %8d %10d   %8u %8u  %8i %8u&quot;</span><span class="p">,</span>
			<span class="nv">$process_pid</span><span class="p">,</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_KSWAPD_WAKE</span><span class="p">},</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_KSWAPD_REWAKEUP</span><span class="p">},</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_NR_SCANNED</span><span class="p">},</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_NR_RECLAIMED</span><span class="p">},</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_FILE_SYNC</span><span class="p">}</span> <span class="o">+</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_ANON_SYNC</span><span class="p">},</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_FILE_ASYNC</span><span class="p">}</span> <span class="o">+</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_ANON_ASYNC</span><span class="p">});</span>

		<span class="k">if</span> <span class="p">(</span><span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_KSWAPD_WAKE</span><span class="p">})</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;      &quot;</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$order</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="nv">$order</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">my</span> <span class="nv">$count</span> <span class="o">=</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_KSWAPD_WAKE_PERORDER</span><span class="p">}[</span><span class="nv">$order</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="nv">$count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">print</span> <span class="s">&quot;wake-$order=$count &quot;</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_KSWAPD_REWAKEUP</span><span class="p">})</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;      &quot;</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$order</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="nv">$order</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">my</span> <span class="nv">$count</span> <span class="o">=</span> <span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_KSWAPD_REWAKEUP_PERORDER</span><span class="p">}[</span><span class="nv">$order</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="nv">$count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">print</span> <span class="s">&quot;rewake-$order=$count &quot;</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;\n&quot;</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>Print out summaries</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">$total_direct_latency</span> <span class="o">/=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="nv">$total_kswapd_latency</span> <span class="o">/=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">print</span> <span class="s">&quot;\nSummary\n&quot;</span><span class="p">;</span>
	<span class="k">print</span> <span class="s">&quot;Direct reclaims:     			$total_direct_reclaim\n&quot;</span><span class="p">;</span>
	<span class="k">print</span> <span class="s">&quot;Direct reclaim pages scanned:		$total_direct_nr_scanned\n&quot;</span><span class="p">;</span>
	<span class="k">print</span> <span class="s">&quot;Direct reclaim pages reclaimed:		$total_direct_nr_reclaimed\n&quot;</span><span class="p">;</span>
	<span class="k">print</span> <span class="s">&quot;Direct reclaim write file sync I/O:	$total_direct_writepage_file_sync\n&quot;</span><span class="p">;</span>
	<span class="k">print</span> <span class="s">&quot;Direct reclaim write anon sync I/O:	$total_direct_writepage_anon_sync\n&quot;</span><span class="p">;</span>
	<span class="k">print</span> <span class="s">&quot;Direct reclaim write file async I/O:	$total_direct_writepage_file_async\n&quot;</span><span class="p">;</span>
	<span class="k">print</span> <span class="s">&quot;Direct reclaim write anon async I/O:	$total_direct_writepage_anon_async\n&quot;</span><span class="p">;</span>
	<span class="k">print</span> <span class="s">&quot;Wake kswapd requests:			$total_wakeup_kswapd\n&quot;</span><span class="p">;</span>
	<span class="nb">printf</span> <span class="s">&quot;Time stalled direct reclaim: 		%-1.2f seconds\n&quot;</span><span class="p">,</span> <span class="nv">$total_direct_latency</span><span class="p">;</span>
	<span class="k">print</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
	<span class="k">print</span> <span class="s">&quot;Kswapd wakeups:				$total_kswapd_wake\n&quot;</span><span class="p">;</span>
	<span class="k">print</span> <span class="s">&quot;Kswapd pages scanned:			$total_kswapd_nr_scanned\n&quot;</span><span class="p">;</span>
	<span class="k">print</span> <span class="s">&quot;Kswapd pages reclaimed:			$total_kswapd_nr_reclaimed\n&quot;</span><span class="p">;</span>
	<span class="k">print</span> <span class="s">&quot;Kswapd reclaim write file sync I/O:	$total_kswapd_writepage_file_sync\n&quot;</span><span class="p">;</span>
	<span class="k">print</span> <span class="s">&quot;Kswapd reclaim write anon sync I/O:	$total_kswapd_writepage_anon_sync\n&quot;</span><span class="p">;</span>
	<span class="k">print</span> <span class="s">&quot;Kswapd reclaim write file async I/O:	$total_kswapd_writepage_file_async\n&quot;</span><span class="p">;</span>
	<span class="k">print</span> <span class="s">&quot;Kswapd reclaim write anon async I/O:	$total_kswapd_writepage_anon_async\n&quot;</span><span class="p">;</span>
	<span class="nb">printf</span> <span class="s">&quot;Time kswapd awake:			%-1.2f seconds\n&quot;</span><span class="p">,</span> <span class="nv">$total_kswapd_latency</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">aggregate_perprocesspid</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$process_pid</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$process</span><span class="p">;</span>
	<span class="nb">undef</span> <span class="nv">%perprocess</span><span class="p">;</span>

	<span class="k">foreach</span> <span class="nv">$process_pid</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%perprocesspid</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$process</span> <span class="o">=</span> <span class="nv">$process_pid</span><span class="p">;</span>
		<span class="nv">$process</span> <span class="o">=~</span> <span class="sr">s/-([0-9])*$//</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$process</span> <span class="ow">eq</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$process</span> <span class="o">=</span> <span class="s">&quot;NO_PROCESS_NAME&quot;</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_DIRECT_RECLAIM_BEGIN</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_DIRECT_RECLAIM_BEGIN</span><span class="p">};</span>
		<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_KSWAPD_WAKE</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_KSWAPD_WAKE</span><span class="p">};</span>
		<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WAKEUP_KSWAPD</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WAKEUP_KSWAPD</span><span class="p">};</span>
		<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_KSWAPD_REWAKEUP</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_KSWAPD_REWAKEUP</span><span class="p">};</span>
		<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_NR_SCANNED</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_NR_SCANNED</span><span class="p">};</span>
		<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_NR_RECLAIMED</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_NR_RECLAIMED</span><span class="p">};</span>
		<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_FILE_SYNC</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_FILE_SYNC</span><span class="p">};</span>
		<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_ANON_SYNC</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_ANON_SYNC</span><span class="p">};</span>
		<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_FILE_ASYNC</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_FILE_ASYNC</span><span class="p">};</span>
		<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_ANON_ASYNC</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WRITEPAGE_ANON_ASYNC</span><span class="p">};</span>

		<span class="k">for</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$order</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="nv">$order</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_DIRECT_RECLAIM_BEGIN_PERORDER</span><span class="p">}[</span><span class="nv">$order</span><span class="p">]</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_DIRECT_RECLAIM_BEGIN_PERORDER</span><span class="p">}[</span><span class="nv">$order</span><span class="p">];</span>
			<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WAKEUP_KSWAPD_PERORDER</span><span class="p">}[</span><span class="nv">$order</span><span class="p">]</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_WAKEUP_KSWAPD_PERORDER</span><span class="p">}[</span><span class="nv">$order</span><span class="p">];</span>
			<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_KSWAPD_WAKE_PERORDER</span><span class="p">}[</span><span class="nv">$order</span><span class="p">]</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_KSWAPD_WAKE_PERORDER</span><span class="p">}[</span><span class="nv">$order</span><span class="p">];</span>

		<span class="p">}</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>Aggregate direct reclaim latencies</p></td><td class="code"><div class="highlight"><pre>		<span class="k">my</span> <span class="nv">$wr_index</span> <span class="o">=</span> <span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_DIRECT_RECLAIM_END</span><span class="p">};</span>
		<span class="k">my</span> <span class="nv">$rd_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_DIRECT_RECLAIM_LATENCY</span><span class="p">}[</span><span class="nv">$rd_index</span><span class="p">])</span> <span class="p">{</span>
			<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_DIRECT_RECLAIM_LATENCY</span><span class="p">}[</span><span class="nv">$wr_index</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_DIRECT_RECLAIM_LATENCY</span><span class="p">}[</span><span class="nv">$rd_index</span><span class="p">];</span>
			<span class="nv">$rd_index</span><span class="o">++</span><span class="p">;</span>
			<span class="nv">$wr_index</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_DIRECT_RECLAIM_END</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$wr_index</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>Aggregate kswapd latencies</p></td><td class="code"><div class="highlight"><pre>		<span class="k">my</span> <span class="nv">$wr_index</span> <span class="o">=</span> <span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_KSWAPD_SLEEP</span><span class="p">};</span>
		<span class="k">my</span> <span class="nv">$rd_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="nb">defined</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_KSWAPD_LATENCY</span><span class="p">}[</span><span class="nv">$rd_index</span><span class="p">])</span> <span class="p">{</span>
			<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_KSWAPD_LATENCY</span><span class="p">}[</span><span class="nv">$wr_index</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_KSWAPD_LATENCY</span><span class="p">}[</span><span class="nv">$rd_index</span><span class="p">];</span>
			<span class="nv">$rd_index</span><span class="o">++</span><span class="p">;</span>
			<span class="nv">$wr_index</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_VMSCAN_DIRECT_RECLAIM_END</span><span class="p">}</span> <span class="o">=</span> <span class="nv">$wr_index</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">report</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$opt_ignorepid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dump_stats</span><span class="p">(</span><span class="o">\</span><span class="nv">%perprocesspid</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">aggregate_perprocesspid</span><span class="p">();</span>
		<span class="n">dump_stats</span><span class="p">(</span><span class="o">\</span><span class="nv">%perprocess</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>Process events or signals until neither is available</p></td><td class="code"><div class="highlight"><pre><span class="k">sub </span><span class="nf">signal_loop</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$sigint_processed</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="nv">$sigint_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">process_events</span><span class="p">();</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>Handle pending signals if any</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$sigint_pending</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$current_time</span> <span class="o">=</span> <span class="nb">time</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="nv">$sigint_exit</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">print</span> <span class="s">&quot;Received exit signal\n&quot;</span><span class="p">;</span>
				<span class="nv">$sigint_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$sigint_report</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="nv">$current_time</span> <span class="o">&gt;=</span> <span class="nv">$sigint_received</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">report</span><span class="p">();</span>
					<span class="nv">$sigint_report</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="nv">$sigint_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="nv">$sigint_processed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nv">$sigint_pending</span> <span class="o">||</span> <span class="nv">$sigint_processed</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">signal_loop</span><span class="p">();</span>
<span class="n">report</span><span class="p">();</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
