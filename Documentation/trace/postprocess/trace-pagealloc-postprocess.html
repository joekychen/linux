<!DOCTYPE html>
<html><head><title>joekychen/linux » Documentation › trace › postprocess › trace-pagealloc-postprocess.pl

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>trace-pagealloc-postprocess.pl</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="c1">#!/usr/bin/perl</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>This is a POC (proof of concept or piece of crap, take your pick) for reading the
text representation of trace output related to page allocation. It makes an attempt
to extract some high-level information on what is going on. The accuracy of the parser
may vary considerably</p>

<p>Example usage: trace-pagealloc-postprocess.pl &lt; /sys/kernel/debug/tracing/trace_pipe
other options
  --prepend-parent    Report on the parent proc and PID
  --read-procstat    If the trace lacks process info, get it from /proc
  --ignore-pid    Aggregate processes of the same name together</p>

<p>Copyright (c) IBM Corporation 2009
Author: Mel Gorman <a href="&#x6D;&#x61;&#x69;&#108;t&#x6F;:&#109;&#101;&#108;&#x40;&#99;&#x73;n.&#117;&#x6C;&#46;&#x69;&#101;">&#109;&#101;&#108;&#x40;&#99;&#x73;n.&#117;&#x6C;&#46;&#x69;&#101;</a></p></td><td class="code"><div class="highlight"><pre><span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Getopt::</span><span class="n">Long</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Tracepoint events</p></td><td class="code"><div class="highlight"><pre><span class="k">use</span> <span class="n">constant</span> <span class="n">MM_PAGE_ALLOC</span>		<span class="o">=&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">MM_PAGE_FREE</span>		<span class="o">=&gt;</span> <span class="mi">2</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">MM_PAGE_FREE_BATCHED</span>	<span class="o">=&gt;</span> <span class="mi">3</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">MM_PAGE_PCPU_DRAIN</span>		<span class="o">=&gt;</span> <span class="mi">4</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">MM_PAGE_ALLOC_ZONE_LOCKED</span>	<span class="o">=&gt;</span> <span class="mi">5</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">MM_PAGE_ALLOC_EXTFRAG</span>	<span class="o">=&gt;</span> <span class="mi">6</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">EVENT_UNKNOWN</span>		<span class="o">=&gt;</span> <span class="mi">7</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Constants used to track state</p></td><td class="code"><div class="highlight"><pre><span class="k">use</span> <span class="n">constant</span> <span class="n">STATE_PCPU_PAGES_DRAINED</span>	<span class="o">=&gt;</span> <span class="mi">8</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">STATE_PCPU_PAGES_REFILLED</span>	<span class="o">=&gt;</span> <span class="mi">9</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>High-level events extrapolated from tracepoints</p></td><td class="code"><div class="highlight"><pre><span class="k">use</span> <span class="n">constant</span> <span class="n">HIGH_PCPU_DRAINS</span>		<span class="o">=&gt;</span> <span class="mi">10</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">HIGH_PCPU_REFILLS</span>		<span class="o">=&gt;</span> <span class="mi">11</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">HIGH_EXT_FRAGMENT</span>		<span class="o">=&gt;</span> <span class="mi">12</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">HIGH_EXT_FRAGMENT_SEVERE</span>	<span class="o">=&gt;</span> <span class="mi">13</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">HIGH_EXT_FRAGMENT_MODERATE</span>	<span class="o">=&gt;</span> <span class="mi">14</span><span class="p">;</span>
<span class="k">use</span> <span class="n">constant</span> <span class="n">HIGH_EXT_FRAGMENT_CHANGED</span>	<span class="o">=&gt;</span> <span class="mi">15</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">%perprocesspid</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">%perprocess</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$opt_ignorepid</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$opt_read_procstat</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$opt_prepend_parent</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Catch sigint and exit on request</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">$sigint_report</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$sigint_exit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$sigint_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$sigint_received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">sub </span><span class="nf">sigint_handler</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$current_time</span> <span class="o">=</span> <span class="nb">time</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$current_time</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="nv">$sigint_received</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">print</span> <span class="s">&quot;SIGINT received, report pending. Hit ctrl-c again to exit\n&quot;</span><span class="p">;</span>
		<span class="nv">$sigint_report</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$sigint_exit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span> <span class="s">&quot;Second SIGINT received quickly, exiting\n&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nv">$sigint_exit</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$sigint_exit</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">print</span> <span class="s">&quot;Many SIGINTs received, exiting now without report\n&quot;</span><span class="p">;</span>
		<span class="nb">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nv">$sigint_received</span> <span class="o">=</span> <span class="nv">$current_time</span><span class="p">;</span>
	<span class="nv">$sigint_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="nv">$SIG</span><span class="p">{</span><span class="n">INT</span><span class="p">}</span> <span class="o">=</span> <span class="s">&quot;sigint_handler&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Parse command line options</p></td><td class="code"><div class="highlight"><pre><span class="n">GetOptions</span><span class="p">(</span>
	<span class="s">&#39;ignore-pid&#39;</span>	 <span class="o">=&gt;</span>	<span class="o">\</span><span class="nv">$opt_ignorepid</span><span class="p">,</span>
	<span class="s">&#39;read-procstat&#39;</span>	 <span class="o">=&gt;</span>	<span class="o">\</span><span class="nv">$opt_read_procstat</span><span class="p">,</span>
	<span class="s">&#39;prepend-parent&#39;</span> <span class="o">=&gt;</span>	<span class="o">\</span><span class="nv">$opt_prepend_parent</span><span class="p">,</span>
<span class="p">);</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Defaults for dynamically discovered regex's</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">$regex_fragdetails_default</span> <span class="o">=</span> <span class="s">&#39;page=([0-9a-f]*) pfn=([0-9]*) alloc_order=([-0-9]*) fallback_order=([-0-9]*) pageblock_order=([-0-9]*) alloc_migratetype=([-0-9]*) fallback_migratetype=([-0-9]*) fragmenting=([-0-9]) change_ownership=([-0-9])&#39;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Dyanically discovered regex</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">$regex_fragdetails</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Static regex used. Specified like this for readability and for use with /o
                     (process_pid)     (cpus      )   ( time  )   (tpoint    ) (details)</p></td><td class="code"><div class="highlight"><pre><span class="k">my</span> <span class="nv">$regex_traceevent</span> <span class="o">=</span> <span class="s">&#39;\s*([a-zA-Z0-9-]*)\s*(\[[0-9]*\])\s*([0-9.]*):\s*([a-zA-Z_]*):\s*(.*)&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$regex_statname</span> <span class="o">=</span> <span class="s">&#39;[-0-9]*\s\((.*)\).*&#39;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$regex_statppid</span> <span class="o">=</span> <span class="s">&#39;[-0-9]*\s\(.*\)\s[A-Za-z]\s([0-9]*).*&#39;</span><span class="p">;</span>

<span class="k">sub </span><span class="nf">generate_traceevent_regex</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$event</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$default</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$regex</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Read the event format or use the default</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">open</span> <span class="p">(</span><span class="n">FORMAT</span><span class="p">,</span> <span class="s">&quot;/sys/kernel/debug/tracing/events/$event/format&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="nv">$regex</span> <span class="o">=</span> <span class="nv">$default</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">my</span> <span class="nv">$line</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nb">eof</span><span class="p">(</span><span class="n">FORMAT</span><span class="p">))</span> <span class="p">{</span>
			<span class="nv">$line</span> <span class="o">=</span> <span class="sr">&lt;FORMAT&gt;</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^print fmt:\s&quot;(.*)&quot;,.*/</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$regex</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
				<span class="nv">$regex</span> <span class="o">=~</span> <span class="sr">s/%p/\([0-9a-f]*\)/g</span><span class="p">;</span>
				<span class="nv">$regex</span> <span class="o">=~</span> <span class="sr">s/%d/\([-0-9]*\)/g</span><span class="p">;</span>
				<span class="nv">$regex</span> <span class="o">=~</span> <span class="sr">s/%lu/\([0-9]*\)/g</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Verify fields are in the right order</p></td><td class="code"><div class="highlight"><pre>	<span class="k">my</span> <span class="nv">$tuple</span><span class="p">;</span>
	<span class="k">foreach</span> <span class="nv">$tuple</span> <span class="p">(</span><span class="nb">split</span> <span class="sr">/\s/</span><span class="p">,</span> <span class="nv">$regex</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">my</span> <span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="sr">/=/</span><span class="p">,</span> <span class="nv">$tuple</span><span class="p">);</span>
		<span class="k">my</span> <span class="nv">$expected</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$key</span> <span class="ow">ne</span> <span class="nv">$expected</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">print</span><span class="p">(</span><span class="s">&quot;WARNING: Format not as expected &#39;$key&#39; != &#39;$expected&#39;&quot;</span><span class="p">);</span>
			<span class="nv">$regex</span> <span class="o">=~</span> <span class="sr">s/$key=\((.*)\)/$key=$1/</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">defined</span> <span class="nb">shift</span><span class="p">)</span> <span class="p">{</span>
		<span class="nb">die</span><span class="p">(</span><span class="s">&quot;Fewer fields than expected in format&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nv">$regex</span><span class="p">;</span>
<span class="p">}</span>
<span class="nv">$regex_fragdetails</span> <span class="o">=</span> <span class="n">generate_traceevent_regex</span><span class="p">(</span><span class="s">&quot;kmem/mm_page_alloc_extfrag&quot;</span><span class="p">,</span>
			<span class="nv">$regex_fragdetails_default</span><span class="p">,</span>
			<span class="s">&quot;page&quot;</span><span class="p">,</span> <span class="s">&quot;pfn&quot;</span><span class="p">,</span>
			<span class="s">&quot;alloc_order&quot;</span><span class="p">,</span> <span class="s">&quot;fallback_order&quot;</span><span class="p">,</span> <span class="s">&quot;pageblock_order&quot;</span><span class="p">,</span>
			<span class="s">&quot;alloc_migratetype&quot;</span><span class="p">,</span> <span class="s">&quot;fallback_migratetype&quot;</span><span class="p">,</span>
			<span class="s">&quot;fragmenting&quot;</span><span class="p">,</span> <span class="s">&quot;change_ownership&quot;</span><span class="p">);</span>

<span class="k">sub </span><span class="nf">read_statline</span><span class="p">($)</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$pid</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">my</span> <span class="nv">$statline</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">STAT</span><span class="p">,</span> <span class="s">&quot;/proc/$pid/stat&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="nv">$statline</span> <span class="o">=</span> <span class="sr">&lt;STAT&gt;</span><span class="p">;</span>
		<span class="nb">close</span><span class="p">(</span><span class="n">STAT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$statline</span> <span class="ow">eq</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$statline</span> <span class="o">=</span> <span class="s">&quot;-1 (UNKNOWN_PROCESS_NAME) R 0&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nv">$statline</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">guess_process_pid</span><span class="p">($$)</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$pid</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">my</span> <span class="nv">$statline</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="s">&quot;swapper-0&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$statline</span> <span class="o">!~</span> <span class="sr">/$regex_statname/o</span><span class="p">)</span> <span class="p">{</span>
		<span class="nb">die</span><span class="p">(</span><span class="s">&quot;Failed to math stat line for process name :: $statline&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="s">&quot;$1-$pid&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">parent_info</span><span class="p">($$)</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$pid</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">my</span> <span class="nv">$statline</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">my</span> <span class="nv">$ppid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="s">&quot;NOPARENT-0&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">$statline</span> <span class="o">!~</span> <span class="sr">/$regex_statppid/o</span><span class="p">)</span> <span class="p">{</span>
		<span class="nb">die</span><span class="p">(</span><span class="s">&quot;Failed to match stat line process ppid:: $statline&quot;</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Read the ppid stat line</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">$ppid</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">guess_process_pid</span><span class="p">(</span><span class="nv">$ppid</span><span class="p">,</span> <span class="n">read_statline</span><span class="p">(</span><span class="nv">$ppid</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">process_events</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$traceevent</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$process_pid</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$cpus</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$timestamp</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$tracepoint</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$details</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$statline</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Read each line of the event log</p></td><td class="code"><div class="highlight"><pre><span class="n">EVENT_PROCESS:</span>
	<span class="k">while</span> <span class="p">(</span><span class="nv">$traceevent</span> <span class="o">=</span> <span class="sr">&lt;STDIN&gt;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$traceevent</span> <span class="o">=~</span><span class="sr"> /$regex_traceevent/o</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$process_pid</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
			<span class="nv">$tracepoint</span> <span class="o">=</span> <span class="nv">$4</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="nv">$opt_read_procstat</span> <span class="o">||</span> <span class="nv">$opt_prepend_parent</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$process_pid</span> <span class="o">=~</span><span class="sr"> /(.*)-([0-9]*)$/</span><span class="p">;</span>
				<span class="k">my</span> <span class="nv">$process</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
				<span class="k">my</span> <span class="nv">$pid</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>

				<span class="nv">$statline</span> <span class="o">=</span> <span class="n">read_statline</span><span class="p">(</span><span class="nv">$pid</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="nv">$opt_read_procstat</span> <span class="o">&amp;&amp;</span> <span class="nv">$process</span> <span class="ow">eq</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="nv">$process_pid</span> <span class="o">=</span> <span class="n">guess_process_pid</span><span class="p">(</span><span class="nv">$pid</span><span class="p">,</span> <span class="nv">$statline</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="nv">$opt_prepend_parent</span><span class="p">)</span> <span class="p">{</span>
					<span class="nv">$process_pid</span> <span class="o">=</span> <span class="n">parent_info</span><span class="p">(</span><span class="nv">$pid</span><span class="p">,</span> <span class="nv">$statline</span><span class="p">)</span> <span class="o">.</span> <span class="s">&quot; :: $process_pid&quot;</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>Unnecessary in this script. Uncomment if required
$cpus = $2;
$timestamp = $3;</p></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">next</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Perl Switch() sucks majorly</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$tracepoint</span> <span class="ow">eq</span> <span class="s">&quot;mm_page_alloc&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_PAGE_ALLOC</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$tracepoint</span> <span class="ow">eq</span> <span class="s">&quot;mm_page_free&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_PAGE_FREE</span><span class="p">}</span><span class="o">++</span>
		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$tracepoint</span> <span class="ow">eq</span> <span class="s">&quot;mm_page_free_batched&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_PAGE_FREE_BATCHED</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$tracepoint</span> <span class="ow">eq</span> <span class="s">&quot;mm_page_pcpu_drain&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_PAGE_PCPU_DRAIN</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">STATE_PCPU_PAGES_DRAINED</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$tracepoint</span> <span class="ow">eq</span> <span class="s">&quot;mm_page_alloc_zone_locked&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_PAGE_ALLOC_ZONE_LOCKED</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">STATE_PCPU_PAGES_REFILLED</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$tracepoint</span> <span class="ow">eq</span> <span class="s">&quot;mm_page_alloc_extfrag&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Extract the details of the event now</p></td><td class="code"><div class="highlight"><pre>			<span class="nv">$details</span> <span class="o">=</span> <span class="nv">$5</span><span class="p">;</span>

			<span class="k">my</span> <span class="p">(</span><span class="nv">$page</span><span class="p">,</span> <span class="nv">$pfn</span><span class="p">);</span>
			<span class="k">my</span> <span class="p">(</span><span class="nv">$alloc_order</span><span class="p">,</span> <span class="nv">$fallback_order</span><span class="p">,</span> <span class="nv">$pageblock_order</span><span class="p">);</span>
			<span class="k">my</span> <span class="p">(</span><span class="nv">$alloc_migratetype</span><span class="p">,</span> <span class="nv">$fallback_migratetype</span><span class="p">);</span>
			<span class="k">my</span> <span class="p">(</span><span class="nv">$fragmenting</span><span class="p">,</span> <span class="nv">$change_ownership</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="nv">$details</span> <span class="o">!~</span> <span class="sr">/$regex_fragdetails/o</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">print</span> <span class="s">&quot;WARNING: Failed to parse mm_page_alloc_extfrag as expected\n&quot;</span><span class="p">;</span>
				<span class="k">next</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_PAGE_ALLOC_EXTFRAG</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
			<span class="nv">$page</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
			<span class="nv">$pfn</span> <span class="o">=</span> <span class="nv">$2</span><span class="p">;</span>
			<span class="nv">$alloc_order</span> <span class="o">=</span> <span class="nv">$3</span><span class="p">;</span>
			<span class="nv">$fallback_order</span> <span class="o">=</span> <span class="nv">$4</span><span class="p">;</span>
			<span class="nv">$pageblock_order</span> <span class="o">=</span> <span class="nv">$5</span><span class="p">;</span>
			<span class="nv">$alloc_migratetype</span> <span class="o">=</span> <span class="nv">$6</span><span class="p">;</span>
			<span class="nv">$fallback_migratetype</span> <span class="o">=</span> <span class="nv">$7</span><span class="p">;</span>
			<span class="nv">$fragmenting</span> <span class="o">=</span> <span class="nv">$8</span><span class="p">;</span>
			<span class="nv">$change_ownership</span> <span class="o">=</span> <span class="nv">$9</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="nv">$fragmenting</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_EXT_FRAG</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="nv">$fallback_order</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
					<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_EXT_FRAGMENT_SEVERE</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_EXT_FRAGMENT_MODERATE</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$change_ownership</span><span class="p">)</span> <span class="p">{</span>
				<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_EXT_FRAGMENT_CHANGED</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">EVENT_UNKNOWN</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Catch a full pcpu drain event</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">STATE_PCPU_PAGES_DRAINED</span><span class="p">}</span> <span class="o">&amp;&amp;</span>
				<span class="nv">$tracepoint</span> <span class="ow">ne</span> <span class="s">&quot;mm_page_pcpu_drain&quot;</span><span class="p">)</span> <span class="p">{</span>

			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_PCPU_DRAINS</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">STATE_PCPU_PAGES_DRAINED</span><span class="p">}</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>Catch a full pcpu refill event</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">STATE_PCPU_PAGES_REFILLED</span><span class="p">}</span> <span class="o">&amp;&amp;</span>
				<span class="nv">$tracepoint</span> <span class="ow">ne</span> <span class="s">&quot;mm_page_alloc_zone_locked&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_PCPU_REFILLS</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
			<span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">STATE_PCPU_PAGES_REFILLED</span><span class="p">}</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="nv">$sigint_pending</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">last</span> <span class="n">EVENT_PROCESS</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">dump_stats</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$hashref</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">%stats</span> <span class="o">=</span> <span class="nv">%$hashref</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>Dump per-process stats</p></td><td class="code"><div class="highlight"><pre>	<span class="k">my</span> <span class="nv">$process_pid</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$max_strlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>Get the maximum process name</p></td><td class="code"><div class="highlight"><pre>	<span class="k">foreach</span> <span class="nv">$process_pid</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%perprocesspid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">my</span> <span class="nv">$len</span> <span class="o">=</span> <span class="nb">length</span><span class="p">(</span><span class="nv">$process_pid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$len</span> <span class="o">&gt;</span> <span class="nv">$max_strlen</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$max_strlen</span> <span class="o">=</span> <span class="nv">$len</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nv">$max_strlen</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;\n&quot;</span><span class="p">);</span>
	<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;%-&quot;</span> <span class="o">.</span> <span class="nv">$max_strlen</span> <span class="o">.</span> <span class="s">&quot;s %8s %10s   %8s %8s   %8s %8s %8s   %8s %8s %8s %8s %8s %8s\n&quot;</span><span class="p">,</span>
		<span class="s">&quot;Process&quot;</span><span class="p">,</span> <span class="s">&quot;Pages&quot;</span><span class="p">,</span>  <span class="s">&quot;Pages&quot;</span><span class="p">,</span>      <span class="s">&quot;Pages&quot;</span><span class="p">,</span> <span class="s">&quot;Pages&quot;</span><span class="p">,</span> <span class="s">&quot;PCPU&quot;</span><span class="p">,</span>  <span class="s">&quot;PCPU&quot;</span><span class="p">,</span>   <span class="s">&quot;PCPU&quot;</span><span class="p">,</span>    <span class="s">&quot;Fragment&quot;</span><span class="p">,</span>  <span class="s">&quot;Fragment&quot;</span><span class="p">,</span> <span class="s">&quot;MigType&quot;</span><span class="p">,</span> <span class="s">&quot;Fragment&quot;</span><span class="p">,</span> <span class="s">&quot;Fragment&quot;</span><span class="p">,</span> <span class="s">&quot;Unknown&quot;</span><span class="p">);</span>
	<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;%-&quot;</span> <span class="o">.</span> <span class="nv">$max_strlen</span> <span class="o">.</span> <span class="s">&quot;s %8s %10s   %8s %8s   %8s %8s %8s   %8s %8s %8s %8s %8s %8s\n&quot;</span><span class="p">,</span>
		<span class="s">&quot;details&quot;</span><span class="p">,</span> <span class="s">&quot;allocd&quot;</span><span class="p">,</span> <span class="s">&quot;allocd&quot;</span><span class="p">,</span>     <span class="s">&quot;freed&quot;</span><span class="p">,</span> <span class="s">&quot;freed&quot;</span><span class="p">,</span> <span class="s">&quot;pages&quot;</span><span class="p">,</span> <span class="s">&quot;drains&quot;</span><span class="p">,</span> <span class="s">&quot;refills&quot;</span><span class="p">,</span> <span class="s">&quot;Fallback&quot;</span><span class="p">,</span> <span class="s">&quot;Causing&quot;</span><span class="p">,</span>   <span class="s">&quot;Changed&quot;</span><span class="p">,</span> <span class="s">&quot;Severe&quot;</span><span class="p">,</span> <span class="s">&quot;Moderate&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;%-&quot;</span> <span class="o">.</span> <span class="nv">$max_strlen</span> <span class="o">.</span> <span class="s">&quot;s %8s %10s   %8s %8s   %8s %8s %8s   %8s %8s %8s %8s %8s %8s\n&quot;</span><span class="p">,</span>
		<span class="s">&quot;&quot;</span><span class="p">,</span>        <span class="s">&quot;&quot;</span><span class="p">,</span>       <span class="s">&quot;under lock&quot;</span><span class="p">,</span> <span class="s">&quot;direct&quot;</span><span class="p">,</span> <span class="s">&quot;pagevec&quot;</span><span class="p">,</span> <span class="s">&quot;drain&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">foreach</span> <span class="nv">$process_pid</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%stats</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>Dump final aggregates</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">STATE_PCPU_PAGES_DRAINED</span><span class="p">})</span> <span class="p">{</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_PCPU_DRAINS</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">STATE_PCPU_PAGES_DRAINED</span><span class="p">}</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">STATE_PCPU_PAGES_REFILLED</span><span class="p">})</span> <span class="p">{</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_PCPU_REFILLS</span><span class="p">}</span><span class="o">++</span><span class="p">;</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">STATE_PCPU_PAGES_REFILLED</span><span class="p">}</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="nb">printf</span><span class="p">(</span><span class="s">&quot;%-&quot;</span> <span class="o">.</span> <span class="nv">$max_strlen</span> <span class="o">.</span> <span class="s">&quot;s %8d %10d   %8d %8d   %8d %8d %8d   %8d %8d %8d %8d %8d %8d\n&quot;</span><span class="p">,</span>
			<span class="nv">$process_pid</span><span class="p">,</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_PAGE_ALLOC</span><span class="p">},</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_PAGE_ALLOC_ZONE_LOCKED</span><span class="p">},</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_PAGE_FREE</span><span class="p">},</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_PAGE_FREE_BATCHED</span><span class="p">},</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_PAGE_PCPU_DRAIN</span><span class="p">},</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_PCPU_DRAINS</span><span class="p">},</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_PCPU_REFILLS</span><span class="p">},</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_PAGE_ALLOC_EXTFRAG</span><span class="p">},</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_EXT_FRAG</span><span class="p">},</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_EXT_FRAGMENT_CHANGED</span><span class="p">},</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_EXT_FRAGMENT_SEVERE</span><span class="p">},</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_EXT_FRAGMENT_MODERATE</span><span class="p">},</span>
			<span class="nv">$stats</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">EVENT_UNKNOWN</span><span class="p">});</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">aggregate_perprocesspid</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$process_pid</span><span class="p">;</span>
	<span class="k">my</span> <span class="nv">$process</span><span class="p">;</span>
	<span class="nb">undef</span> <span class="nv">%perprocess</span><span class="p">;</span>

	<span class="k">foreach</span> <span class="nv">$process_pid</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%perprocesspid</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$process</span> <span class="o">=</span> <span class="nv">$process_pid</span><span class="p">;</span>
		<span class="nv">$process</span> <span class="o">=~</span> <span class="sr">s/-([0-9])*$//</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$process</span> <span class="ow">eq</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nv">$process</span> <span class="o">=</span> <span class="s">&quot;NO_PROCESS_NAME&quot;</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_PAGE_ALLOC</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_PAGE_ALLOC</span><span class="p">};</span>
		<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_PAGE_ALLOC_ZONE_LOCKED</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_PAGE_ALLOC_ZONE_LOCKED</span><span class="p">};</span>
		<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_PAGE_FREE</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_PAGE_FREE</span><span class="p">};</span>
		<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_PAGE_FREE_BATCHED</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_PAGE_FREE_BATCHED</span><span class="p">};</span>
		<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_PAGE_PCPU_DRAIN</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_PAGE_PCPU_DRAIN</span><span class="p">};</span>
		<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_PCPU_DRAINS</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_PCPU_DRAINS</span><span class="p">};</span>
		<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_PCPU_REFILLS</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_PCPU_REFILLS</span><span class="p">};</span>
		<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_PAGE_ALLOC_EXTFRAG</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">MM_PAGE_ALLOC_EXTFRAG</span><span class="p">};</span>
		<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_EXT_FRAG</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_EXT_FRAG</span><span class="p">};</span>
		<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_EXT_FRAGMENT_CHANGED</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_EXT_FRAGMENT_CHANGED</span><span class="p">};</span>
		<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_EXT_FRAGMENT_SEVERE</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_EXT_FRAGMENT_SEVERE</span><span class="p">};</span>
		<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_EXT_FRAGMENT_MODERATE</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">HIGH_EXT_FRAGMENT_MODERATE</span><span class="p">};</span>
		<span class="nv">$perprocess</span><span class="p">{</span><span class="nv">$process</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">EVENT_UNKNOWN</span><span class="p">}</span> <span class="o">+=</span> <span class="nv">$perprocesspid</span><span class="p">{</span><span class="nv">$process_pid</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">EVENT_UNKNOWN</span><span class="p">};</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">report</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$opt_ignorepid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dump_stats</span><span class="p">(</span><span class="o">\</span><span class="nv">%perprocesspid</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">aggregate_perprocesspid</span><span class="p">();</span>
		<span class="n">dump_stats</span><span class="p">(</span><span class="o">\</span><span class="nv">%perprocess</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>Process events or signals until neither is available</p></td><td class="code"><div class="highlight"><pre><span class="k">sub </span><span class="nf">signal_loop</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">my</span> <span class="nv">$sigint_processed</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="nv">$sigint_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">process_events</span><span class="p">();</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>Handle pending signals if any</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="nv">$sigint_pending</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">my</span> <span class="nv">$current_time</span> <span class="o">=</span> <span class="nb">time</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="nv">$sigint_exit</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">print</span> <span class="s">&quot;Received exit signal\n&quot;</span><span class="p">;</span>
				<span class="nv">$sigint_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$sigint_report</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="nv">$current_time</span> <span class="o">&gt;=</span> <span class="nv">$sigint_received</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">report</span><span class="p">();</span>
					<span class="nv">$sigint_report</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="nv">$sigint_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="nv">$sigint_processed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nv">$sigint_pending</span> <span class="o">||</span> <span class="nv">$sigint_processed</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">signal_loop</span><span class="p">();</span>
<span class="n">report</span><span class="p">();</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
